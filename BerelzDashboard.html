<!DOCTYPE html>
<html lang="nl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>BerelzDashboard Pro</title>
    <script>
        // Auto-redirect to localhost if opened as file://
        if (window.location.protocol === 'file:') {
            window.location.href = 'http://localhost:8080';
        }
    </script>
    <script src="https://www.gstatic.com/charts/loader.js"></script>
    <script>google.charts.load('current', {packages: ['corechart']});</script>
    <style>
        :root {
            /* Professional Dark Theme - Clean & Minimal */
            --esa-dark: #1a1f2e;
            --esa-blue: #2a3142;
            --esa-accent: #5b7aa1;
            --esa-light: #8fa4c4;
            --grey-dark: #141821;
            --grey-mid: #1e2433;
            --grey-light: #2a3142;
            --grey-text: #6b7280;
            --grey-border: #2d3548;
            --white: #f8fafc;
            --text-primary: #e2e8f0;
            --text-secondary: #94a3b8;
            --success: #c0c8d4;
            --danger: #7c8594;
            --warning: #a0a8b4;
            --purple: #a78bfa;
            --cyan: #67b8d4;
        }
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body {
            font-family: 'Segoe UI', -apple-system, BlinkMacSystemFont, sans-serif;
            background: var(--grey-dark);
            color: var(--text-primary);
            overflow-x: hidden;
            min-height: 100vh;
        }
        .sidebar {
            position: fixed;
            left: 0; top: 0;
            width: 200px;
            height: 100vh;
            background: var(--esa-dark);
            border-right: 1px solid var(--grey-border);
            z-index: 1000;
            display: flex;
            flex-direction: column;
            overflow-y: auto;
        }
        .logo-section {
            padding: 15px;
            border-bottom: 1px solid rgba(255,255,255,0.1);
            text-align: center;
        }
        .logo-img {
            width: 60px; height: 60px;
            border-radius: 50%;
            object-fit: cover;
            border: 2px solid var(--esa-accent);
            margin-bottom: 8px;
        }
        .logo-text { font-size: 16px; font-weight: 700; color: var(--white); }
        .logo-sub { font-size: 9px; color: var(--esa-light); text-transform: uppercase; letter-spacing: 1px; }
        .nav-menu { list-style: none; padding: 8px 0; flex: 1; }
        .nav-item {
            padding: 10px 15px;
            cursor: pointer;
            display: flex;
            align-items: center;
            gap: 8px;
            color: var(--text-secondary);
            transition: all 0.2s;
            border-left: 3px solid transparent;
            font-size: 12px;
        }
        .nav-item:hover, .nav-item.active {
            background: rgba(0, 102, 204, 0.15);
            color: var(--white);
            border-left-color: var(--esa-accent);
        }
        .nav-icon { font-size: 14px; }
        .nav-footer {
            padding: 10px;
            border-top: 1px solid rgba(255,255,255,0.1);
            font-size: 9px;
            color: var(--grey-text);
            text-align: center;
        }
        .main { margin-left: 200px; min-height: 100vh; }
        .header {
            background: var(--grey-mid);
            border-bottom: 1px solid var(--grey-border);
            padding: 10px 20px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            position: sticky;
            top: 0;
            z-index: 100;
        }
        .header-title { font-size: 14px; font-weight: 600; color: var(--white); }
        .header-price {
            display: flex;
            align-items: center;
            gap: 15px;
        }
        .live-price {
            font-size: 20px;
            font-weight: 700;
            color: var(--success);
        }
        .price-change { font-size: 11px; }
        .price-change.up { color: var(--success); }
        .price-change.down { color: var(--danger); }
        .header-status { display: flex; align-items: center; gap: 6px; font-size: 11px; color: var(--text-secondary); }
        .status-dot {
            width: 6px; height: 6px;
            background: var(--success);
            border-radius: 50%;
            animation: pulse 2s infinite;
        }
        @keyframes pulse { 0%, 100% { opacity: 1; } 50% { opacity: 0.4; } }
        .content { padding: 15px 20px; }
        .section { display: none; }
        .section.active { display: block; animation: fadeIn 0.3s ease; }
        @keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }

        /* Signal Banner Compact */
        .signal-row {
            display: grid;
            grid-template-columns: 200px 1fr 200px;
            gap: 15px;
            margin-bottom: 15px;
        }
        .signal-box {
            background: var(--grey-mid);
            border: 1px solid var(--grey-border);
            border-radius: 6px;
            padding: 15px;
            text-align: center;
        }
        .signal-box.buy { border-color: var(--success); background: rgba(0,200,83,0.08); }
        .signal-box.sell { border-color: var(--danger); background: rgba(255,61,0,0.08); }
        .signal-box.hold { border-color: var(--warning); background: rgba(255,171,0,0.08); }
        .signal-label { font-size: 10px; color: var(--text-secondary); text-transform: uppercase; margin-bottom: 5px; }
        .signal-value { font-size: 28px; font-weight: 800; }
        .signal-box.buy .signal-value { color: var(--success); }
        .signal-box.sell .signal-value { color: var(--danger); }
        .signal-box.hold .signal-value { color: var(--warning); }
        .signal-sub { font-size: 11px; color: var(--text-secondary); margin-top: 3px; }

        /* Prognosis Panel */
        .prognosis-panel {
            background: var(--grey-mid);
            border: 1px solid var(--grey-border);
            border-radius: 6px;
            padding: 15px;
        }
        .prognosis-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 12px;
        }
        .prognosis-title { font-size: 11px; color: var(--esa-light); text-transform: uppercase; letter-spacing: 1px; }
        .prognosis-grid {
            display: grid;
            grid-template-columns: repeat(4, 1fr);
            gap: 10px;
        }
        .prognosis-item {
            background: var(--grey-dark);
            padding: 10px;
            border-radius: 4px;
            text-align: center;
        }
        .prognosis-label { font-size: 9px; color: var(--text-secondary); text-transform: uppercase; }
        .prognosis-value { font-size: 16px; font-weight: 700; margin-top: 3px; }
        .prognosis-value.up { color: var(--success); }
        .prognosis-value.down { color: var(--danger); }
        .prognosis-pct { font-size: 10px; color: var(--text-secondary); }

        /* Cards */
        .cards-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(240px, 1fr));
            gap: 12px;
            margin-bottom: 15px;
        }
        .card {
            background: var(--grey-mid);
            border: 1px solid var(--grey-border);
            border-radius: 6px;
            padding: 12px;
        }
        .card-header {
            font-size: 10px;
            text-transform: uppercase;
            letter-spacing: 1px;
            color: var(--esa-light);
            margin-bottom: 10px;
            padding-bottom: 8px;
            border-bottom: 1px solid var(--grey-border);
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        .data-row {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 6px 0;
            border-bottom: 1px solid rgba(255,255,255,0.03);
        }
        .data-row:last-child { border-bottom: none; }
        .data-label { color: var(--text-secondary); font-size: 11px; }
        .data-value { font-weight: 600; font-size: 12px; }
        .data-value.positive { color: var(--success); }
        .data-value.negative { color: var(--danger); }
        .data-value.neutral { color: var(--warning); }
        .data-value.purple { color: var(--purple); }
        .data-value.cyan { color: var(--cyan); }
        .badge {
            display: inline-block;
            padding: 2px 6px;
            border-radius: 3px;
            font-size: 9px;
            font-weight: 700;
        }
        .badge.buy { background: rgba(0, 200, 83, 0.2); color: var(--success); }
        .badge.sell { background: rgba(255, 61, 0, 0.2); color: var(--danger); }
        .badge.neutral { background: rgba(255, 171, 0, 0.2); color: var(--warning); }
        .badge.info { background: rgba(0, 102, 204, 0.2); color: var(--esa-light); }

        /* Chart */
        .chart-container {
            background: var(--grey-mid);
            border: 1px solid var(--grey-border);
            border-radius: 6px;
            padding: 12px;
            margin-bottom: 15px;
        }
        .chart-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 10px;
        }
        .chart-title { font-size: 10px; text-transform: uppercase; letter-spacing: 1px; color: var(--esa-light); }
        .chart-legend { display: flex; gap: 12px; font-size: 9px; }
        .legend-item { display: flex; align-items: center; gap: 4px; color: var(--text-secondary); }
        .legend-dot { width: 8px; height: 8px; border-radius: 2px; }
        #priceChart { width: 100%; height: 220px; background: var(--grey-dark); border-radius: 4px; }

        /* Risk Metrics */
        .risk-grid {
            display: grid;
            grid-template-columns: repeat(5, 1fr);
            gap: 10px;
            margin-bottom: 15px;
        }
        .risk-item {
            background: var(--grey-mid);
            border: 1px solid var(--grey-border);
            border-radius: 6px;
            padding: 12px;
            text-align: center;
        }
        .risk-label { font-size: 9px; color: var(--text-secondary); text-transform: uppercase; }
        .risk-value { font-size: 18px; font-weight: 700; margin-top: 5px; }
        .risk-desc { font-size: 9px; color: var(--grey-text); margin-top: 3px; }

        /* Fibonacci */
        .fib-levels {
            display: flex;
            flex-direction: column;
            gap: 6px;
        }
        .fib-row {
            display: flex;
            align-items: center;
            gap: 10px;
        }
        .fib-label {
            width: 50px;
            font-size: 10px;
            color: var(--text-secondary);
        }
        .fib-bar {
            flex: 1;
            height: 20px;
            background: var(--grey-dark);
            border-radius: 3px;
            position: relative;
            overflow: hidden;
        }
        .fib-fill {
            height: 100%;
            border-radius: 3px;
        }
        .fib-price {
            position: absolute;
            right: 8px;
            top: 50%;
            transform: translateY(-50%);
            font-size: 10px;
            font-weight: 600;
            color: var(--white);
        }
        .fib-current {
            position: absolute;
            width: 2px;
            height: 100%;
            background: var(--white);
            z-index: 10;
        }

        /* Calendar */
        .calendar-item {
            background: var(--grey-dark);
            border-radius: 4px;
            padding: 10px;
            margin-bottom: 8px;
            display: flex;
            align-items: center;
            gap: 12px;
        }
        .calendar-time {
            font-size: 11px;
            color: var(--text-secondary);
            min-width: 50px;
        }
        .calendar-impact {
            width: 8px;
            height: 8px;
            border-radius: 50%;
        }
        .calendar-impact.high { background: var(--danger); }
        .calendar-impact.medium { background: var(--warning); }
        .calendar-impact.low { background: var(--success); }
        .calendar-event { flex: 1; font-size: 11px; }
        .calendar-forecast { font-size: 10px; color: var(--text-secondary); }

        /* Position Calculator */
        .calc-grid {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 15px;
        }
        .calc-input {
            background: var(--grey-dark);
            border: 1px solid var(--grey-border);
            border-radius: 4px;
            padding: 8px 10px;
            color: var(--text-primary);
            font-size: 12px;
            width: 100%;
        }
        .calc-input:focus {
            outline: none;
            border-color: var(--esa-accent);
        }
        .calc-label {
            font-size: 10px;
            color: var(--text-secondary);
            margin-bottom: 5px;
            display: block;
        }
        .calc-result {
            background: var(--esa-dark);
            border-radius: 4px;
            padding: 15px;
            text-align: center;
        }
        .calc-result-value {
            font-size: 24px;
            font-weight: 700;
            color: var(--esa-light);
        }
        .calc-result-label {
            font-size: 10px;
            color: var(--text-secondary);
            margin-top: 5px;
        }

        /* Report */
        .report-container {
            background: var(--grey-mid);
            border: 1px solid var(--grey-border);
            border-radius: 6px;
            padding: 20px;
        }
        .report-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
            padding-bottom: 15px;
            border-bottom: 1px solid var(--grey-border);
        }
        .report-title { font-size: 16px; font-weight: 600; color: var(--white); }
        .report-section { margin-bottom: 20px; }
        .report-section h4 {
            font-size: 11px;
            color: var(--esa-light);
            text-transform: uppercase;
            letter-spacing: 1px;
            margin-bottom: 10px;
        }
        .report-text { font-size: 12px; line-height: 1.7; color: var(--text-secondary); }
        .btn {
            padding: 8px 16px;
            background: var(--esa-accent);
            color: var(--white);
            border: none;
            border-radius: 4px;
            font-size: 11px;
            font-weight: 600;
            cursor: pointer;
        }
        .btn:hover { background: var(--esa-light); }

        /* Tabs */
        .tabs {
            display: flex;
            gap: 5px;
            margin-bottom: 12px;
        }
        .tab {
            padding: 6px 12px;
            background: var(--grey-light);
            border: none;
            border-radius: 4px;
            color: var(--text-secondary);
            font-size: 10px;
            cursor: pointer;
        }
        .tab.active, .tab:hover {
            background: var(--esa-accent);
            color: var(--white);
        }

        /* Confluence Score */
        .confluence-meter {
            height: 30px;
            background: var(--grey-dark);
            border-radius: 4px;
            overflow: hidden;
            position: relative;
            margin: 10px 0;
        }
        .confluence-fill {
            height: 100%;
            transition: width 0.5s ease;
        }
        .confluence-marker {
            position: absolute;
            top: 0;
            width: 2px;
            height: 100%;
            background: var(--white);
        }
        .confluence-labels {
            display: flex;
            justify-content: space-between;
            font-size: 9px;
            color: var(--text-secondary);
            margin-top: 5px;
        }

        /* News Modal */
        .news-modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0,0,0,0.8);
            z-index: 9999;
            justify-content: center;
            align-items: center;
        }
        .news-modal.active {
            display: flex;
        }
        .news-modal-content {
            background: var(--esa-dark);
            border: 1px solid var(--grey-border);
            border-radius: 8px;
            max-width: 600px;
            width: 90%;
            max-height: 80vh;
            overflow-y: auto;
            padding: 20px;
        }
        .news-modal-header {
            display: flex;
            justify-content: space-between;
            align-items: flex-start;
            margin-bottom: 15px;
            padding-bottom: 15px;
            border-bottom: 1px solid var(--grey-border);
        }
        .news-modal-title {
            font-size: 18px;
            font-weight: 600;
            color: var(--text-primary);
            flex: 1;
            line-height: 1.4;
        }
        .news-modal-close {
            background: var(--danger);
            color: white;
            border: none;
            width: 30px;
            height: 30px;
            border-radius: 50%;
            cursor: pointer;
            font-size: 16px;
            margin-left: 15px;
            flex-shrink: 0;
        }
        .news-modal-close:hover {
            background: #dc2626;
        }
        .news-modal-meta {
            display: flex;
            gap: 15px;
            margin-bottom: 15px;
            flex-wrap: wrap;
        }
        .news-modal-meta span {
            font-size: 12px;
            color: var(--text-secondary);
        }
        .news-modal-body {
            font-size: 14px;
            line-height: 1.7;
            color: var(--text-primary);
        }
        .news-item-clickable {
            cursor: pointer;
            transition: background 0.2s;
        }
        .news-item-clickable:hover {
            background: var(--grey-mid);
        }
    </style>
</head>
<body>
    <aside class="sidebar">
        <div class="logo-section">
            <img src="graphics/logos/Berelz Profile bl.jpg" alt="Berelz" class="logo-img">
            <div class="logo-text">BERELZ</div>
            <div class="logo-sub">Trading Dashboard</div>
        </div>
        <ul class="nav-menu">
            <li class="nav-item active" onclick="showSection('dashboard', this)"><span class="nav-icon">üìä</span> Dashboard</li>
            <li class="nav-item" onclick="showSection('prognosis', this)"><span class="nav-icon">üîÆ</span> 24h Prognosis</li>
            <li class="nav-item" onclick="showSection('boxtheory', this)"><span class="nav-icon">üì¶</span> Box Theory</li>
            <li class="nav-item" onclick="showSection('fibonacci', this)"><span class="nav-icon">üåÄ</span> Fibonacci</li>
            <li class="nav-item" onclick="showSection('risk', this)"><span class="nav-icon">‚ö†Ô∏è</span> Risk Metrics</li>
            <li class="nav-item" onclick="showSection('position', this)"><span class="nav-icon">üßÆ</span> Position Calc</li>
            <li class="nav-item" onclick="showSection('news', this)"><span class="nav-icon">üì∞</span> News & Calendar</li>
            <li class="nav-item" onclick="showSection('report', this)"><span class="nav-icon">üìã</span> Full Report</li>
            <li class="nav-item" onclick="showSection('help', this)"><span class="nav-icon">‚ùì</span> Help</li>
        </ul>
        <div class="nav-footer">BerelzDashboard v1.0</div>
    </aside>

    <main class="main">
        <header class="header">
            <div class="header-title" id="pageTitle">Dashboard</div>
            <div class="header-price">
                <span class="live-price" id="livePrice">---.--</span>
                <span class="price-change up" id="priceChange">+0.00 (0.00%)</span>
            </div>
            <div class="header-status">
                <div class="status-dot"></div>
                <span id="lastUpdate">Connecting...</span>
            </div>
        </header>

        <div class="content">
            <!-- Dashboard -->
            <section id="dashboard" class="section active">
                <div id="dashboardContent">Loading...</div>
            </section>

            <!-- 24h Prognosis -->
            <section id="prognosis" class="section">
                <div id="prognosisContent">Loading prognosis...</div>
            </section>

            <!-- Box Theory -->
            <section id="boxtheory" class="section">
                <div id="boxContent">Loading...</div>
            </section>

            <!-- Fibonacci -->
            <section id="fibonacci" class="section">
                <div id="fibContent">Loading...</div>
            </section>

            <!-- Risk Metrics -->
            <section id="risk" class="section">
                <div id="riskContent">Loading...</div>
            </section>


            <!-- Economic Calendar -->
            <section id="calendar" class="section">
                <div id="calendarContent">Loading...</div>
            </section>

            <!-- Position Calculator -->
            <section id="position" class="section">
                <div id="positionContent">Loading...</div>
            </section>

            <!-- News & COT -->
            <section id="news" class="section">
                <div id="newsContent">Loading...</div>
            </section>

            <!-- Full Report -->
            <section id="report" class="section">
                <div id="reportContent">Loading...</div>
            </section>

            <!-- Help -->
            <section id="help" class="section">
                <div id="helpContent">
                    <div class="cards-grid">
                        <div class="card" style="grid-column: span 2;">
                            <div class="card-header">BerelzDashboard Pro - User Guide</div>
                            <p style="font-size: 12px; line-height: 1.8; color: var(--text-secondary); margin-bottom: 15px;">
                                Welcome to the professional-grade trading dashboard. This dashboard provides hedge fund-level analysis tools for any instrument your broker offers.
                            </p>
                        </div>
                    </div>

                    <div class="cards-grid">
                        <div class="card">
                            <div class="card-header">üìä Dashboard</div>
                            <p style="font-size: 11px; line-height: 1.7; color: var(--text-secondary);">
                                Main overview with signal (BUY/SELL/HOLD), 24h price targets, confidence level, candlestick chart with Box Theory overlay, risk metrics, and indicator breakdown.
                            </p>
                        </div>
                        <div class="card">
                            <div class="card-header">üîÆ 24h Prognosis</div>
                            <p style="font-size: 11px; line-height: 1.7; color: var(--text-secondary);">
                                Detailed 24-hour price forecast with scenario analysis, key levels, trade setup recommendations, and probability assessments.
                            </p>
                        </div>
                        <div class="card">
                            <div class="card-header">üì¶ Box Theory</div>
                            <p style="font-size: 11px; line-height: 1.7; color: var(--text-secondary);">
                                Darvas Box analysis across multiple timeframes (20/50/100 bars). Identifies consolidation zones and breakout signals.
                            </p>
                        </div>
                        <div class="card">
                            <div class="card-header">üåÄ Fibonacci</div>
                            <p style="font-size: 11px; line-height: 1.7; color: var(--text-secondary);">
                                Fibonacci retracement (0%, 23.6%, 38.2%, 50%, 61.8%, 78.6%, 100%) and extension levels (127.2%, 161.8%) with visual price position.
                            </p>
                        </div>
                        <div class="card">
                            <div class="card-header">‚ö†Ô∏è Risk Metrics</div>
                            <p style="font-size: 11px; line-height: 1.7; color: var(--text-secondary);">
                                Professional risk analysis: Volatility, Sharpe Ratio, Sortino Ratio, Calmar Ratio, Max Drawdown, VaR (95%/99%), Kelly Criterion position sizing.
                            </p>
                        </div>
                        <div class="card">
                            <div class="card-header">üìÖ Economic Calendar</div>
                            <p style="font-size: 11px; line-height: 1.7; color: var(--text-secondary);">
                                Upcoming high-impact economic events affecting gold and EUR: Central bank decisions, NFP, CPI, PMI data releases.
                            </p>
                        </div>
                        <div class="card">
                            <div class="card-header">üßÆ Position Calculator</div>
                            <p style="font-size: 11px; line-height: 1.7; color: var(--text-secondary);">
                                Calculate optimal lot size based on account balance, risk percentage, entry price, and stop loss. Shows margin requirements.
                            </p>
                        </div>
                        <div class="card">
                            <div class="card-header">üì∞ News & COT</div>
                            <p style="font-size: 11px; line-height: 1.7; color: var(--text-secondary);">
                                Market news with sentiment analysis and COT (Commitment of Traders) report showing speculator positioning.
                            </p>
                        </div>
                        <div class="card">
                            <div class="card-header">üìã Full Report</div>
                            <p style="font-size: 11px; line-height: 1.7; color: var(--text-secondary);">
                                Comprehensive analysis report with executive summary, technical analysis, Box Theory, risk metrics, and trade recommendations. Printable format.
                            </p>
                        </div>
                    </div>

                    <div class="card" style="margin-top: 15px;">
                        <div class="card-header">Signal Interpretation Guide</div>
                        <div class="data-row"><span class="data-label"><span class="badge buy">BUY</span> 75%+ Confidence</span><span class="data-value positive">LOW RISK - Standard position</span></div>
                        <div class="data-row"><span class="data-label"><span class="badge buy">BUY</span> 60-75% Confidence</span><span class="data-value neutral">MEDIUM RISK - Reduced size</span></div>
                        <div class="data-row"><span class="data-label"><span class="badge neutral">HOLD</span> &lt;60% Confidence</span><span class="data-value negative">HIGH RISK - Wait for setup</span></div>
                        <div class="data-row"><span class="data-label"><span class="badge sell">SELL</span> 60%+ Confidence</span><span class="data-value">Short opportunity</span></div>
                    </div>

                    <div class="card" style="margin-top: 15px;">
                        <div class="card-header">News & Calendar Guide (Click to Read)</div>
                        <p style="font-size: 11px; color: var(--text-secondary); margin-bottom: 10px;">All news items and calendar events are <strong>clickable</strong> - click to read full details and trading implications.</p>
                        <div class="data-row"><span class="data-label"><span style="color: var(--success); font-weight: bold;">‚ñ≤</span> BULLISH for Gold</span><span class="data-value positive">News supports BUYING gold</span></div>
                        <div class="data-row"><span class="data-label"><span style="color: var(--danger); font-weight: bold;">‚ñº</span> BEARISH for Gold</span><span class="data-value negative">News supports SELLING gold</span></div>
                        <div class="data-row"><span class="data-label"><span style="color: var(--text-secondary); font-weight: bold;">‚óè</span> NEUTRAL</span><span class="data-value">No clear direction</span></div>
                        <div style="margin-top: 10px; padding-top: 10px; border-top: 1px solid var(--grey-border);">
                            <div class="data-row"><span class="data-label"><span class="calendar-impact high" style="display:inline-block;margin-right:5px;"></span> High Impact</span><span class="data-value negative">Major volatility - reduce size!</span></div>
                            <div class="data-row"><span class="data-label"><span class="calendar-impact medium" style="display:inline-block;margin-right:5px;"></span> Medium Impact</span><span class="data-value neutral">Moderate moves possible</span></div>
                            <div class="data-row"><span class="data-label"><span class="calendar-impact low" style="display:inline-block;margin-right:5px;"></span> Low Impact</span><span class="data-value">Minor effect expected</span></div>
                        </div>
                        <p style="font-size: 10px; color: var(--warning); margin-top: 10px;">TIP: Avoid trading 15 min before/after HIGH impact events!</p>
                    </div>

                    <div class="card" style="margin-top: 15px;">
                        <div class="card-header">Technical Requirements</div>
                        <div class="data-row"><span class="data-label">Server</span><span class="data-value">./START.sh (localhost:8080)</span></div>
                        <div class="data-row"><span class="data-label">Data Source</span><span class="data-value">MT5 StreamData.mq5</span></div>
                        <div class="data-row"><span class="data-label">Auto-refresh</span><span class="data-value">Every 60 seconds</span></div>
                        <div class="data-row"><span class="data-label">Browser</span><span class="data-value">Chrome/Safari/Firefox</span></div>
                    </div>
                </div>
            </section>
        </div>
    </main>

    <script>
        // MT5 Data Path - reads directly from MT5 Files folder
        const MT5_DATA_URL = 'http://localhost:8080/api/data';  // Full URL for auto-connect
        let marketData = null;
        let analysis = null;
        let previousSignal = null;
        let _prevAnalysis = null;      // Previous analysis for prediction smoothing
        let _smoothedTarget = null;    // Smoothed 24h target price
        let _smoothedProb = null;      // Smoothed probability
        let _smoothedConf = null;      // Smoothed confidence
        let _smoothedH1 = null;        // Smoothed H1 forecast array
        let _signalHoldCount = 0;      // Counter for signal hysteresis

        // Sound alert for signal changes
        function playSignalAlert(signal) {
            const ctx = new (window.AudioContext || window.webkitAudioContext)();
            const osc = ctx.createOscillator();
            const gain = ctx.createGain();
            osc.connect(gain);
            gain.connect(ctx.destination);

            // Different tones for BUY/SELL
            if (signal === 'BUY') {
                osc.frequency.value = 880; // High pitch for buy
                osc.type = 'sine';
            } else if (signal === 'SELL') {
                osc.frequency.value = 440; // Low pitch for sell
                osc.type = 'triangle';
            } else {
                osc.frequency.value = 660; // Medium for hold
                osc.type = 'square';
            }

            gain.gain.setValueAtTime(0.3, ctx.currentTime);
            gain.gain.exponentialRampToValueAtTime(0.01, ctx.currentTime + 0.5);
            osc.start(ctx.currentTime);
            osc.stop(ctx.currentTime + 0.5);
        }

        // CRASH/SPIKE ALERT - detect extreme price moves with early warnings
        let lastAlertPrice = null;
        let lastAlertTime = 0;
        let lastPreAlertTime = 0;
        const CRASH_THRESHOLD_PCT = 2.0;    // 2% move = FULL alert
        const PRE_ALERT_1_PCT = 1.0;        // 1% move = early warning
        const PRE_ALERT_2_PCT = 1.5;        // 1.5% move = strong warning
        const ALERT_COOLDOWN = 300000;       // 5 min cooldown between full alerts
        const PRE_ALERT_COOLDOWN = 120000;   // 2 min cooldown between pre-alerts

        function playCrashAlert() {
            const ctx = new (window.AudioContext || window.webkitAudioContext)();
            // Urgent alarm: 3 rapid beeps
            for (let i = 0; i < 3; i++) {
                const osc = ctx.createOscillator();
                const gain = ctx.createGain();
                osc.connect(gain);
                gain.connect(ctx.destination);
                osc.frequency.value = 1200;
                osc.type = 'sawtooth';
                gain.gain.setValueAtTime(0.4, ctx.currentTime + i * 0.2);
                gain.gain.exponentialRampToValueAtTime(0.01, ctx.currentTime + i * 0.2 + 0.15);
                osc.start(ctx.currentTime + i * 0.2);
                osc.stop(ctx.currentTime + i * 0.2 + 0.15);
            }
        }

        function playPreAlert() {
            const ctx = new (window.AudioContext || window.webkitAudioContext)();
            // Single soft warning tone
            const osc = ctx.createOscillator();
            const gain = ctx.createGain();
            osc.connect(gain);
            gain.connect(ctx.destination);
            osc.frequency.value = 800;
            osc.type = 'sine';
            gain.gain.setValueAtTime(0.2, ctx.currentTime);
            gain.gain.exponentialRampToValueAtTime(0.01, ctx.currentTime + 0.3);
            osc.start(ctx.currentTime);
            osc.stop(ctx.currentTime + 0.3);
        }

        // Extreme RSI alert state
        let lastRsiAlertTime = 0;
        const RSI_ALERT_COOLDOWN = 1800000;  // 30 min cooldown for RSI alerts
        const RSI_EXTREME_HIGH = 85;         // D1 RSI above = extreme overbought warning
        const RSI_EXTREME_LOW = 15;          // D1 RSI below = extreme oversold warning

        function checkPriceCrash(data) {
            if (!data.bars || data.bars.length < 12) return;
            const now = Date.now();
            const currentPrice = data.bid;

            // Use close price of bar from 1h ago (not open) for consistency with current bid
            const barsBack = data.bars.slice(-12);
            const hourAgoBar = barsBack[0];
            const hourAgoPrice = hourAgoBar.c;  // CLOSE price for consistency

            // Validate bar timing: bar should be roughly 55-65 min old
            // If bar has a parseable time, check it
            if (hourAgoBar.time) {
                const barTime = new Date(hourAgoBar.time.replace(/\./g, '-'));
                const barAge = now - barTime.getTime();
                // If bar is more than 75 min old or less than 45 min, data might be stale
                if (barAge > 75 * 60000 || barAge < 45 * 60000) {
                    // Still calculate but mark as potentially stale
                    console.log(`Crash check: bar age ${Math.round(barAge/60000)}m (expected ~60m)`);
                }
            }

            const movePct = ((currentPrice - hourAgoPrice) / hourAgoPrice) * 100;
            const moveAbs = Math.abs(currentPrice - hourAgoPrice).toFixed(2);

            // Also check 15-min velocity (last 3 bars) for predictive warning
            const last3Bars = data.bars.slice(-3);
            const price15mAgo = last3Bars[0].c;
            const velocity15m = ((currentPrice - price15mAgo) / price15mAgo) * 100;
            const projectedMove = velocity15m * 4;  // Project 15min rate over 1h

            if (lastAlertPrice === null) lastAlertPrice = currentPrice;

            // === FULL CRASH/SPIKE ALERT (2%+) ===
            if (Math.abs(movePct) >= CRASH_THRESHOLD_PCT && (now - lastAlertTime > ALERT_COOLDOWN)) {
                const direction = movePct < 0 ? 'CRASH' : 'SPIKE';
                const emoji = movePct < 0 ? 'üî¥' : 'üü¢';

                playCrashAlert();

                if (Notification.permission === 'granted') {
                    new Notification(`${emoji} GOLD ${direction} ALERT!`, {
                        body: `XAU/EUR ${direction}: ${movePct.toFixed(1)}% (${moveAbs} EUR) in 1 hour\nPrice: ${hourAgoPrice.toFixed(2)} ‚Üí ${currentPrice.toFixed(2)}\nVelocity: ${velocity15m > 0 ? '+' : ''}${velocity15m.toFixed(2)}%/15m`,
                        icon: emoji,
                        requireInteraction: true
                    });
                }

                showAlertBanner(
                    movePct < 0 ? '#dc2626' : '#16a34a',
                    `${emoji} GOLD ${direction}: ${movePct.toFixed(1)}% (${moveAbs} EUR) in 1h | Velocity: ${velocity15m.toFixed(2)}%/15m | ${hourAgoPrice.toFixed(2)} ‚Üí ${currentPrice.toFixed(2)} ‚Äî Click to dismiss`
                );

                lastAlertPrice = currentPrice;
                lastAlertTime = now;
                console.warn(`PRICE ${direction}: ${movePct.toFixed(2)}% in 1 hour`);
            }
            // === PRE-ALERT: approaching crash territory (1-2%) ===
            else if (Math.abs(movePct) >= PRE_ALERT_1_PCT && (now - lastPreAlertTime > PRE_ALERT_COOLDOWN)) {
                const severity = Math.abs(movePct) >= PRE_ALERT_2_PCT ? 'HIGH' : 'MODERATE';
                const direction = movePct < 0 ? 'SELLING' : 'BUYING';
                const emoji = movePct < 0 ? 'üü°' : 'üü°';
                const bgColor = severity === 'HIGH' ? '#d97706' : '#ca8a04';

                playPreAlert();

                // Predictive: if 15min velocity continues, when will we hit 2%?
                let projectionMsg = '';
                if (Math.abs(velocity15m) > 0.1) {
                    const remaining = CRASH_THRESHOLD_PCT - Math.abs(movePct);
                    const ratePerMin = Math.abs(velocity15m) / 15;
                    const minsToThreshold = ratePerMin > 0 ? Math.round(remaining / ratePerMin) : 999;
                    if (minsToThreshold < 60) {
                        projectionMsg = ` | At current pace: 2% in ~${minsToThreshold}min`;
                    }
                }

                showAlertBanner(
                    bgColor,
                    `${emoji} ${severity} MOVE: ${movePct > 0 ? '+' : ''}${movePct.toFixed(1)}% (${moveAbs} EUR) in 1h | ${direction} pressure${projectionMsg} ‚Äî Click to dismiss`
                );

                lastPreAlertTime = now;
            }

            // === EXTREME RSI ALERT ===
            checkExtremeRSI(data, now);
        }

        function checkExtremeRSI(data, now) {
            if (now - lastRsiAlertTime < RSI_ALERT_COOLDOWN) return;
            if (!data.bars || data.bars.length < 14) return;

            // Use the SAME RSI that the dashboard shows (single source of truth)
            if (!analysis || !analysis.indicators) return;

            // Clamp to valid range ‚Äî same value shown in dashboard indicator bar
            const rsi = Math.max(0, Math.min(100, analysis.indicators.rsi));
            const d1Rsi = analysis.d1Rsi != null ? Math.max(0, Math.min(100, analysis.d1Rsi)) : null;
            const checkRsi = d1Rsi || rsi;  // prefer D1, fallback to M5

            if (checkRsi > RSI_EXTREME_HIGH) {
                playCrashAlert();
                const tf = d1Rsi ? 'D1' : 'M5';
                if (Notification.permission === 'granted') {
                    new Notification('‚ö†Ô∏è EXTREME OVERBOUGHT!', {
                        body: `${tf} RSI at ${checkRsi.toFixed(1)} ‚Äî crash risk HIGH\nGold is extremely overbought. Watch for reversal.`,
                        requireInteraction: true
                    });
                }
                showAlertBanner('#f59e0b',
                    `‚ö†Ô∏è EXTREME OVERBOUGHT: ${tf} RSI = ${checkRsi.toFixed(1)} ‚Äî Crash risk elevated ‚Äî Click to dismiss`
                );
                lastRsiAlertTime = now;
                console.warn(`EXTREME RSI: ${tf} RSI = ${checkRsi.toFixed(1)} (overbought)`);
            }
            else if (checkRsi < RSI_EXTREME_LOW) {
                playCrashAlert();
                const tf = d1Rsi ? 'D1' : 'M5';
                if (Notification.permission === 'granted') {
                    new Notification('‚ö†Ô∏è EXTREME OVERSOLD!', {
                        body: `${tf} RSI at ${checkRsi.toFixed(1)} ‚Äî bounce possible\nGold is extremely oversold.`,
                        requireInteraction: true
                    });
                }
                showAlertBanner('#7c3aed',
                    `‚ö†Ô∏è EXTREME OVERSOLD: ${tf} RSI = ${checkRsi.toFixed(1)} ‚Äî Bounce possible ‚Äî Click to dismiss`
                );
                lastRsiAlertTime = now;
                console.warn(`EXTREME RSI: ${tf} RSI = ${checkRsi.toFixed(1)} (oversold)`);
            }
        }

        function showAlertBanner(bgColor, message) {
            let banner = document.getElementById('crashBanner');
            if (!banner) {
                banner = document.createElement('div');
                banner.id = 'crashBanner';
                banner.style.cssText = 'position:fixed;top:0;left:0;right:0;z-index:9999;padding:12px 20px;text-align:center;font-weight:bold;font-size:16px;cursor:pointer;animation:pulse 1s infinite;';
                banner.onclick = () => banner.remove();
                document.body.prepend(banner);
            }
            banner.style.background = bgColor;
            banner.style.color = 'white';
            banner.innerHTML = message;
        }

        // Smart innerHTML update - only replace DOM when content actually changed
        // This prevents flickering caused by unnecessary DOM destruction/recreation
        function updateContent(elementId, newHtml) {
            const el = document.getElementById(elementId);
            if (!el) return false;
            if (el._lastHtml === newHtml) return false; // No change, skip DOM update
            el._lastHtml = newHtml;
            el.innerHTML = newHtml;
            return true; // Content was updated
        }

        // Get currently active section name
        function getActiveSection() {
            const active = document.querySelector('.section.active');
            return active ? active.id : 'dashboard';
        }

        // Load data from server (which reads MT5 file)
        async function loadData() {
            // Reset analysis to force fresh calculation
            analysis = null;
            try {
                document.getElementById('lastUpdate').textContent = 'Fetching MT5 data...';

                const response = await fetch(MT5_DATA_URL);
                if (!response.ok) throw new Error('Server offline');

                marketData = await response.json();

                // Validate data
                if (!marketData.bid || marketData.bid < 2000) {
                    throw new Error('Invalid price data');
                }

                try {
                    // Always render dashboard (computes analysis needed for alerts)
                    renderDashboard(marketData);

                    // Only render the currently visible section to prevent flickering
                    const active = getActiveSection();
                    if (active === 'prognosis') renderPrognosis(marketData);
                    else if (active === 'boxtheory') renderBoxTheory(marketData);
                    else if (active === 'fibonacci') renderFibonacci(marketData);
                    else if (active === 'risk') renderRisk(marketData);
                    else if (active === 'calendar') renderCalendar(marketData);
                    else if (active === 'position') renderPosition(marketData);
                    else if (active === 'news') renderNews(marketData);
                    else if (active === 'report') renderReport(marketData);

                    // Signal change alert
                    if (analysis && analysis.signal) {
                        if (previousSignal && previousSignal !== analysis.signal) {
                            playSignalAlert(analysis.signal);
                            // Show notification
                            if (Notification.permission === 'granted') {
                                new Notification(`Signal Changed: ${analysis.signal}`, {
                                    body: `XAU/EUR ${marketData.bid} - Confidence: ${analysis.confidence}%`,
                                    icon: 'üéØ'
                                });
                            }
                        }
                        previousSignal = analysis.signal;
                    }

                    // Check for price crash/spike (extreme moves)
                    checkPriceCrash(marketData);
                } catch (renderError) {
                    console.error('Render error:', renderError);
                    document.getElementById('dashboardContent').innerHTML = '<div style="color:red;padding:20px;">Error: ' + renderError.message + '</div>';
                }

                // Get broker name from MT5 data
                const brokerName = marketData.broker?.name || 'Broker';
                const sourceLabels = {
                    'MT5_LIVE': `üî¥ LIVE (${brokerName})`,
                    'live': 'üî¥ LIVE (API)',
                    'mt5': 'üî¥ MT5 LIVE',
                    'estimated': '‚ö†Ô∏è Estimated',
                    'NONE': '‚ùå No MT5 Data'
                };
                const source = sourceLabels[marketData.source] || `üî¥ ${marketData.source}`;
                const dataAge = marketData.timestamp ? Math.round((Date.now()/1000) - marketData.timestamp) : 0;
                const ageColor = dataAge < 10 ? 'var(--success)' : dataAge < 30 ? 'var(--warning)' : 'var(--danger)';
                document.getElementById('lastUpdate').innerHTML =
                    `<span style="color: ${ageColor};">‚óè</span> ${new Date().toLocaleTimeString()} ${source} <span style="color: var(--text-secondary); font-size: 10px;">(${dataAge}s ago)</span>`;

            } catch (error) {
                console.error('Load error:', error);
                document.getElementById('lastUpdate').textContent = 'Auto-connecting...';
                document.getElementById('dashboardContent').innerHTML = `
                    <div class="card" style="max-width: 400px; margin: 80px auto; text-align: center; padding: 40px;">
                        <div style="margin-bottom: 25px;">
                            <svg width="80" height="80" viewBox="0 0 100 100">
                                <circle cx="50" cy="50" r="40" fill="none" stroke="var(--grey-dark)" stroke-width="8"/>
                                <circle cx="50" cy="50" r="40" fill="none" stroke="var(--esa-accent)" stroke-width="8"
                                    stroke-dasharray="60 191" stroke-linecap="round">
                                    <animateTransform attributeName="transform" type="rotate" from="0 50 50" to="360 50 50" dur="1s" repeatCount="indefinite"/>
                                </circle>
                            </svg>
                        </div>
                        <h2 style="color: var(--esa-light); margin-bottom: 10px;">Connecting to Server...</h2>
                        <p style="color: var(--cyan); font-size: 14px; margin-bottom: 5px;">Auto-reconnect active</p>
                        <p style="color: var(--text-secondary); font-size: 12px;">Waiting for live XAU/EUR data</p>
                    </div>
                `;
                setTimeout(loadData, 2000);
            }
        }

        function showSection(name, el) {
            document.querySelectorAll('.section').forEach(s => s.classList.remove('active'));
            document.getElementById(name).classList.add('active');
            document.querySelectorAll('.nav-item').forEach(i => i.classList.remove('active'));
            if(el) el.classList.add('active');
            const titles = {
                dashboard: 'Dashboard', prognosis: '24-Hour Prognosis', boxtheory: 'Box Theory',
                fibonacci: 'Fibonacci Analysis', risk: 'Risk Metrics',
                calendar: 'Economic Calendar', position: 'Position Calculator', news: 'News, COT & Calendar',
                report: 'Complete Analysis Report', help: 'Help & Documentation'
            };
            document.getElementById('pageTitle').textContent = titles[name];

            // Render the newly visible section immediately with latest data
            if (marketData) {
                const renderers = {
                    dashboard: renderDashboard, prognosis: renderPrognosis, boxtheory: renderBoxTheory,
                    fibonacci: renderFibonacci, risk: renderRisk, position: renderPosition,
                    calendar: renderCalendar, news: renderNews, report: renderReport
                };
                if (renderers[name]) renderers[name](marketData);
            }
        }

        // Technical Analysis Engine
        class TA {
            static sma(data, period) {
                if (data.length < period) return null;
                return data.slice(-period).reduce((a, b) => a + b, 0) / period;
            }
            static ema(data, period) {
                if (data.length < period) return null;
                const k = 2 / (period + 1);
                let ema = this.sma(data.slice(0, period), period);
                for (let i = period; i < data.length; i++) ema = (data[i] - ema) * k + ema;
                return ema;
            }
            static rsi(closes, period = 14) {
                if (closes.length < period + 1) return 50;
                let gains = 0, losses = 0;
                for (let i = closes.length - period; i < closes.length; i++) {
                    const change = closes[i] - closes[i - 1];
                    if (change > 0) gains += change; else losses += Math.abs(change);
                }
                if (losses === 0) return 100;
                const val = 100 - (100 / (1 + (gains / period) / (losses / period)));
                return Math.max(0, Math.min(100, val));  // Always 0-100
            }
            static macd(closes) {
                const ema12 = this.ema(closes, 12), ema26 = this.ema(closes, 26);
                if (!ema12 || !ema26) return { macd: 0, signal: 0, histogram: 0 };
                const macdLine = ema12 - ema26;
                // Calculate signal line (9-period EMA of MACD values)
                const macdValues = [];
                for (let i = 26; i < closes.length; i++) {
                    const e12 = this.ema(closes.slice(0, i + 1), 12);
                    const e26 = this.ema(closes.slice(0, i + 1), 26);
                    if (e12 && e26) macdValues.push(e12 - e26);
                }
                const signal = macdValues.length >= 9 ? this.ema(macdValues, 9) : macdLine;
                const histogram = macdLine - signal;
                return { macd: macdLine, signal, histogram };
            }
            static bollinger(closes, period = 20) {
                const sma = this.sma(closes, period);
                if (!sma) return null;
                const slice = closes.slice(-period);
                const std = Math.sqrt(slice.reduce((sum, val) => sum + Math.pow(val - sma, 2), 0) / period);
                return { upper: sma + (2 * std), middle: sma, lower: sma - (2 * std), std };
            }
            static atr(bars, period = 144) {
                // 144 bars = 12 hours on M5, pip = 30 EUR
                const PIP_VALUE = 30;
                if (bars.length < period + 1) return 0;
                const start = Math.max(1, bars.length - period);
                let atr = 0;
                for (let i = start; i < bars.length; i++) {
                    atr += Math.max(bars[i].h - bars[i].l, Math.abs(bars[i].h - bars[i-1].c), Math.abs(bars[i].l - bars[i-1].c));
                }
                return atr / (bars.length - start);
            }
            static atrPips(bars, period = 144) {
                const atr = this.atr(bars, period);
                return atr * 30;  // 30 EUR per pip for XAUEUR
            }
            static stochastic(bars, period = 14, dPeriod = 3) {
                if (bars.length < period + dPeriod) return { k: 50, d: 50 };
                // Calculate %K values for the last dPeriod bars to get %D
                const kValues = [];
                for (let i = dPeriod - 1; i >= 0; i--) {
                    const endIdx = bars.length - i;
                    const slice = bars.slice(endIdx - period, endIdx);
                    const high = Math.max(...slice.map(b => b.h));
                    const low = Math.min(...slice.map(b => b.l));
                    const range = high - low;
                    if (range === 0) {
                        kValues.push(50);
                    } else {
                        kValues.push(((bars[endIdx - 1].c - low) / range) * 100);
                    }
                }
                const k = kValues[kValues.length - 1];
                const d = kValues.reduce((a, b) => a + b, 0) / kValues.length;  // 3-period SMA of %K
                return { k, d };
            }
            static adx(bars, period = 14) {
                if (bars.length < period * 2) return 25;
                // Calculate True Range, +DM, -DM with Wilder smoothing
                let smoothedTR = 0, smoothedPlusDM = 0, smoothedMinusDM = 0;
                const dxValues = [];

                // First period - simple sum
                for (let i = 1; i <= period; i++) {
                    const tr = Math.max(bars[i].h - bars[i].l, Math.abs(bars[i].h - bars[i-1].c), Math.abs(bars[i].l - bars[i-1].c));
                    const upMove = bars[i].h - bars[i-1].h;
                    const downMove = bars[i-1].l - bars[i].l;
                    smoothedTR += tr;
                    if (upMove > downMove && upMove > 0) smoothedPlusDM += upMove;
                    if (downMove > upMove && downMove > 0) smoothedMinusDM += downMove;
                }

                // Subsequent periods - Wilder smoothing
                for (let i = period + 1; i < bars.length; i++) {
                    const tr = Math.max(bars[i].h - bars[i].l, Math.abs(bars[i].h - bars[i-1].c), Math.abs(bars[i].l - bars[i-1].c));
                    const upMove = bars[i].h - bars[i-1].h;
                    const downMove = bars[i-1].l - bars[i].l;

                    smoothedTR = smoothedTR - (smoothedTR / period) + tr;
                    const plusDM = (upMove > downMove && upMove > 0) ? upMove : 0;
                    const minusDM = (downMove > upMove && downMove > 0) ? downMove : 0;
                    smoothedPlusDM = smoothedPlusDM - (smoothedPlusDM / period) + plusDM;
                    smoothedMinusDM = smoothedMinusDM - (smoothedMinusDM / period) + minusDM;

                    if (smoothedTR > 0) {
                        const plusDI = (smoothedPlusDM / smoothedTR) * 100;
                        const minusDI = (smoothedMinusDM / smoothedTR) * 100;
                        const sumDI = plusDI + minusDI;
                        if (sumDI > 0) {
                            dxValues.push(Math.abs(plusDI - minusDI) / sumDI * 100);
                        }
                    }
                }

                // ADX is smoothed average of DX values
                if (dxValues.length < period) return 25;
                let adx = dxValues.slice(0, period).reduce((a, b) => a + b, 0) / period;
                for (let i = period; i < dxValues.length; i++) {
                    adx = ((adx * (period - 1)) + dxValues[i]) / period;
                }
                return adx;
            }
            static boxTheory(bars, period = 20) {
                if (bars.length < period) return null;
                const slice = bars.slice(-period);
                const boxHigh = Math.max(...slice.map(b => b.h)), boxLow = Math.min(...slice.map(b => b.l));
                const current = bars[bars.length - 1].c, range = boxHigh - boxLow;
                let status = 'inside', signal = 'HOLD';
                if (current > boxHigh) { status = 'breakout-up'; signal = 'BUY'; }
                else if (current < boxLow) { status = 'breakout-down'; signal = 'SELL'; }
                const position = range > 0 ? ((current - boxLow) / range) * 100 : 50;
                return { boxHigh, boxLow, range, current, status, signal, position };
            }
            static fibonacci(bars, currentBid = null) {
                if (!bars || bars.length === 0) return null;
                let high = Math.max(...bars.map(b => b.h));
                let low = Math.min(...bars.map(b => b.l));
                // Include current live price in range calculation
                if (currentBid) {
                    high = Math.max(high, currentBid);
                    low = Math.min(low, currentBid);
                }
                const range = high - low || 1;  // Prevent division issues
                return {
                    high, low, range,
                    0: high, 0.236: high - range * 0.236, 0.382: high - range * 0.382,
                    0.5: high - range * 0.5, 0.618: high - range * 0.618, 0.786: high - range * 0.786, 1: low,
                    ext1272: high + range * 0.272, ext1618: high + range * 0.618
                };
            }
            static pivotPoints(bar) {
                const pivot = (bar.h + bar.l + bar.c) / 3;
                return {
                    r3: bar.h + 2 * (pivot - bar.l), r2: pivot + (bar.h - bar.l), r1: 2 * pivot - bar.l,
                    pivot, s1: 2 * pivot - bar.h, s2: pivot - (bar.h - bar.l), s3: bar.l - 2 * (bar.h - pivot)
                };
            }
            static volatility(bars, period = 20) {
                if (!bars || bars.length < 2) return 0;
                const returns = [];
                for (let i = 1; i < bars.length; i++) {
                    if (bars[i-1].c !== 0) returns.push((bars[i].c - bars[i-1].c) / bars[i-1].c);
                }
                if (returns.length === 0) return 0;
                const mean = returns.reduce((a,b) => a+b, 0) / returns.length;
                const variance = returns.reduce((sum, r) => sum + Math.pow(r - mean, 2), 0) / returns.length;
                return Math.sqrt(variance) * Math.sqrt(252) * 100; // Annualized
            }
            static sharpeRatio(bars, riskFreeRate = 0.05) {
                if (!bars || bars.length < 2) return 0;
                const returns = [];
                for (let i = 1; i < bars.length; i++) {
                    if (bars[i-1].c !== 0) returns.push((bars[i].c - bars[i-1].c) / bars[i-1].c);
                }
                if (returns.length === 0) return 0;
                const meanReturn = returns.reduce((a,b) => a+b, 0) / returns.length * 252;
                const stdDev = Math.sqrt(returns.reduce((sum, r) => sum + Math.pow(r - meanReturn/252, 2), 0) / returns.length) * Math.sqrt(252);
                if (stdDev === 0) return 0;
                return (meanReturn - riskFreeRate) / stdDev;
            }
            static maxDrawdown(bars) {
                if (!bars || bars.length === 0) return 0;
                let peak = bars[0].c, maxDD = 0;
                for (const bar of bars) {
                    if (bar.c > peak) peak = bar.c;
                    if (peak > 0) {
                        const dd = (peak - bar.c) / peak;
                        if (dd > maxDD) maxDD = dd;
                    }
                }
                return maxDD * 100;
            }
            static valueAtRisk(bars, confidence = 0.95) {
                if (!bars || bars.length < 2) return 0;
                const returns = [];
                for (let i = 1; i < bars.length; i++) {
                    if (bars[i-1].c !== 0) returns.push((bars[i].c - bars[i-1].c) / bars[i-1].c);
                }
                if (returns.length === 0) return 0;
                returns.sort((a, b) => a - b);
                const index = Math.floor((1 - confidence) * returns.length);
                return Math.abs(returns[index] || 0) * 100;
            }
        }

        // Filter out weekend bars (market closed Fri 23:00 - Mon 00:00 server time EET)
        // Falls back to unfiltered bars if filtering reduces below minimum
        function filterWeekendBars(bars, minBars = 50) {
            if (!bars || bars.length === 0) return bars;
            const filtered = bars.filter(bar => {
                if (!bar.time) return true;
                const d = new Date(bar.time.replace(/\./g, '-'));
                if (isNaN(d.getTime())) return true;
                const day = d.getDay(); // 0=Sun, 6=Sat
                const hour = d.getHours();
                // Remove: Saturday all day, Sunday all day, Friday after 23:00
                if (day === 0) return false; // Sunday
                if (day === 6) return false; // Saturday
                if (day === 5 && hour >= 23) return false; // Friday after 23:00
                return true;
            });
            // If filtering removed too many, keep originals
            return filtered.length >= minBars ? filtered : bars;
        }

        function analyze(data) {
            // =========================================================================
            // MULTI-TIMEFRAME 24H FORECAST ENGINE
            // Combines: D1 (35%) + H1 (30%) + M5 (20%) + News (10%) + Calendar (5%)
            // =========================================================================

            const bars = filterWeekendBars(data.bars || [], 50);
            const barsH1 = filterWeekendBars(data.bars_h1 || [], 5);
            const barsD1 = filterWeekendBars(data.bars_d1 || [], 5);
            const news = data.news || [];
            const calendar = data.calendar || [];

            if (bars.length < 50) {
                return {
                    signal: 'HOLD', confidence: 0, error: 'Insufficient data',
                    change: 0, changePct: 0, buyVotes: 0, sellVotes: 0,
                    indicators: { sma20: 0, sma50: 0, sma200: 0, ema12: 0, ema26: 0, rsi: 50, macd: {value:0,signal:0,histogram:0}, bb: {upper:0,middle:0,lower:0}, stoch: {k:50,d:50}, atr: 0, adx: 0 },
                    box: null, fib: null, pivots: null, volatility: 0, sharpe: 0, maxDD: 0, var95: 0,
                    prognosis: { low: data.bid, target: data.bid, high: data.bid, probability: 50 },
                    bars: [], signals: [], mtf: { d1:{}, h1:{}, m5:{}, news:{}, cal:{}, combined:0, confluence:0, weights:{} }
                };
            }

            const closes = bars.map(b => b.c);
            const current = bars[bars.length - 1], prev = bars[bars.length - 2];

            // M5 Indicators ‚Äî SINGLE SOURCE OF TRUTH
            // Use server-calculated indicators when available (they use the same bars)
            // Fall back to client-side calculation only when server data missing
            const srv = data.server_signal?.indicators || {};
            const sma20 = srv.sma20 || TA.sma(closes, 20);
            const sma50 = srv.sma50 || TA.sma(closes, 50);
            const sma200 = TA.sma(closes, 200);  // Server doesn't always have 200 bars
            const ema12 = TA.ema(closes, 12), ema26 = TA.ema(closes, 26);

            // CRITICAL: Use server RSI/ADX/ATR as primary ‚Äî clamp to valid ranges
            const rsi = Math.max(0, Math.min(100, srv.rsi != null ? srv.rsi : TA.rsi(closes)));
            const macd = srv.macd && srv.macd.macd != null ? srv.macd : TA.macd(closes);
            const bb = srv.bb || TA.bollinger(closes);
            const stoch = srv.stoch || TA.stochastic(bars);
            // Clamp stochastic to valid range
            if (stoch.k != null) stoch.k = Math.max(0, Math.min(100, stoch.k));
            if (stoch.d != null) stoch.d = Math.max(0, Math.min(100, stoch.d));
            const atr = srv.atr != null ? srv.atr : TA.atr(bars);
            const adx = Math.max(0, Math.min(100, srv.adx != null ? srv.adx : TA.adx(bars)));

            // These are client-only (server doesn't calculate them)
            const box = TA.boxTheory(bars, 20), fib = TA.fibonacci(bars, data.bid);
            const pivots = bars.length >= 2 ? TA.pivotPoints(bars[bars.length - 2]) : { r3: 0, r2: 0, r1: 0, pivot: 0, s1: 0, s2: 0, s3: 0 };
            const volatility = TA.volatility(bars), sharpe = TA.sharpeRatio(bars);
            const maxDD = TA.maxDrawdown(bars), var95 = TA.valueAtRisk(bars);

            // =========================================================================
            // 1. DAILY (D1) TREND - Weight 35% - Primary direction for 24h forecast
            // =========================================================================
            let d1Buy = 0, d1Sell = 0;
            let d1RsiValue = null;  // Store D1 RSI for extreme alert
            const d1Signals = [];

            if (barsD1.length >= 20) {
                const d1Closes = barsD1.map(b => b.c);
                const d1Current = barsD1[barsD1.length - 1];
                const d1Sma10 = TA.sma(d1Closes, 10);
                const d1Sma20 = TA.sma(d1Closes, 20);
                const d1Rsi = TA.rsi(d1Closes);
                d1RsiValue = d1Rsi;
                const d1Macd = TA.macd(d1Closes);
                const d1Adx = TA.adx(barsD1);

                // D1 Trend direction
                if (d1Current.c > d1Sma10 && d1Sma10 > d1Sma20) {
                    d1Buy += 5; d1Signals.push({ tf: 'D1', name: 'Trend', vote: 'BUY', reason: 'Daily uptrend (Price > SMA10 > SMA20)' });
                } else if (d1Current.c < d1Sma10 && d1Sma10 < d1Sma20) {
                    d1Sell += 5; d1Signals.push({ tf: 'D1', name: 'Trend', vote: 'SELL', reason: 'Daily downtrend (Price < SMA10 < SMA20)' });
                } else if (d1Current.c > d1Sma20) {
                    d1Buy += 2; d1Signals.push({ tf: 'D1', name: 'Trend', vote: 'BUY', reason: 'Price above D1 SMA20' });
                } else {
                    d1Sell += 2; d1Signals.push({ tf: 'D1', name: 'Trend', vote: 'SELL', reason: 'Price below D1 SMA20' });
                }

                // D1 RSI
                if (d1Rsi < 35) { d1Buy += 3; d1Signals.push({ tf: 'D1', name: 'RSI', vote: 'BUY', reason: `D1 Oversold (${d1Rsi.toFixed(1)})` }); }
                else if (d1Rsi > 65) { d1Sell += 3; d1Signals.push({ tf: 'D1', name: 'RSI', vote: 'SELL', reason: `D1 Overbought (${d1Rsi.toFixed(1)})` }); }

                // D1 MACD
                if (d1Macd.histogram > 0) { d1Buy += 2; d1Signals.push({ tf: 'D1', name: 'MACD', vote: 'BUY', reason: 'D1 MACD positive' }); }
                else { d1Sell += 2; d1Signals.push({ tf: 'D1', name: 'MACD', vote: 'SELL', reason: 'D1 MACD negative' }); }

                // D1 ADX trend strength bonus
                if (d1Adx > 25) {
                    if (d1Buy > d1Sell) d1Buy += 2;
                    else d1Sell += 2;
                }
            }

            // =========================================================================
            // 2. HOURLY (H1) TREND - Weight 30% - Medium-term confirmation
            // =========================================================================
            let h1Buy = 0, h1Sell = 0;
            const h1Signals = [];

            if (barsH1.length >= 30) {
                const h1Closes = barsH1.map(b => b.c);
                const h1Current = barsH1[barsH1.length - 1];
                const h1Sma20 = TA.sma(h1Closes, 20);
                const h1Sma50 = TA.sma(h1Closes, 50);
                const h1Rsi = TA.rsi(h1Closes);
                const h1Macd = TA.macd(h1Closes);
                const h1Stoch = TA.stochastic(barsH1);
                const h1Bb = TA.bollinger(h1Closes);

                // H1 Trend
                if (h1Current.c > h1Sma20 && h1Sma20 > h1Sma50) {
                    h1Buy += 4; h1Signals.push({ tf: 'H1', name: 'Trend', vote: 'BUY', reason: 'H1 uptrend confirmed' });
                } else if (h1Current.c < h1Sma20 && h1Sma20 < h1Sma50) {
                    h1Sell += 4; h1Signals.push({ tf: 'H1', name: 'Trend', vote: 'SELL', reason: 'H1 downtrend confirmed' });
                } else if (h1Current.c > h1Sma50) {
                    h1Buy += 2; h1Signals.push({ tf: 'H1', name: 'Trend', vote: 'BUY', reason: 'Price above H1 SMA50' });
                } else {
                    h1Sell += 2; h1Signals.push({ tf: 'H1', name: 'Trend', vote: 'SELL', reason: 'Price below H1 SMA50' });
                }

                // H1 RSI
                if (h1Rsi < 30) { h1Buy += 3; h1Signals.push({ tf: 'H1', name: 'RSI', vote: 'BUY', reason: `H1 Oversold (${h1Rsi.toFixed(1)})` }); }
                else if (h1Rsi > 70) { h1Sell += 3; h1Signals.push({ tf: 'H1', name: 'RSI', vote: 'SELL', reason: `H1 Overbought (${h1Rsi.toFixed(1)})` }); }

                // H1 MACD
                if (h1Macd.histogram > 0) { h1Buy += 2; h1Signals.push({ tf: 'H1', name: 'MACD', vote: 'BUY', reason: 'H1 MACD positive' }); }
                else { h1Sell += 2; h1Signals.push({ tf: 'H1', name: 'MACD', vote: 'SELL', reason: 'H1 MACD negative' }); }

                // H1 Stochastic
                if (h1Stoch.k < 20) { h1Buy += 2; h1Signals.push({ tf: 'H1', name: 'Stoch', vote: 'BUY', reason: `H1 Stoch oversold (${h1Stoch.k.toFixed(1)})` }); }
                else if (h1Stoch.k > 80) { h1Sell += 2; h1Signals.push({ tf: 'H1', name: 'Stoch', vote: 'SELL', reason: `H1 Stoch overbought (${h1Stoch.k.toFixed(1)})` }); }

                // H1 Bollinger
                if (h1Bb && h1Current.c < h1Bb.lower) { h1Buy += 2; h1Signals.push({ tf: 'H1', name: 'BB', vote: 'BUY', reason: 'H1 below lower band' }); }
                else if (h1Bb && h1Current.c > h1Bb.upper) { h1Sell += 2; h1Signals.push({ tf: 'H1', name: 'BB', vote: 'SELL', reason: 'H1 above upper band' }); }
            }

            // =========================================================================
            // 3. M5 ENTRY SIGNALS - Weight 20% - Entry timing
            // =========================================================================
            let m5Buy = 0, m5Sell = 0;
            const m5Signals = [];

            // M5 Trend
            if (sma20 && sma50 && sma200) {
                if (current.c > sma20 && sma20 > sma50 && sma50 > sma200) {
                    m5Buy += 4; m5Signals.push({ tf: 'M5', name: 'Trend', vote: 'BUY', reason: 'Strong uptrend (Golden alignment)' });
                } else if (current.c < sma20 && sma20 < sma50 && sma50 < sma200) {
                    m5Sell += 4; m5Signals.push({ tf: 'M5', name: 'Trend', vote: 'SELL', reason: 'Strong downtrend (Death cross)' });
                } else if (current.c > sma50) {
                    m5Buy += 2; m5Signals.push({ tf: 'M5', name: 'Trend', vote: 'BUY', reason: 'Price above SMA50' });
                } else {
                    m5Sell += 2; m5Signals.push({ tf: 'M5', name: 'Trend', vote: 'SELL', reason: 'Price below SMA50' });
                }
            }

            // M5 RSI
            if (rsi < 30) { m5Buy += 4; m5Signals.push({ tf: 'M5', name: 'RSI', vote: 'BUY', reason: `Oversold (${rsi.toFixed(1)})` }); }
            else if (rsi > 70) { m5Sell += 4; m5Signals.push({ tf: 'M5', name: 'RSI', vote: 'SELL', reason: `Overbought (${rsi.toFixed(1)})` }); }
            else if (rsi < 45) { m5Buy += 1; m5Signals.push({ tf: 'M5', name: 'RSI', vote: 'BUY', reason: `Approaching oversold (${rsi.toFixed(1)})` }); }
            else if (rsi > 55) { m5Sell += 1; m5Signals.push({ tf: 'M5', name: 'RSI', vote: 'SELL', reason: `Approaching overbought (${rsi.toFixed(1)})` }); }

            // M5 MACD
            if (macd.histogram > 0) { m5Buy += 3; m5Signals.push({ tf: 'M5', name: 'MACD', vote: 'BUY', reason: 'Positive histogram' }); }
            else { m5Sell += 3; m5Signals.push({ tf: 'M5', name: 'MACD', vote: 'SELL', reason: 'Negative histogram' }); }

            // M5 Bollinger
            if (bb) {
                if (current.c < bb.lower) { m5Buy += 2; m5Signals.push({ tf: 'M5', name: 'Bollinger', vote: 'BUY', reason: 'Below lower band' }); }
                else if (current.c > bb.upper) { m5Sell += 2; m5Signals.push({ tf: 'M5', name: 'Bollinger', vote: 'SELL', reason: 'Above upper band' }); }
            }

            // M5 Stochastic
            if (stoch.k < 20) { m5Buy += 2; m5Signals.push({ tf: 'M5', name: 'Stochastic', vote: 'BUY', reason: `Oversold (${stoch.k.toFixed(1)})` }); }
            else if (stoch.k > 80) { m5Sell += 2; m5Signals.push({ tf: 'M5', name: 'Stochastic', vote: 'SELL', reason: `Overbought (${stoch.k.toFixed(1)})` }); }

            // Box Theory
            if (box && box.status === 'breakout-up') { m5Buy += 4; m5Signals.push({ tf: 'M5', name: 'Box Theory', vote: 'BUY', reason: 'Upward breakout' }); }
            else if (box && box.status === 'breakout-down') { m5Sell += 4; m5Signals.push({ tf: 'M5', name: 'Box Theory', vote: 'SELL', reason: 'Downward breakout' }); }

            // ADX
            if (adx > 25) {
                if (m5Buy > m5Sell) { m5Buy += 2; m5Signals.push({ tf: 'M5', name: 'ADX', vote: 'BUY', reason: `Strong trend (${adx.toFixed(1)})` }); }
                else { m5Sell += 2; m5Signals.push({ tf: 'M5', name: 'ADX', vote: 'SELL', reason: `Strong trend (${adx.toFixed(1)})` }); }
            }

            // Pivot Points
            if (current.c > pivots.r1) { m5Buy += 2; m5Signals.push({ tf: 'M5', name: 'Pivot', vote: 'BUY', reason: 'Above R1' }); }
            else if (current.c < pivots.s1) { m5Sell += 2; m5Signals.push({ tf: 'M5', name: 'Pivot', vote: 'SELL', reason: 'Below S1' }); }

            // =========================================================================
            // 4. NEWS SENTIMENT - Weight 10%
            // =========================================================================
            let newsBuy = 0, newsSell = 0;
            const newsSignals = [];

            if (news.length > 0) {
                let bullish = 0, bearish = 0;
                news.forEach(n => {
                    if (n.sentiment === 'bullish') bullish++;
                    else if (n.sentiment === 'bearish') bearish++;
                });

                const newsSentiment = bullish - bearish;
                if (newsSentiment > 2) {
                    newsBuy += 5; newsSignals.push({ tf: 'NEWS', name: 'Sentiment', vote: 'BUY', reason: `${bullish} bullish vs ${bearish} bearish articles` });
                } else if (newsSentiment < -2) {
                    newsSell += 5; newsSignals.push({ tf: 'NEWS', name: 'Sentiment', vote: 'SELL', reason: `${bearish} bearish vs ${bullish} bullish articles` });
                } else if (newsSentiment > 0) {
                    newsBuy += 2; newsSignals.push({ tf: 'NEWS', name: 'Sentiment', vote: 'BUY', reason: `Slightly bullish (${bullish}B/${bearish}S)` });
                } else if (newsSentiment < 0) {
                    newsSell += 2; newsSignals.push({ tf: 'NEWS', name: 'Sentiment', vote: 'SELL', reason: `Slightly bearish (${bearish}S/${bullish}B)` });
                }
            }

            // =========================================================================
            // 5. CALENDAR EVENTS - Weight 5% (high impact upcoming = caution)
            // =========================================================================
            let calBuy = 0, calSell = 0;
            const calSignals = [];

            // Helper to calculate gold sentiment for calendar events
            function getCalendarSentiment(event) {
                const e = (event.event || '').toLowerCase();
                const curr = event.currency || '';
                const impact = event.impact || 'low';
                let prob = impact === 'high' ? 75 : impact === 'medium' ? 55 : 40;
                let sentiment = 'neutral';

                if (e.includes('rate') || e.includes('fomc') || e.includes('ecb')) {
                    sentiment = curr === 'USD' ? 'bearish' : 'bullish';
                    prob = impact === 'high' ? 85 : 70;
                } else if (e.includes('cpi') || e.includes('inflation') || e.includes('ppi')) {
                    sentiment = 'bullish'; prob = impact === 'high' ? 80 : 65;
                } else if (e.includes('nonfarm') || e.includes('employment') || e.includes('jobless')) {
                    sentiment = curr === 'USD' ? 'bearish' : 'neutral'; prob = impact === 'high' ? 75 : 60;
                } else if (e.includes('gdp')) {
                    sentiment = curr === 'USD' ? 'bearish' : 'neutral'; prob = 65;
                } else if (e.includes('pmi') || e.includes('manufacturing')) {
                    sentiment = curr === 'USD' ? 'bearish' : 'neutral'; prob = 55;
                }
                return { sentiment, prob };
            }

            if (calendar.length > 0) {
                // Process high-impact events
                calendar.forEach(event => {
                    if (event.impact === 'high' || event.impact === 'medium') {
                        const { sentiment, prob } = getCalendarSentiment(event);
                        const weight = event.impact === 'high' ? 3 : 1;
                        if (sentiment === 'bullish') {
                            calBuy += weight; calSignals.push({ tf: 'CAL', name: (event.event || '').substring(0, 20), vote: 'BUY', reason: `${event.currency} event: ${prob}% bullish` });
                        } else if (sentiment === 'bearish') {
                            calSell += weight; calSignals.push({ tf: 'CAL', name: (event.event || '').substring(0, 20), vote: 'SELL', reason: `${event.currency} event: ${prob}% bearish` });
                        }
                    }
                });
            }

            // =========================================================================
            // WEIGHTED COMBINATION FOR 24H FORECAST
            // D1: 35%, H1: 30%, M5: 20%, News: 10%, Calendar: 5%
            // =========================================================================
            const d1Total = d1Buy + d1Sell || 1;
            const h1Total = h1Buy + h1Sell || 1;
            const m5Total = m5Buy + m5Sell || 1;
            const newsTotal = newsBuy + newsSell || 1;
            const calTotal = calBuy + calSell || 1;

            // Normalize each timeframe to 0-100
            const d1Score = ((d1Buy - d1Sell) / d1Total) * 100;  // -100 to +100
            const h1Score = ((h1Buy - h1Sell) / h1Total) * 100;
            const m5Score = ((m5Buy - m5Sell) / m5Total) * 100;
            const newsScore = ((newsBuy - newsSell) / newsTotal) * 100;
            const calScore = ((calBuy - calSell) / calTotal) * 100;

            // Weighted average
            const weights = { d1: 0.35, h1: 0.30, m5: 0.20, news: 0.10, cal: 0.05 };
            const combinedScore = (d1Score * weights.d1) + (h1Score * weights.h1) + (m5Score * weights.m5) + (newsScore * weights.news) + (calScore * weights.cal);

            // Convert to signal with HYSTERESIS (prevents flip-flopping)
            // Once in BUY/SELL, need stronger opposite score to flip
            let signal = 'HOLD', confidence = 50;
            const prevSig = _prevAnalysis ? _prevAnalysis.signal : null;
            const flipThreshold = prevSig === 'BUY' || prevSig === 'SELL' ? 30 : 20; // Higher bar to reverse
            const enterThreshold = 20; // Normal entry threshold

            if (combinedScore > enterThreshold) {
                // Want to go BUY - check if reversing from SELL
                if (prevSig === 'SELL' && combinedScore < flipThreshold) {
                    signal = 'HOLD'; // Not strong enough to flip yet
                    _signalHoldCount++;
                } else {
                    signal = 'BUY';
                    _signalHoldCount = 0;
                }
                confidence = Math.min(95, 50 + combinedScore / 2);
            } else if (combinedScore < -enterThreshold) {
                // Want to go SELL - check if reversing from BUY
                if (prevSig === 'BUY' && combinedScore > -flipThreshold) {
                    signal = 'HOLD'; // Not strong enough to flip yet
                    _signalHoldCount++;
                } else {
                    signal = 'SELL';
                    _signalHoldCount = 0;
                }
                confidence = Math.min(95, 50 + Math.abs(combinedScore) / 2);
            } else {
                confidence = 50 + Math.abs(combinedScore) / 4;
                _signalHoldCount = 0;
            }
            // If stuck in HOLD too long (6+ cycles = 30s), allow the flip
            if (_signalHoldCount >= 6 && signal === 'HOLD') {
                if (combinedScore > enterThreshold) { signal = 'BUY'; _signalHoldCount = 0; }
                else if (combinedScore < -enterThreshold) { signal = 'SELL'; _signalHoldCount = 0; }
            }

            // Confluence bonus - all timeframes agree
            const d1Dir = d1Buy > d1Sell ? 1 : d1Buy < d1Sell ? -1 : 0;
            const h1Dir = h1Buy > h1Sell ? 1 : h1Buy < h1Sell ? -1 : 0;
            const m5Dir = m5Buy > m5Sell ? 1 : m5Buy < m5Sell ? -1 : 0;

            let confluence = 0;
            if (d1Dir === h1Dir && h1Dir === m5Dir && d1Dir !== 0) {
                confluence = 10; // All 3 timeframes agree
                confidence = Math.min(95, confidence + 10);
            } else if ((d1Dir === h1Dir && d1Dir !== 0) || (h1Dir === m5Dir && h1Dir !== 0)) {
                confluence = 5; // 2 timeframes agree
                confidence = Math.min(95, confidence + 5);
            }

            // Combine all signals for display
            const signals = [...d1Signals, ...h1Signals, ...m5Signals, ...newsSignals, ...calSignals];
            const buyVotes = d1Buy + h1Buy + m5Buy + newsBuy + calBuy;
            const sellVotes = d1Sell + h1Sell + m5Sell + newsSell + calSell;

            const change = current.c - prev.c, changePct = (change / prev.c) * 100;

            // =========================================================================
            // FORWARD-LOOKING 24h PROGNOSIS
            // Uses H1 trend projection (slope) instead of just current price + ATR
            // =========================================================================
            const signalDirection = signal === 'BUY' ? 1 : signal === 'SELL' ? -1 : 0;

            // H1 trend slope: linear regression for forward projection
            // Try H1 bars first, fall back to M5-derived hourly closes
            let h1Slope = 0;
            if (barsH1.length >= 5) {
                const h1c = barsH1.slice(-10).map(b => b.c);
                const n = h1c.length;
                const xMean = (n - 1) / 2;
                const yMean = h1c.reduce((a, b) => a + b, 0) / n;
                let num = 0, den = 0;
                for (let i = 0; i < n; i++) { num += (i - xMean) * (h1c[i] - yMean); den += (i - xMean) ** 2; }
                h1Slope = den !== 0 ? num / den : 0; // EUR per H1 bar
            } else if (bars.length >= 48) {
                // Fallback: derive hourly closes from M5 bars (12 M5 = 1 hour)
                const hourlyCloses = [];
                for (let i = bars.length - 48; i < bars.length; i += 12) {
                    hourlyCloses.push(bars[Math.min(i + 11, bars.length - 1)].c);
                }
                if (hourlyCloses.length >= 3) {
                    const n = hourlyCloses.length;
                    const xMean = (n - 1) / 2;
                    const yMean = hourlyCloses.reduce((a, b) => a + b, 0) / n;
                    let num = 0, den = 0;
                    for (let i = 0; i < n; i++) { num += (i - xMean) * (hourlyCloses[i] - yMean); den += (i - xMean) ** 2; }
                    h1Slope = den !== 0 ? num / den : 0;
                }
            }

            // Project 24h forward: slope * 24 bars (H1), weighted by trend strength
            const h1TrendProject = h1Slope * 24 * (0.3 + Math.min(1, adx / 50) * 0.7);
            // ATR-based move component (scaled down - this is the "expected range" part)
            const atrMove = atr * (0.8 + (adx / 150)) * (confidence / 80);
            // Blend: 60% trend projection + 40% ATR-based signal move
            const rawTarget = current.c + (h1TrendProject * 0.6) + (signalDirection * atrMove * 0.4);

            // SMOOTHING: blend with previous target ‚Äî 50/50 for responsive but stable
            const SMOOTH = 0.50; // How much new data influences (higher = more responsive)
            const smoothedTarget = _smoothedTarget !== null ? _smoothedTarget * (1 - SMOOTH) + rawTarget * SMOOTH : rawTarget;
            _smoothedTarget = smoothedTarget;

            const rawProb = Math.min(90, 40 + (adx / 3) + (confidence - 50) / 2 + confluence);
            const smoothedProb = _smoothedProb !== null ? _smoothedProb * (1 - SMOOTH) + rawProb * SMOOTH : rawProb;
            _smoothedProb = smoothedProb;

            const smoothedConf = _smoothedConf !== null ? _smoothedConf * (1 - SMOOTH) + confidence * SMOOTH : confidence;
            _smoothedConf = smoothedConf;
            confidence = Math.round(smoothedConf);

            const prognosis = {
                low: signal === 'SELL' ? current.c - (atr * 2.5) : current.c - (atr * 1.2),
                target: smoothedTarget,
                high: signal === 'BUY' ? current.c + (atr * 2.5) : current.c + (atr * 1.2),
                probability: Math.round(smoothedProb)
            };

            const result = {
                signal, confidence, signals, current, prev, change, changePct, buyVotes, sellVotes,
                indicators: { sma20, sma50, sma200, ema12, ema26, rsi, macd, bb, stoch, atr, adx },
                box, fib, pivots, volatility, sharpe, maxDD, var95, prognosis,
                d1Rsi: d1RsiValue,
                bars: bars.slice(-200),  // Use full cached history for chart
                h1Slope: h1Slope, // H1 trend slope for forward projection
                // New multi-timeframe data
                mtf: {
                    d1: { buy: d1Buy, sell: d1Sell, score: d1Score, signals: d1Signals },
                    h1: { buy: h1Buy, sell: h1Sell, score: h1Score, signals: h1Signals },
                    m5: { buy: m5Buy, sell: m5Sell, score: m5Score, signals: m5Signals },
                    news: { buy: newsBuy, sell: newsSell, score: newsScore, signals: newsSignals },
                    cal: { buy: calBuy, sell: calSell, score: calScore, signals: calSignals },
                    combined: combinedScore,
                    confluence,
                    weights
                }
            };
            _prevAnalysis = result;
            return result;
        }

        // Compute rolling indicator history from M5 bars
        function computeM5History(bars) {
            if (!bars || bars.length < 20) return null;
            const closes = bars.map(b => b.c);
            const highs = bars.map(b => b.h);
            const lows = bars.map(b => b.l);
            const n = closes.length;
            const period = 14;
            const N = 20; // last 20 M5 bars to display

            // Rolling RSI
            const rsiArr = [];
            for (let i = period; i < n; i++) {
                let gain = 0, loss = 0;
                for (let j = i - period + 1; j <= i; j++) {
                    const diff = closes[j] - closes[j - 1];
                    if (diff > 0) gain += diff; else loss -= diff;
                }
                const ag = gain / period, al = loss / period;
                rsiArr.push(Math.max(0, Math.min(100, al === 0 ? 100 : 100 - 100 / (1 + ag / al))));
            }

            // Rolling Stochastic K (14-period)
            const stochArr = [];
            for (let i = period - 1; i < n; i++) {
                const hSlice = highs.slice(i - period + 1, i + 1);
                const lSlice = lows.slice(i - period + 1, i + 1);
                const hh = Math.max(...hSlice), ll = Math.min(...lSlice);
                stochArr.push(Math.max(0, Math.min(100, hh === ll ? 50 : ((closes[i] - ll) / (hh - ll)) * 100)));
            }

            // Rolling ADX (simplified: absolute price change % as trend strength proxy)
            const adxArr = [];
            for (let i = period; i < n; i++) {
                let sumMove = 0;
                for (let j = i - period + 1; j <= i; j++) {
                    sumMove += Math.abs(closes[j] - closes[j - 1]);
                }
                const range = Math.max(...highs.slice(i - period + 1, i + 1)) - Math.min(...lows.slice(i - period + 1, i + 1));
                adxArr.push(range > 0 ? Math.min(100, (sumMove / range) * 50) : 0);
            }

            // Rolling MACD histogram (EMA12 - EMA26)
            const ema = (data, p) => {
                const k = 2 / (p + 1);
                const result = [data[0]];
                for (let i = 1; i < data.length; i++) result.push(data[i] * k + result[i - 1] * (1 - k));
                return result;
            };
            const ema12 = ema(closes, 12), ema26 = ema(closes, 26);
            const macdLine = ema12.map((v, i) => v - ema26[i]);
            const macdSignal = ema(macdLine, 9);
            const macdHist = macdLine.map((v, i) => v - macdSignal[i]);

            // FIBO position (price within overall range)
            const allH = Math.max(...highs), allL = Math.min(...lows);
            const fiboRange = allH - allL;
            const fiboArr = closes.map(c => fiboRange > 0 ? ((c - allL) / fiboRange) * 100 : 50);

            // PIVOT / Box position (price within rolling 14-bar range)
            const pivotArr = [];
            for (let i = period - 1; i < n; i++) {
                const hSlice = highs.slice(i - period + 1, i + 1);
                const lSlice = lows.slice(i - period + 1, i + 1);
                const rng = Math.max(...hSlice) - Math.min(...lSlice);
                pivotArr.push(rng > 0 ? ((closes[i] - Math.min(...lSlice)) / rng) * 100 : 50);
            }

            // Confluence: count of bullish signals per bar
            const conflArr = [];
            for (let i = 0; i < N; i++) {
                const ri = rsiArr.length - N + i;
                const si = stochArr.length - N + i;
                const mi = macdHist.length - N + i;
                const ai = adxArr.length - N + i;
                if (ri < 0 || si < 0 || mi < 0 || ai < 0) { conflArr.push(0); continue; }
                let cnt = 0;
                if (rsiArr[ri] < 45) cnt++;
                if (stochArr[si] < 40) cnt++;
                if (macdHist[mi] > 0) cnt++;
                if (adxArr[ai] > 25) cnt++;
                conflArr.push(cnt * 25);
            }

            // Confidence proxy: combine RSI distance from 50 + ADX
            const confArr = [];
            for (let i = 0; i < N; i++) {
                const ri = rsiArr.length - N + i;
                const ai = adxArr.length - N + i;
                if (ri < 0 || ai < 0) { confArr.push(50); continue; }
                confArr.push(Math.min(100, 50 + Math.abs(rsiArr[ri] - 50) * 0.5 + adxArr[ai] * 0.3));
            }

            return {
                RSI: rsiArr.slice(-N),
                STOCH: stochArr.slice(-N),
                ADX: adxArr.slice(-N),
                MACD: macdHist.slice(-N).map(v => Math.min(100, Math.max(0, 50 + v * 10))),
                CONF: confArr,
                FIBO: fiboArr.slice(-N),
                PIVOT: pivotArr.slice(-N),
                CONFL: conflArr
            };
        }

        function drawGoogleCharts() {
            const d = window._lastGcData;
            if (!d) return;
            if (typeof google === 'undefined' || !google.visualization) {
                setTimeout(drawGoogleCharts, 200);
                return;
            }

            // Chart color constants
            const HIST_COLOR = '#00008B';  // Dark blue for history data
            const PRED_COLOR = '#00A1E4';  // Light blue for predictions

            // 1. Signal Line Chart ‚Äî HISTORY (dark blue, left) ‚Üí NOW ‚Üí FORECAST (light blue, right)
            const sigEl = document.getElementById('gcSignalLineChart');
            if (sigEl && d.signalHistory && d.signalHistory.length > 0) {
                const sh = d.signalHistory;
                const lastPt = sh[sh.length - 1];
                const last5 = sh.slice(-5);
                const last10 = sh.slice(-10);
                const priceSlope = last5.length >= 2 ? (last5[last5.length-1].price - last5[0].price) / last5.length : 0;
                const sigDir = d.signal === 'BUY' ? 1 : d.signal === 'SELL' ? -1 : 0;
                const accel = last10.length >= 6 ? (() => {
                    const mid = Math.floor(last10.length / 2);
                    const s1 = (last10[mid-1].price - last10[0].price) / mid;
                    const s2 = (last10[last10.length-1].price - last10[mid].price) / (last10.length - mid);
                    return (s2 - s1) * 0.5;
                })() : 0;

                // Build forecast: use the REAL 24h prognosis target from analyze()
                // Then bezier-curve toward it using momentum for natural shape
                const foreLen = sh.length;
                const predicted = [];
                const realTarget = d.forecast && d.forecast.length >= 4 ? d.forecast[3].price :
                                   d.currentPrice + priceSlope * 5; // fallback: modest extrapolation
                // Bezier from current ‚Üí target, with momentum shaping the curve path
                // CP1: continues recent momentum for first ~30% of curve (capped to ATR-scale)
                const atrScale = last10.length >= 2 ? (Math.max(...last10.map(p=>p.price)) - Math.min(...last10.map(p=>p.price))) * 0.5 : 1;
                const momentumCP = Math.max(-atrScale, Math.min(atrScale, priceSlope * 5 + accel * 8));
                const cp1 = lastPt.price + momentumCP;
                // CP2: 85% of the way to target (eases in smoothly)
                const cp2 = lastPt.price + (realTarget - lastPt.price) * 0.85;
                for (let p = 1; p <= foreLen; p++) {
                    const t = p / foreLen;
                    const t2 = t * t, t3 = t2 * t;
                    const mt = 1 - t, mt2 = mt * mt, mt3 = mt2 * mt;
                    predicted.push(mt3 * lastPt.price + 3 * mt2 * t * cp1 + 3 * mt * t2 * cp2 + t3 * realTarget);
                }

                // Timeline: history points ‚Üí NOW ‚Üí forecast points
                const sigData = new google.visualization.DataTable();
                sigData.addColumn('number', 'Point');
                sigData.addColumn('number', 'History');
                sigData.addColumn('number', 'Forecast');

                // History: left side (forecast = null)
                for (let i = 0; i < sh.length; i++) {
                    sigData.addRow([i, sh[i].price, null]);
                }
                // NOW: both lines connect
                sigData.addRow([sh.length, lastPt.price, lastPt.price]);
                // Forecast: right side (history = null)
                for (let i = 0; i < predicted.length; i++) {
                    sigData.addRow([sh.length + 1 + i, null, predicted[i]]);
                }

                new google.visualization.ComboChart(sigEl).draw(sigData, {
                    backgroundColor: '#141821',
                    legend: { position: 'top', textStyle: { color: '#94a3b8', fontSize: 10 } },
                    chartArea: { left: '8%', top: '10%', width: '88%', height: '80%', backgroundColor: '#141821' },
                    hAxis: { textStyle: { color: '#64748b', fontSize: 9 }, gridlines: { color: '#252d3a', count: 8 }, minorGridlines: { color: 'transparent' }, baselineColor: '#252d3a' },
                    vAxis: { textStyle: { color: '#64748b', fontSize: 9 }, gridlines: { color: '#252d3a', count: 4 }, minorGridlines: { color: 'transparent' }, baselineColor: '#252d3a' },
                    curveType: 'function',
                    interpolateNulls: false,
                    series: {
                        0: { type: 'line', color: PRED_COLOR, lineWidth: 2, pointSize: 0, lineDashStyle: [6, 3] },
                        1: { type: 'line', color: PRED_COLOR, lineWidth: 2, pointSize: 0 }
                    },
                    crosshair: { trigger: 'both', orientation: 'vertical', color: '#fff', opacity: 0.15 },
                    focusTarget: 'category'
                });
            }

            // 2. (Signal Strength is now pure HTML/CSS, no Google Chart needed)

            // 3. H1 Chart ‚Äî 4H HISTORY (dark blue left) + NOW + 4H FORECAST (light blue right)
            // Timeline: -4h ... -3h ... -2h ... -1h ... NOW ... +1h ... +2h ... +3h ... +4h
            // 33 points at 15-min intervals: 16 history + NOW + 16 forecast
            const fcEl = document.getElementById('gcForecastChart');
            if (fcEl) {
                const allBars = d.bars || [];
                const nowPrice = d.currentPrice || (allBars.length > 0 ? allBars[allBars.length - 1].c : 0);
                const fc = d.forecast || [];

                // HISTORY: 16 points from -4h to -15min (every 15min = 3 M5 bars)
                const totalM5 = allBars.length;
                const histPrices = [];
                for (let q = 16; q >= 1; q--) {
                    const idx = totalM5 - q * 3;
                    histPrices.push(idx >= 0 && idx < totalM5 ? allBars[idx].c : nowPrice);
                }

                // FORECAST: use REAL server h1Forecast values, interpolated with Catmull-Rom
                // fc[] has 4 hourly points from analyze() ‚Äî grounded in RSI, MACD, ADX, BB, regression
                const forePrices = [];
                if (fc.length >= 4) {
                    // 5 anchor points: NOW + 4 hourly forecasts (real indicator-based values)
                    const pts = [nowPrice, fc[0].price, fc[1].price, fc[2].price, fc[3].price];
                    // Catmull-Rom spline: interpolate 4 hours into 16 quarter-hour points
                    for (let q = 1; q <= 16; q++) {
                        const hourF = q / 4; // 0.25 to 4.0
                        const si = Math.min(Math.floor(hourF), 3);
                        const t = hourF - si;
                        const t2 = t * t, t3 = t2 * t;
                        const p0 = pts[si];
                        const p1 = pts[si + 1];
                        const pm1 = si > 0 ? pts[si - 1] : 2 * p0 - p1;
                        const p2 = si + 2 < pts.length ? pts[si + 2] : 2 * p1 - p0;
                        forePrices.push(0.5 * ((2*p0) + (-pm1+p1)*t + (2*pm1-5*p0+4*p1-p2)*t2 + (-pm1+3*p0-3*p1+p2)*t3));
                    }
                } else if (fc.length >= 1) {
                    // Fewer points: simple bezier to last available forecast
                    const target = fc[fc.length - 1].price;
                    for (let q = 1; q <= 16; q++) {
                        const t = q / 16;
                        forePrices.push(nowPrice + (target - nowPrice) * (3*t*t - 2*t*t*t)); // smooth step
                    }
                }

                // Build data table: 33 rows = 16 history + 1 NOW + 16 forecast
                // History line has values left of NOW + NOW point, null after
                // Forecast line has null before NOW, NOW point + values right of NOW
                const fcData = new google.visualization.DataTable();
                fcData.addColumn('string', 'Time');
                fcData.addColumn('number', 'History');
                fcData.addColumn('number', 'Forecast');

                // History points: -4h to -15min
                for (let q = 16; q >= 1; q--) {
                    const mins = q * 15;
                    const h = Math.floor(mins / 60);
                    const m = mins % 60;
                    const label = '-' + (m === 0 ? h + 'h' : h > 0 ? h + 'h' + m : m + 'm');
                    fcData.addRow([label, histPrices[16 - q], null]);
                }

                // NOW point: both lines connect here
                fcData.addRow(['NOW', nowPrice, nowPrice]);

                // Forecast points: +15min to +4h
                for (let q = 0; q < 16; q++) {
                    const mins = (q + 1) * 15;
                    const h = Math.floor(mins / 60);
                    const m = mins % 60;
                    const label = '+' + (m === 0 ? h + 'h' : h > 0 ? h + 'h' + m : m + 'm');
                    fcData.addRow([label, null, q < forePrices.length ? forePrices[q] : null]);
                }

                new google.visualization.ComboChart(fcEl).draw(fcData, {
                    backgroundColor: '#141821',
                    legend: { position: 'top', textStyle: { color: '#94a3b8', fontSize: 9 } },
                    chartArea: { left: '10%', top: '12%', width: '86%', height: '75%', backgroundColor: '#141821' },
                    hAxis: { textStyle: { color: '#64748b', fontSize: 8 }, gridlines: { color: '#252d3a' }, minorGridlines: { color: 'transparent' }, baselineColor: '#252d3a', showTextEvery: 4, slantedText: false },
                    vAxis: { textStyle: { color: '#64748b', fontSize: 9 }, gridlines: { color: '#252d3a', count: 4 }, minorGridlines: { color: 'transparent' }, baselineColor: '#252d3a', format: '#' },
                    curveType: 'function',
                    interpolateNulls: false,  // Lines stop at null = history ends at NOW, forecast starts at NOW
                    series: {
                        0: { type: 'line', color: PRED_COLOR, lineWidth: 2, pointSize: 0, lineDashStyle: [6, 3] },
                        1: { type: 'line', color: PRED_COLOR, lineWidth: 2, pointSize: 0 }
                    },
                    crosshair: { trigger: 'both', orientation: 'vertical', color: '#fff', opacity: 0.15 },
                    focusTarget: 'category'
                });
            }

            // 4. Individual Indicator Line Charts ‚Äî grey history + colored prediction
            const history = computeM5History(d.bars);
            if (!history) return;

            const indNames = ['RSI', 'STOCH', 'ADX', 'MACD', 'CONF', 'FIBO', 'PIVOT', 'CONFL'];
            const indMeta = {
                RSI:   { min: 0, max: 100 },
                STOCH: { min: 0, max: 100 },
                ADX:   { min: 0, max: 80  },
                MACD:  { min: 0, max: 100 },
                CONF:  { min: 0, max: 100 },
                FIBO:  { min: 0, max: 100 },
                PIVOT: { min: 0, max: 100 },
                CONFL: { min: 0, max: 100 }
            };

            indNames.forEach(name => {
                const el = document.getElementById('gcInd_' + name);
                if (!el) return;
                const vals = history[name];
                if (!vals || vals.length === 0) return;
                const meta = indMeta[name];
                const color = PRED_COLOR; // All indicator forecasts use prediction color

                const lastVal = vals[vals.length - 1];
                const last5 = vals.slice(-5);
                const last10 = vals.slice(-10);
                const slope = last5.length >= 2 ? (last5[last5.length - 1] - last5[0]) / last5.length : 0;
                const indAccel = last10.length >= 6 ? (() => {
                    const mid = Math.floor(last10.length / 2);
                    const s1 = (last10[mid - 1] - last10[0]) / mid;
                    const s2 = (last10[last10.length - 1] - last10[mid]) / (last10.length - mid);
                    return (s2 - s1) * 0.3;
                })() : 0;
                const meanVal = (name === 'RSI' || name === 'STOCH') ? 50 :
                                (name === 'ADX') ? 25 : (meta.min + meta.max) / 2;

                // Build forecast: realistic mean-reversion with capped momentum
                const foreLen = Math.max(8, Math.round(vals.length * 0.5));
                const predicted = [];
                // Target: partial reversion toward mean (not 80% ‚Äî too aggressive)
                // Oscillators like RSI/STOCH revert ~30-50% toward mean over forecast horizon
                const distFromMean = lastVal - meanVal;
                const reversionPct = (name === 'RSI' || name === 'STOCH') ? 0.4 : 0.25;
                const targetVal = lastVal - distFromMean * reversionPct;
                // CP1: continue momentum briefly, but cap to realistic range (max 1 ATR-equivalent)
                const maxMomentum = (meta.max - meta.min) * 0.08; // max 8% of indicator range
                const cappedSlope = Math.max(-maxMomentum, Math.min(maxMomentum, slope * 3));
                const cp1 = Math.max(meta.min, Math.min(meta.max, lastVal + cappedSlope));
                // CP2: ease toward target
                const cp2 = lastVal + (targetVal - lastVal) * 0.8;
                for (let p = 1; p <= foreLen; p++) {
                    const t = p / foreLen;
                    const t2 = t * t, t3 = t2 * t;
                    const mt = 1 - t, mt2 = mt * mt, mt3 = mt2 * mt;
                    let pv = mt3 * lastVal + 3 * mt2 * t * cp1 + 3 * mt * t2 * cp2 + t3 * targetVal;
                    pv = Math.max(meta.min, Math.min(meta.max, pv));
                    predicted.push(pv);
                }

                // Timeline: history left ‚Üí NOW ‚Üí forecast right
                const indData = new google.visualization.DataTable();
                indData.addColumn('number', 'Point');
                indData.addColumn('number', 'History');
                indData.addColumn('number', 'Forecast');

                // History (left side)
                for (let i = 0; i < vals.length; i++) {
                    indData.addRow([i, vals[i], null]);
                }
                // NOW: both connect
                indData.addRow([vals.length, lastVal, lastVal]);
                // Forecast (right side)
                for (let i = 0; i < predicted.length; i++) {
                    indData.addRow([vals.length + 1 + i, null, predicted[i]]);
                }

                new google.visualization.ComboChart(el).draw(indData, {
                    backgroundColor: '#141821',
                    legend: 'none',
                    curveType: 'function',  // Smooth curves
                    chartArea: { left: 0, top: 0, width: '100%', height: '100%', backgroundColor: '#141821' },
                    hAxis: { textPosition: 'none', gridlines: { color: 'transparent' }, minorGridlines: { color: 'transparent' }, baselineColor: 'transparent' },
                    vAxis: { minValue: meta.min, maxValue: meta.max, textPosition: 'none', gridlines: { color: 'transparent' }, minorGridlines: { color: 'transparent' }, baselineColor: 'transparent' },
                    series: {
                        0: { type: 'line', color: PRED_COLOR, lineWidth: 1.5, pointSize: 0, lineDashStyle: [4, 2] },
                        1: { type: 'line', color: PRED_COLOR, lineWidth: 1.5, pointSize: 0 }
                    },
                    interpolateNulls: false,
                    enableInteractivity: false
                });
            });
        }

        function drawChart(bars, box, fib) {
            const canvas = document.getElementById('priceChart');
            if (!canvas) return;
            const ctx = canvas.getContext('2d');
            const W = canvas.width = canvas.offsetWidth, H = canvas.height = 220;
            ctx.fillStyle = '#1a1a1a'; ctx.fillRect(0, 0, W, H);

            const pad = { top: 15, bottom: 25, left: 45, right: 15 };
            const chartW = W - pad.left - pad.right, chartH = H - pad.top - pad.bottom;
            const maxP = Math.max(...bars.map(b => b.h)), minP = Math.min(...bars.map(b => b.l));
            const range = maxP - minP;
            const barW = chartW / bars.length, candleW = Math.max(barW * 0.6, 2);
            const scaleY = (p) => pad.top + chartH - ((p - minP) / range) * chartH;

            // Box zone
            if (box) {
                ctx.fillStyle = 'rgba(0, 102, 204, 0.08)';
                ctx.fillRect(pad.left, scaleY(box.boxHigh), chartW, scaleY(box.boxLow) - scaleY(box.boxHigh));
                ctx.strokeStyle = 'rgba(0, 102, 204, 0.4)'; ctx.setLineDash([4, 4]);
                ctx.beginPath();
                ctx.moveTo(pad.left, scaleY(box.boxHigh)); ctx.lineTo(W - pad.right, scaleY(box.boxHigh));
                ctx.moveTo(pad.left, scaleY(box.boxLow)); ctx.lineTo(W - pad.right, scaleY(box.boxLow));
                ctx.stroke(); ctx.setLineDash([]);
            }

            // Fib levels
            if (fib) {
                ctx.strokeStyle = 'rgba(156, 39, 176, 0.3)';
                [0.382, 0.5, 0.618].forEach(level => {
                    const y = scaleY(fib[level]);
                    ctx.beginPath(); ctx.moveTo(pad.left, y); ctx.lineTo(W - pad.right, y); ctx.stroke();
                });
            }

            // Candles ‚Äî dark blue (#00008B) for bullish, dimmed for bearish
            bars.forEach((bar, i) => {
                const x = pad.left + (i * barW) + (barW / 2);
                const isUp = bar.c >= bar.o;
                ctx.strokeStyle = ctx.fillStyle = isUp ? '#00008B' : '#003366';
                ctx.beginPath(); ctx.moveTo(x, scaleY(bar.h)); ctx.lineTo(x, scaleY(bar.l)); ctx.stroke();
                ctx.fillRect(x - candleW/2, Math.min(scaleY(bar.o), scaleY(bar.c)), candleW, Math.abs(scaleY(bar.o) - scaleY(bar.c)) || 1);
            });

            // Y-axis
            ctx.fillStyle = '#808080'; ctx.font = '9px sans-serif';
            for (let i = 0; i <= 4; i++) {
                const p = minP + (range * (i / 4)), y = scaleY(p);
                ctx.fillText(p.toFixed(2), 3, y + 3);
                ctx.strokeStyle = 'rgba(255,255,255,0.05)'; ctx.beginPath();
                ctx.moveTo(pad.left, y); ctx.lineTo(W - pad.right, y); ctx.stroke();
            }
        }

        function renderDashboard(data) {
            const a = analyze(data);
            analysis = a;
            const sc = a.signal.toLowerCase();
            const changeSign = a.change >= 0 ? '+' : '';

            document.getElementById('livePrice').textContent = data.bid.toFixed(2);
            document.getElementById('livePrice').style.color = a.change >= 0 ? 'var(--success)' : 'var(--danger)';
            document.getElementById('priceChange').textContent = `${changeSign}${a.change.toFixed(2)} (${changeSign}${a.changePct.toFixed(2)}%)`;
            document.getElementById('priceChange').className = `price-change ${a.change >= 0 ? 'up' : 'down'}`;

            // Risk level calculation
            const riskLevel = a.confidence >= 75 ? 'LOW' : a.confidence >= 60 ? 'MEDIUM' : 'HIGH';
            const riskColor = a.confidence >= 75 ? 'var(--success)' : a.confidence >= 60 ? 'var(--warning)' : 'var(--danger)';
            const oppScore = Math.round((a.confidence + a.prognosis.probability) / 2);

            // M5 Bar Prediction - Next 5 minute candle forecast
            // ATR is already calculated on M5 bars (144 period = 12h window) ‚Äî use directly
            const m5Atr = a.indicators.atr;
            const momentum = (a.indicators.rsi - 50) / 50; // -1 to +1

            // Short-term momentum velocity: rate of change over last 3 bars
            const recentBars = a.bars.slice(-6);
            let momentumVelocity = 0;
            if (recentBars.length >= 3) {
                const last3Closes = recentBars.slice(-3).map(b => b.c);
                const prev3Closes = recentBars.slice(0, 3).map(b => b.c);
                const last3Avg = last3Closes.reduce((a, b) => a + b, 0) / last3Closes.length;
                const prev3Avg = prev3Closes.reduce((a, b) => a + b, 0) / prev3Closes.length;
                momentumVelocity = (last3Avg - prev3Avg) / m5Atr; // Normalized by ATR
            }

            const trendStrength = Math.min(1, a.indicators.adx / 60); // 0 to 1 (60+ = max strength)

            // Signal direction weighted by momentum velocity for consistency
            const signalDir = a.signal === 'BUY' ? 1 : a.signal === 'SELL' ? -1 : 0;
            const velocityDir = momentumVelocity > 0.1 ? 1 : momentumVelocity < -0.1 ? -1 : 0;

            // m5Direction: blend signal (40%), momentum (30%), velocity (30%)
            const m5Direction = (signalDir * 0.4) + (momentum * 0.3) + (velocityDir * 0.3);

            // Predict next M5 bar move (ATR is the expected range for one M5 bar)
            const m5Move = m5Atr * m5Direction * (0.3 + trendStrength * 0.7);
            const m5Predict = {
                open: data.bid,
                high: data.bid + m5Atr * (m5Direction >= 0 ? 1.0 : 0.3),
                low: data.bid - m5Atr * (m5Direction <= 0 ? 1.0 : 0.3),
                close: data.bid + m5Move,
                // Probability: signal confidence (40%) + momentum alignment (30%) + velocity (30%)
                bullProb: 50,
                bearProb: 50
            };

            // Calculate probability from multiple factors (no contradictions)
            const signalComponent = (a.signal === 'BUY' ? 20 : a.signal === 'SELL' ? -20 : 0);
            const momentumComponent = momentum * 15;
            const velocityComponent = Math.max(-15, Math.min(15, momentumVelocity * 30));
            // Confluence: when all agree, boost; when they contradict, reduce to near 50%
            const allAgree = (signalDir >= 0 && momentum >= 0 && velocityDir >= 0) ||
                             (signalDir <= 0 && momentum <= 0 && velocityDir <= 0);
            const confluenceBonus = allAgree ? 5 : -5;

            m5Predict.bullProb = Math.round(50 + signalComponent + momentumComponent + velocityComponent + confluenceBonus);
            m5Predict.bullProb = Math.max(10, Math.min(90, m5Predict.bullProb));
            m5Predict.bearProb = 100 - m5Predict.bullProb;

            // Store velocity for display
            m5Predict.velocity = Math.round(momentumVelocity * 100) / 100;
            m5Predict.velocityDir = momentumVelocity > 0.1 ? 'ACCELERATING' : momentumVelocity < -0.1 ? 'DECELERATING' : 'STEADY';

            // M5 Risk calculation
            const m5Risk = Math.abs(m5Atr / data.bid * 100);
            const m5RiskLevel = m5Risk < 0.05 ? 'LOW' : m5Risk < 0.1 ? 'MEDIUM' : 'HIGH';
            const m5RiskColor = m5Risk < 0.05 ? 'var(--success)' : m5Risk < 0.1 ? 'var(--warning)' : 'var(--danger)';

            // Calculate overall score
            const overallScore = Math.round((a.confidence + a.prognosis.probability + (100 - a.var95 * 10)) / 3);

            // Store chart data for Google Charts rendering
            // =========================================================================
            // H1 FORWARD FORECAST: predict next 4 hours
            // REAL indicator-driven forecast ‚Äî each hour shaped by RSI, MACD, ADX, BB, Stoch
            // Each hour gets its own indicator profile, not a linear extrapolation
            // =========================================================================
            const h1Atr = a.indicators.atr;
            const h1Rsi = a.indicators.rsi;
            const h1Adx = a.indicators.adx;
            const h1MacdHist = a.indicators.macd.histogram;
            const h1StochK = a.indicators.stoch.k;

            // PRIMARY: H1 trend slope from regression
            const h1SlopeDir = a.h1Slope || 0;

            // === INDICATOR-BASED DIRECTIONAL FORCES ===
            // Each indicator contributes independently ‚Äî they create the curve shape

            // 1. RSI: mean-reversion force ‚Äî gets STRONGER at extremes
            //    RSI 80+ ‚Üí strong pullback expected (bearish force)
            //    RSI 20- ‚Üí strong bounce expected (bullish force)
            //    RSI 40-60 ‚Üí neutral, trend continues
            const rsiForce = h1Rsi > 75 ? -(h1Rsi - 50) / 50 * 1.5 :  // Overbought pullback
                             h1Rsi < 25 ? (50 - h1Rsi) / 50 * 1.5 :    // Oversold bounce
                             (h1Rsi - 50) / 50;                          // Normal momentum

            // 2. MACD: trend continuation/reversal ‚Äî histogram direction + magnitude
            const macdForce = Math.max(-1.5, Math.min(1.5, h1MacdHist * 3));

            // 3. Stochastic: timing signal for reversals
            const stochForce = h1StochK > 80 ? -(h1StochK - 50) / 50 :
                               h1StochK < 20 ? (50 - h1StochK) / 50 :
                               (h1StochK - 50) / 100;

            // 4. ADX: how CONFIDENT we are in the trend direction
            const trendConf = Math.min(1, h1Adx / 50); // 0-1 (50+ ADX = max confidence)

            // 5. Bollinger: mean reversion + volatility squeeze/expansion
            const bbWidth = a.indicators.bb ? (a.indicators.bb.upper - a.indicators.bb.lower) : h1Atr * 2;
            const bbPos = a.indicators.bb ? (data.bid - a.indicators.bb.lower) / (bbWidth || 1) : 0.5;
            const bbForce = bbPos > 0.85 ? -(bbPos - 0.5) * 1.2 :  // Near upper band: expect pullback
                            bbPos < 0.15 ? (0.5 - bbPos) * 1.2 :    // Near lower band: expect bounce
                            (bbPos - 0.5) * 0.3;                     // Middle: slight trend continuation

            // 6. Signal direction with confidence
            const sigForce = (a.signal === 'BUY' ? 1 : a.signal === 'SELL' ? -1 : 0) * (a.confidence / 100);

            // === BUILD 4-HOUR FORECAST WITH HOUR-BY-HOUR INDICATOR EVOLUTION ===
            const h1Forecast = [];
            let cumulativeMove = 0;

            for (let h = 1; h <= 4; h++) {
                // Each hour: indicators have different effects over time
                // Hour 1: momentum dominates (MACD, slope, signal)
                // Hour 2-3: mean reversion kicks in (RSI, BB, Stoch)
                // Hour 4: uncertainty grows, pull toward mean

                const momentumWeight = Math.max(0.2, 1.0 - h * 0.2);   // 0.8, 0.6, 0.4, 0.2
                const reversionWeight = Math.min(0.8, h * 0.2);         // 0.2, 0.4, 0.6, 0.8

                // Momentum component: slope + MACD + signal (continuation)
                const momentumDir = (h1SlopeDir * 0.35 + macdForce * h1Atr * 0.35 + sigForce * h1Atr * 0.30);

                // Reversion component: RSI + BB + Stoch (reversal)
                const reversionDir = (rsiForce * h1Atr * 0.40 + bbForce * h1Atr * 0.35 + stochForce * h1Atr * 0.25);

                // Blend: early hours favor momentum, later hours favor reversion
                const hourMove = (momentumDir * momentumWeight + reversionDir * reversionWeight) * trendConf;

                // Diminishing returns per hour (uncertainty grows)
                const decay = Math.pow(0.88, h - 1);
                const scaledMove = hourMove * decay;

                cumulativeMove += scaledMove;

                const rawPrice = data.bid + cumulativeMove;

                // Light smoothing (50/50) ‚Äî enough to prevent jumps, not enough to kill the curve
                let predicted = rawPrice;
                if (_smoothedH1 && _smoothedH1[h - 1]) {
                    predicted = _smoothedH1[h - 1].price * 0.45 + rawPrice * 0.55; // 55% new data wins
                }

                // Confidence per hour: based on indicator agreement + trend strength
                const agreement = Math.abs(Math.sign(rsiForce) + Math.sign(macdForce) + Math.sign(stochForce) + Math.sign(sigForce)) / 4;
                const prob = Math.round(Math.max(20, Math.min(85,
                    30 + trendConf * 25 + agreement * 30 * decay
                )));

                h1Forecast.push({
                    hour: h,
                    price: predicted,
                    change: predicted - data.bid,
                    direction: predicted > data.bid ? 'UP' : 'DOWN',
                    probability: prob,
                    // Debug: show what's driving each hour
                    drivers: {
                        momentum: Math.round(momentumDir * momentumWeight * 100) / 100,
                        reversion: Math.round(reversionDir * reversionWeight * 100) / 100,
                        rsi: Math.round(h1Rsi),
                        macd: Math.round(h1MacdHist * 1000) / 1000,
                        stochK: Math.round(h1StochK),
                        adx: Math.round(h1Adx),
                        bbPos: Math.round(bbPos * 100)
                    }
                });
            }
            _smoothedH1 = h1Forecast;

            // Compute rolling signal score from M5 bars for line chart
            // Signal score: +100 = strong buy, -100 = strong sell, 0 = hold
            const signalHistory = [];
            if (a.bars && a.bars.length >= 30) {
                const closes = a.bars.map(b => b.c);
                const highs = a.bars.map(b => b.h);
                const lows = a.bars.map(b => b.l);
                const n = closes.length;
                const N = 30; // last 30 M5 bars
                for (let i = n - N; i < n; i++) {
                    if (i < 14) { signalHistory.push({ price: closes[i], score: 0 }); continue; }
                    // Mini RSI
                    let gain = 0, loss = 0;
                    for (let j = i - 13; j <= i; j++) { const d2 = closes[j] - closes[j-1]; if (d2 > 0) gain += d2; else loss -= d2; }
                    const ag = gain / 14, al = loss / 14;
                    const rsi = al === 0 ? 100 : 100 - 100 / (1 + ag / al);
                    // Mini MACD
                    const ema12v = closes.slice(Math.max(0, i-11), i+1).reduce((s,v) => s + v, 0) / Math.min(12, i+1);
                    const ema26v = closes.slice(Math.max(0, i-25), i+1).reduce((s,v) => s + v, 0) / Math.min(26, i+1);
                    const macd = ema12v - ema26v;
                    // Mini Stoch
                    const hSlice = highs.slice(Math.max(0, i-13), i+1);
                    const lSlice = lows.slice(Math.max(0, i-13), i+1);
                    const hh = Math.max(...hSlice), ll = Math.min(...lSlice);
                    const stoch = hh === ll ? 50 : ((closes[i] - ll) / (hh - ll)) * 100;
                    // Combined signal: -100 to +100
                    const rsiSig = (rsi - 50) * 2; // -100 to +100
                    const macdSig = Math.max(-100, Math.min(100, macd * 20));
                    const stochSig = (stoch - 50) * 2;
                    const score = Math.round(rsiSig * 0.4 + macdSig * 0.35 + stochSig * 0.25);
                    signalHistory.push({ price: closes[i], score: Math.max(-100, Math.min(100, score)) });
                }
            }

            const _gcData = {
                confidence: a.confidence,
                signal: a.signal,
                forecast: h1Forecast,
                currentPrice: data.bid,
                signalHistory: signalHistory,
                wins: data.server_signal?.backtest?.wins || 0,
                losses: data.server_signal?.backtest?.losses || 0,
                pending: data.server_signal?.backtest?.pending || 0,
                winRate: data.server_signal?.backtest?.win_rate || 0,
                buyRate: data.server_signal?.backtest?.buy_rate || 0,
                sellRate: data.server_signal?.backtest?.sell_rate || 0,
                total: data.server_signal?.backtest?.total || 0,
                hours: data.momentum_1h?.hours || [],
                bars: a.bars || [],
                fib: a.fib,
                box: a.box,
                indicators: {
                    RSI: { value: a.indicators.rsi, color: a.indicators.rsi < 30 ? '#c0c8d4' : a.indicators.rsi > 70 ? '#7c8594' : '#67b8d4' },
                    STOCH: { value: a.indicators.stoch.k, color: a.indicators.stoch.k < 20 ? '#c0c8d4' : a.indicators.stoch.k > 80 ? '#7c8594' : '#94a3b8' },
                    ADX: { value: a.indicators.adx, color: a.indicators.adx > 25 ? '#c0c8d4' : '#94a3b8' },
                    MACD: { value: Math.min(100, Math.max(0, 50 + a.indicators.macd.histogram * 10)), color: a.indicators.macd.histogram > 0 ? '#c0c8d4' : '#7c8594', label: a.indicators.macd.histogram.toFixed(1) },
                    CONF: { value: a.confidence, color: a.confidence > 60 ? '#67b8d4' : '#a0a8b4' },
                    FIBO: { value: a.fib && a.fib.range > 0 ? Math.round((data.bid - a.fib.low) / a.fib.range * 100) : 0, color: '#67b8d4', label: a.fib && a.fib.range > 0 ? Math.round((data.bid - a.fib.low) / a.fib.range * 100) + '%' : 'N/A' },
                    PIVOT: { value: a.box ? Math.round(a.box.position) : 0, color: '#7c8594', label: a.box ? Math.round(a.box.position) + '%' : 'N/A' },
                    CONFL: { value: [a.signal === 'BUY' ? 1 : 0, a.indicators.rsi < 40 ? 1 : 0, a.indicators.macd.histogram > 0 ? 1 : 0, a.indicators.adx > 25 ? 1 : 0].reduce((s,v)=>s+v,0) * 25, color: a.signal === 'BUY' ? '#c0c8d4' : a.signal === 'SELL' ? '#7c8594' : '#94a3b8', label: [a.signal === 'BUY' ? 1 : 0, a.indicators.rsi < 40 ? 1 : 0, a.indicators.macd.histogram > 0 ? 1 : 0, a.indicators.adx > 25 ? 1 : 0].reduce((s,v)=>s+v,0) + '/4' }
                }
            };
            window._lastGcData = _gcData;

            let html = `
                <!-- ROW 1: SIGNAL LINE CHART + SESSION + RELIABILITY -->
                <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 15px; margin-bottom: 15px;">
                    <!-- Main Signal - Line Chart -->
                    <div class="card" style="cursor: pointer; padding: 15px; display: flex; flex-direction: column;" onclick="showSection('prognosis', this)">
                        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 8px;">
                            <div style="font-size: 10px; color: var(--text-secondary); text-transform: uppercase; letter-spacing: 1px;">Main Signal ‚Äî M5 History + Forecast ‚Äî ${String(new Date().getDate()).padStart(2,'0')}/${String(new Date().getMonth()+1).padStart(2,'0')}</div>
                            <div style="display: flex; align-items: center; gap: 10px;">
                                <span style="font-size: 24px; font-weight: 800; color: ${a.signal === 'BUY' ? 'var(--success)' : a.signal === 'SELL' ? 'var(--danger)' : 'var(--warning)'};">${a.signal}</span>
                                <span style="font-size: 13px; color: var(--text-secondary);">${a.confidence.toFixed(0)}%</span>
                            </div>
                        </div>
                        <div id="gcSignalLineChart" style="width: 100%; flex: 1; min-height: 200px;"></div>
                        ${data.server_signal?.reasons?.length > 0 ? `
                        <div style="display: flex; gap: 6px; flex-wrap: wrap; margin-top: 8px;">
                            ${data.server_signal.reasons.map(r => `<span style="background: ${a.signal === 'BUY' ? 'rgba(192,200,212,0.12)' : a.signal === 'SELL' ? 'rgba(124,133,148,0.12)' : 'rgba(160,168,180,0.12)'}; padding: 2px 8px; border-radius: 10px; font-size: 10px; color: var(--text-secondary);">${r}</span>`).join('')}
                        </div>` : ''}
                    </div>

                    <!-- Right column: Session + Reliability stacked -->
                    <div style="display: flex; flex-direction: column; gap: 15px;">

                    <!-- Session & Action -->
                    <div class="card" style="padding: 15px;">
                        ${(() => {
                            const now = new Date();
                            const amsHour = now.getHours();
                            const amsMin = now.getMinutes();
                            const timeDecimal = amsHour + amsMin/60;
                            const isDST = now.getMonth() > 2 && now.getMonth() < 10;
                            const serverOffset = isDST ? 2 : 1;
                            const serverHour = (amsHour + serverOffset) % 24;
                            const dubaiH = (amsHour + 3) % 24;

                            let session = 'CLOSED', sessionColor = 'var(--grey-text)', isOptimal = false, optimalReason = '';
                            if (timeDecimal >= 1 && timeDecimal < 8) { session = 'ASIAN'; sessionColor = 'var(--purple)'; }
                            else if (timeDecimal >= 8 && timeDecimal < 12) { session = 'LONDON'; sessionColor = 'var(--cyan)'; if (timeDecimal >= 9 && timeDecimal < 10) { isOptimal = true; optimalReason = 'London Open'; } }
                            else if (timeDecimal >= 12 && timeDecimal < 14.5) { session = 'LONDON'; sessionColor = 'var(--cyan)'; }
                            else if (timeDecimal >= 14.5 && timeDecimal < 18) { session = 'US/LONDON'; sessionColor = 'var(--success)'; if (timeDecimal >= 15 && timeDecimal < 16) { isOptimal = true; optimalReason = 'US/London Overlap'; } else if (timeDecimal >= 16.5 && timeDecimal < 17.5) { isOptimal = true; optimalReason = 'US Peak'; } }
                            else if (timeDecimal >= 18 && timeDecimal < 22) { session = 'US'; sessionColor = 'var(--warning)'; }

                            let nextOptimal = '', minsToNext = 0;
                            if (timeDecimal < 9) { minsToNext = Math.round((9 - timeDecimal) * 60); nextOptimal = '09:00 London'; }
                            else if (timeDecimal < 15) { minsToNext = Math.round((15 - timeDecimal) * 60); nextOptimal = '15:00 US Overlap'; }
                            else if (timeDecimal < 16.5) { minsToNext = Math.round((16.5 - timeDecimal) * 60); nextOptimal = '16:30 US Session'; }
                            else if (timeDecimal >= 17.5) { nextOptimal = 'Tomorrow 09:00'; minsToNext = Math.round((24 - timeDecimal + 9) * 60); }

                            const signalStrong = (data.server_signal?.confidence || 0) >= 60;
                            const signalDir = data.server_signal?.signal || 'HOLD';
                            let action = 'WAIT', actionColor = 'var(--grey-text)', actionReason = '';
                            if (isOptimal && signalStrong && signalDir !== 'HOLD') { action = signalDir + ' NOW'; actionColor = signalDir === 'BUY' ? 'var(--success)' : 'var(--danger)'; actionReason = optimalReason + ' + Strong signal'; }
                            else if (isOptimal && signalDir !== 'HOLD') { action = 'WAIT CONFIRM'; actionColor = 'var(--warning)'; actionReason = 'Good time, weak signal'; }
                            else if (signalStrong && signalDir !== 'HOLD') { action = 'WAIT SESSION'; actionColor = 'var(--warning)'; actionReason = 'Strong signal, bad time'; }
                            else { action = 'NO TRADE'; actionColor = 'var(--grey-text)'; actionReason = session === 'CLOSED' ? 'Market closed' : 'No clear setup'; }

                            return `
                            <div style="font-size: 10px; color: var(--text-secondary); text-transform: uppercase; letter-spacing: 1px; margin-bottom: 12px;">Session & Action</div>
                            <div style="display: flex; align-items: center; gap: 10px; margin-bottom: 15px;">
                                <div style="padding: 6px 14px; border-radius: 6px; background: ${sessionColor}22; border: 1px solid ${sessionColor};">
                                    <span style="font-size: 16px; font-weight: 700; color: ${sessionColor};">${session}</span>
                                </div>
                                <div style="font-size: 11px; color: var(--text-secondary);">
                                    <div>${String(serverHour).padStart(2,'0')}:${String(amsMin).padStart(2,'0')} Limassol</div>
                                    <div>${String(dubaiH).padStart(2,'0')}:${String(amsMin).padStart(2,'0')} Dubai</div>
                                </div>
                            </div>
                            <div style="text-align: center; padding: 12px; background: ${isOptimal ? 'rgba(74,222,128,0.1)' : 'rgba(0,0,0,0.2)'}; border-radius: 8px; border: 1px solid ${isOptimal ? 'var(--success)' : 'var(--grey-border)'}; margin-bottom: 12px;">
                                <div style="font-size: 22px; font-weight: 800; color: ${actionColor};">${action}</div>
                                <div style="font-size: 10px; color: var(--grey-text); margin-top: 4px;">${actionReason}</div>
                            </div>
                            <div style="display: flex; justify-content: space-between; align-items: center;">
                                <div>
                                    <div style="font-size: 9px; color: var(--text-secondary);">NEXT OPTIMAL</div>
                                    <div style="font-size: 13px; font-weight: 600; color: var(--cyan);">${isOptimal ? 'NOW!' : nextOptimal}</div>
                                </div>
                                ${!isOptimal && minsToNext > 0 ? '<div style="font-size: 11px; color: var(--grey-text);">in ' + (minsToNext >= 60 ? Math.floor(minsToNext/60) + 'h ' + (minsToNext%60) + 'm' : minsToNext + 'm') + '</div>' : ''}
                            </div>`;
                        })()}
                    </div>

                    <!-- Signal Strength Forecast -->
                    <div class="card" style="cursor: pointer; padding: 15px;" onclick="showSection('prognosis', this)">
                        <div style="font-size: 10px; color: var(--text-secondary); text-transform: uppercase; letter-spacing: 1px; margin-bottom: 10px;">Signal Strength Forecast</div>
                        ${(() => {
                            // Calculate BUY/SELL/HOLD probabilities from all indicators
                            const buyScore = Math.round(Math.min(95, Math.max(5,
                                (a.indicators.rsi < 50 ? (50 - a.indicators.rsi) * 1.2 : 0) +
                                (a.indicators.macd.histogram > 0 ? 20 : 0) +
                                (a.indicators.stoch.k < 30 ? 15 : 0) +
                                (a.signal === 'BUY' ? 25 : 0) +
                                (a.indicators.adx > 25 ? 10 : 0) +
                                10
                            )));
                            const sellScore = Math.round(Math.min(95, Math.max(5,
                                (a.indicators.rsi > 50 ? (a.indicators.rsi - 50) * 1.2 : 0) +
                                (a.indicators.macd.histogram < 0 ? 20 : 0) +
                                (a.indicators.stoch.k > 70 ? 15 : 0) +
                                (a.signal === 'SELL' ? 25 : 0) +
                                (a.indicators.adx > 25 ? 10 : 0) +
                                10
                            )));
                            const holdScore = Math.round(Math.min(95, Math.max(5, 100 - Math.max(buyScore, sellScore))));
                            const total = buyScore + sellScore + holdScore;
                            const buyPct = Math.round(buyScore / total * 100);
                            const sellPct = Math.round(sellScore / total * 100);
                            const holdPct = 100 - buyPct - sellPct;

                            const greyFor = v => v > 50 ? '#c0c8d4' : v > 25 ? '#7c8594' : '#3a4255';
                            const patternFor = v => v > 50
                                ? 'none'
                                : v > 25
                                ? 'repeating-linear-gradient(45deg, transparent, transparent 3px, rgba(255,255,255,0.08) 3px, rgba(255,255,255,0.08) 4px)'
                                : 'repeating-linear-gradient(45deg, transparent, transparent 2px, rgba(255,255,255,0.12) 2px, rgba(255,255,255,0.12) 3px), repeating-linear-gradient(-45deg, transparent, transparent 2px, rgba(255,255,255,0.12) 2px, rgba(255,255,255,0.12) 3px)';

                            const factors = [
                                { name: 'BUY', val: buyPct },
                                { name: 'SELL', val: sellPct },
                                { name: 'HOLD', val: holdPct }
                            ];
                            return factors.map(f => `
                                <div style="display: flex; align-items: center; gap: 8px; margin-bottom: 8px;">
                                    <div style="width: 40px; font-size: 10px; font-weight: 700; color: ${greyFor(f.val)}; text-align: right;">${f.name}</div>
                                    <div style="flex: 1; height: 18px; background: #1a1f2a; border-radius: 3px; overflow: hidden;">
                                        <div style="width: ${f.val}%; height: 100%; background: ${greyFor(f.val)}; background-image: ${patternFor(f.val)}; border-radius: 3px; transition: width 0.5s;"></div>
                                    </div>
                                    <div style="width: 35px; font-size: 12px; font-weight: 800; color: ${greyFor(f.val)};">${f.val}%</div>
                                </div>`).join('');
                        })()}
                    </div>
                    </div><!-- end right stacked column -->
                </div>

                <!-- ROW 2: H1 FORECAST + KEY METRICS -->
                <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 15px; margin-bottom: 15px;">
                    <!-- H1 Forward Forecast Chart -->
                    <div class="card" style="padding: 15px;">
                        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 8px;">
                            <div style="font-size: 10px; color: var(--text-secondary); text-transform: uppercase; letter-spacing: 1px;">H1 ‚Äî 4H History + 4H Forecast</div>
                            <span style="font-size: 11px; font-weight: 600; color: ${a.signal === 'BUY' ? 'var(--success)' : a.signal === 'SELL' ? 'var(--danger)' : 'var(--warning)'};">${a.signal} ${a.confidence.toFixed(0)}%</span>
                        </div>
                        <div id="gcForecastChart" style="width: 100%; height: 180px;"></div>
                    </div>

                    <!-- Summary Metrics Grid -->
                    <div class="card" style="padding: 15px; cursor: pointer;" onclick="showSection('prognosis', this)">
                        <div style="font-size: 10px; color: var(--text-secondary); text-transform: uppercase; letter-spacing: 1px; margin-bottom: 12px;">Key Metrics</div>
                        <div style="display: grid; grid-template-columns: 1fr 1fr 1fr; gap: 12px;">
                            <div style="text-align: center; padding: 10px; background: var(--grey-dark); border-radius: 6px;">
                                <div style="font-size: 9px; color: var(--text-secondary);">24h TARGET</div>
                                <div style="font-size: 18px; font-weight: 700; color: ${a.signal === 'BUY' ? 'var(--success)' : 'var(--danger)'};">${a.prognosis.target.toFixed(2)}</div>
                            </div>
                            <div style="text-align: center; padding: 10px; background: var(--grey-dark); border-radius: 6px;">
                                <div style="font-size: 9px; color: var(--text-secondary);">PROBABILITY</div>
                                <div style="font-size: 18px; font-weight: 700; color: var(--cyan);">${a.prognosis.probability.toFixed(0)}%</div>
                            </div>
                            <div style="text-align: center; padding: 10px; background: var(--grey-dark); border-radius: 6px;">
                                <div style="font-size: 9px; color: var(--text-secondary);">RISK</div>
                                <div style="font-size: 18px; font-weight: 700; color: ${a.confidence >= 75 ? 'var(--success)' : a.confidence >= 60 ? 'var(--warning)' : 'var(--danger)'};">${a.confidence >= 75 ? 'LOW' : a.confidence >= 60 ? 'MED' : 'HIGH'}</div>
                            </div>
                            <div style="text-align: center; padding: 10px; background: var(--grey-dark); border-radius: 6px;">
                                <div style="font-size: 9px; color: var(--text-secondary);">M5 MOMENTUM</div>
                                <div style="font-size: 14px; font-weight: 700; color: ${m5Predict.velocity > 0.1 ? 'var(--success)' : m5Predict.velocity < -0.1 ? 'var(--danger)' : 'var(--warning)'};">${m5Predict.velocityDir}</div>
                                <div style="font-size: 10px; color: var(--text-secondary);">${m5Predict.close.toFixed(2)}</div>
                            </div>
                            <div style="text-align: center; padding: 10px; background: var(--grey-dark); border-radius: 6px;">
                                <div style="font-size: 9px; color: var(--text-secondary);">SCORE</div>
                                <div style="font-size: 18px; font-weight: 700; color: var(--esa-light);">${overallScore}%</div>
                            </div>
                            <div style="text-align: center; padding: 10px; background: var(--grey-dark); border-radius: 6px;">
                                <div style="font-size: 9px; color: var(--text-secondary);">VOLATILITY</div>
                                <div style="font-size: 18px; font-weight: 700; color: ${a.volatility > 20 ? 'var(--danger)' : 'var(--success)'};">${a.volatility.toFixed(1)}%</div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- ROW 3: TECHNICAL INDICATORS - Individual Line Charts -->
                <div style="display: grid; grid-template-columns: repeat(4, 1fr); gap: 8px; margin-bottom: 15px;">
                    ${Object.entries(_gcData.indicators).map(([name, ind]) => `
                    <div class="card" style="cursor: pointer; padding: 8px 10px;" onclick="showSection('indicators', this)">
                        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 3px;">
                            <span style="font-size: 10px; color: var(--text-secondary); font-weight: 600;">${name}</span>
                            <span style="font-size: 13px; font-weight: 800; color: ${ind.color};">${ind.label || ind.value.toFixed(0)}</span>
                        </div>
                        <div id="gcInd_${name}" style="width: 100%; height: 60px;"></div>
                    </div>`).join('')}
                </div>

                <!-- SUMMARY CARDS GRID - Each clickable -->
                <div style="display: grid; grid-template-columns: repeat(3, 1fr); gap: 15px; margin-bottom: 20px;">

                    <!-- M5 FORECAST Card - Click to Prognosis -->
                    <div class="card" style="cursor: pointer;" onclick="showSection('prognosis', this)">
                        <div class="card-header" style="color: var(--success);">
                            <span>M5 FORECAST</span>
                            <span class="badge ${m5Predict.bullProb > 50 ? 'buy' : 'sell'}">${m5Predict.bullProb}%</span>
                        </div>
                        <div style="display: flex; align-items: center; gap: 15px;">
                            <svg width="70" height="70" viewBox="0 0 100 100">
                                <circle cx="50" cy="50" r="40" fill="none" stroke="var(--grey-dark)" stroke-width="8"/>
                                <circle cx="50" cy="50" r="40" fill="none" stroke="${m5Predict.bullProb > 50 ? 'var(--success)' : 'var(--danger)'}" stroke-width="8" stroke-dasharray="${m5Predict.bullProb * 2.51} 251" transform="rotate(-90 50 50)"/>
                                <text x="50" y="55" text-anchor="middle" fill="${m5Predict.bullProb > 50 ? 'var(--success)' : 'var(--danger)'}" font-size="16" font-weight="bold">${m5Predict.bullProb > 50 ? 'BULL' : 'BEAR'}</text>
                            </svg>
                            <div style="flex: 1;">
                                <div class="data-row"><span class="data-label">Close</span><span class="data-value">${m5Predict.close.toFixed(2)}</span></div>
                                <div class="data-row"><span class="data-label">Range</span><span class="data-value cyan">${(m5Predict.high - m5Predict.low).toFixed(2)}</span></div>
                                <div class="data-row"><span class="data-label">Velocity</span><span class="data-value" style="color: ${m5Predict.velocity > 0.1 ? 'var(--success)' : m5Predict.velocity < -0.1 ? 'var(--danger)' : 'var(--text-secondary)'};">${m5Predict.velocity > 0 ? '+' : ''}${m5Predict.velocity.toFixed(2)} ${m5Predict.velocityDir}</span></div>
                            </div>
                        </div>
                    </div>

                    <!-- RISK Card - Click to Risk page -->
                    <div class="card" style="cursor: pointer; border-color: ${riskColor};" onclick="showSection('risk', this)">
                        <div class="card-header" style="color: ${riskColor};">
                            <span>RISK LEVEL</span>
                            <span class="badge ${a.confidence >= 75 ? 'buy' : a.confidence >= 60 ? 'neutral' : 'sell'}">${riskLevel}</span>
                        </div>
                        <div style="display: flex; align-items: center; gap: 15px;">
                            <svg width="70" height="70" viewBox="0 0 100 100">
                                <path d="M 15 70 A 40 40 0 0 1 85 70" fill="none" stroke="var(--grey-dark)" stroke-width="10" stroke-linecap="round"/>
                                <path d="M 15 70 A 40 40 0 0 1 35 35" fill="none" stroke="var(--success)" stroke-width="8"/>
                                <path d="M 38 33 A 40 40 0 0 1 62 33" fill="none" stroke="var(--warning)" stroke-width="8"/>
                                <path d="M 65 35 A 40 40 0 0 1 85 70" fill="none" stroke="var(--danger)" stroke-width="8"/>
                                <circle cx="50" cy="70" r="5" fill="${riskColor}"/>
                                <text x="50" y="90" text-anchor="middle" fill="${riskColor}" font-size="12" font-weight="bold">${a.var95.toFixed(1)}%</text>
                            </svg>
                            <div style="flex: 1;">
                                <div class="data-row"><span class="data-label">VaR</span><span class="data-value">${a.var95.toFixed(2)}%</span></div>
                                <div class="data-row"><span class="data-label">MaxDD</span><span class="data-value">${a.maxDD.toFixed(1)}%</span></div>
                            </div>
                        </div>
                    </div>

                    <!-- POSITION Card - Click to Position -->
                    <div class="card" style="cursor: pointer;" onclick="showSection('position', this)">
                        <div class="card-header" style="color: var(--warning);">
                            <span>POSITION CALC</span>
                            <span class="badge neutral">R:R 1:${(Math.abs(a.prognosis.target - data.bid) / (a.indicators.atr * 1.5)).toFixed(1)}</span>
                        </div>
                        <div style="display: flex; align-items: center; gap: 15px;">
                            <svg width="70" height="70" viewBox="0 0 100 100">
                                <circle cx="50" cy="50" r="35" fill="none" stroke="var(--grey-dark)" stroke-width="6"/>
                                <circle cx="50" cy="50" r="35" fill="none" stroke="var(--warning)" stroke-width="6" stroke-dasharray="${oppScore * 2.2} 220" transform="rotate(-90 50 50)"/>
                                <text x="50" y="45" text-anchor="middle" fill="var(--warning)" font-size="14" font-weight="bold">${oppScore}%</text>
                                <text x="50" y="60" text-anchor="middle" fill="var(--text-secondary)" font-size="8">OPP</text>
                            </svg>
                            <div style="flex: 1;">
                                <div class="data-row"><span class="data-label">Entry</span><span class="data-value">${data.bid.toFixed(2)}</span></div>
                                <div class="data-row"><span class="data-label">Target</span><span class="data-value positive">${a.prognosis.target.toFixed(2)}</span></div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- TOTALS SUMMARY BAR -->
                <div class="risk-grid" style="margin-bottom: 15px;">
                    <div class="risk-item" onclick="showSection('prognosis', this)" style="cursor: pointer;">
                        <div class="risk-label">Signal</div>
                        <div class="risk-value" style="color: ${a.signal === 'BUY' ? 'var(--success)' : a.signal === 'SELL' ? 'var(--danger)' : 'var(--warning)'};">${a.signal}</div>
                        <div class="risk-desc">${a.confidence.toFixed(0)}% conf</div>
                    </div>
                    <div class="risk-item" onclick="showSection('risk', this)" style="cursor: pointer;">
                        <div class="risk-label">Volatility</div>
                        <div class="risk-value" style="color: ${a.volatility > 20 ? 'var(--danger)' : 'var(--success)'};">${a.volatility.toFixed(1)}%</div>
                        <div class="risk-desc">Annualized</div>
                    </div>
                    <div class="risk-item" onclick="showSection('risk', this)" style="cursor: pointer;">
                        <div class="risk-label">Sharpe</div>
                        <div class="risk-value" style="color: ${a.sharpe > 1 ? 'var(--success)' : 'var(--warning)'};">${a.sharpe.toFixed(2)}</div>
                        <div class="risk-desc">Risk-adj</div>
                    </div>
                    <div class="risk-item" onclick="showSection('boxtheory', this)" style="cursor: pointer;">
                        <div class="risk-label">Box</div>
                        <div class="risk-value" style="color: var(--esa-accent);">${a.box?.status.split('-')[0] || 'N/A'}</div>
                        <div class="risk-desc">${a.box?.position || ''}</div>
                    </div>
                    <div class="risk-item" onclick="showSection('indicators', this)" style="cursor: pointer;">
                        <div class="risk-label">Trend</div>
                        <div class="risk-value" style="color: ${a.indicators.adx > 25 ? 'var(--success)' : 'var(--text-secondary)'};">${a.indicators.adx > 25 ? 'STRONG' : 'WEAK'}</div>
                        <div class="risk-desc">ADX ${a.indicators.adx.toFixed(0)}</div>
                    </div>
                </div>

                <!-- CHART -->
                <div class="chart-container" onclick="showSection('boxtheory', this)" style="cursor: pointer;">
                    <div class="chart-header">
                        <span class="chart-title">XAU/EUR M5 Chart (Click for Box Theory Details)</span>
                        <div class="chart-legend">
                            <div class="legend-item"><div class="legend-dot" style="background:#00008B"></div>Data</div>
                            <div class="legend-item"><div class="legend-dot" style="background:#00A1E4"></div>Forecast</div>
                            <div class="legend-item"><div class="legend-dot" style="background:var(--esa-accent)"></div>Box</div>
                        </div>
                    </div>
                    <canvas id="priceChart"></canvas>
                </div>
            `;

            const domChanged = updateContent('dashboardContent', html);
            document.getElementById('lastUpdate').textContent = new Date().toLocaleTimeString();
            // Only redraw charts if DOM was actually replaced (prevents canvas flicker)
            if (domChanged) {
                setTimeout(() => drawChart(a.bars, a.box, a.fib), 50);
                setTimeout(() => drawGoogleCharts(), 100);
            }
        }

        function renderPrognosis(data) {
            const a = analysis || analyze(data);
            const current = data.bid;
            const scenarios = [
                { name: 'Bullish Breakout', prob: a.signal === 'BUY' ? 45 : 20, target: current * 1.015, sl: current * 0.995 },
                { name: 'Continuation', prob: 35, target: a.prognosis.target, sl: current - a.indicators.atr },
                { name: 'Range Bound', prob: a.signal === 'HOLD' ? 40 : 25, target: current, sl: null },
                { name: 'Bearish Breakdown', prob: a.signal === 'SELL' ? 45 : 20, target: current * 0.985, sl: current * 1.005 }
            ];

            // Calculate gauge angle: -90 (SELL) to +90 (BUY), 0 = HOLD
            let gaugeAngle = 0;
            if (a.signal === 'BUY') {
                gaugeAngle = 45 + (a.confidence / 100) * 45; // 45 to 90 degrees
            } else if (a.signal === 'SELL') {
                gaugeAngle = -45 - (a.confidence / 100) * 45; // -45 to -90 degrees
            } else {
                gaugeAngle = (a.confidence - 50) * 0.9; // -45 to +45 for HOLD
            }

            let html = `
                <!-- Signal Gauge -->
                <div class="card" style="margin-bottom: 20px;">
                    <div class="card-header">24-Hour Signal Gauge</div>
                    <div style="display: flex; justify-content: center; align-items: center; padding: 20px;">
                        <svg width="400" height="220" viewBox="0 0 400 220">
                            <!-- Gauge background arc -->
                            <defs>
                                <linearGradient id="gaugeGradient" x1="0%" y1="0%" x2="100%" y2="0%">
                                    <stop offset="0%" style="stop-color:#7c8594"/>
                                    <stop offset="50%" style="stop-color:#a0a8b4"/>
                                    <stop offset="100%" style="stop-color:#c0c8d4"/>
                                </linearGradient>
                            </defs>

                            <!-- Outer arc background -->
                            <path d="M 40 180 A 160 160 0 0 1 360 180" fill="none" stroke="#1a1a2e" stroke-width="35" stroke-linecap="round"/>

                            <!-- Colored gauge arc -->
                            <path d="M 40 180 A 160 160 0 0 1 360 180" fill="none" stroke="url(#gaugeGradient)" stroke-width="30" stroke-linecap="round"/>

                            <!-- Tick marks -->
                            ${[-90, -67.5, -45, -22.5, 0, 22.5, 45, 67.5, 90].map((angle, i) => {
                                const rad = (angle - 90) * Math.PI / 180;
                                const x1 = 200 + 130 * Math.cos(rad);
                                const y1 = 180 + 130 * Math.sin(rad);
                                const x2 = 200 + 145 * Math.cos(rad);
                                const y2 = 180 + 145 * Math.sin(rad);
                                return `<line x1="${x1}" y1="${y1}" x2="${x2}" y2="${y2}" stroke="#fff" stroke-width="2" opacity="0.5"/>`;
                            }).join('')}

                            <!-- Labels -->
                            <text x="30" y="200" fill="#7c8594" font-size="14" font-weight="bold">SELL</text>
                            <text x="185" y="50" fill="#a0a8b4" font-size="14" font-weight="bold">HOLD</text>
                            <text x="340" y="200" fill="#c0c8d4" font-size="14" font-weight="bold">BUY</text>

                            <!-- Confidence labels -->
                            <text x="70" y="120" fill="#888" font-size="10">Strong</text>
                            <text x="310" y="120" fill="#888" font-size="10">Strong</text>

                            <!-- Needle -->
                            <g transform="rotate(${gaugeAngle}, 200, 180)" >
                                <polygon points="200,60 195,175 205,175" fill="${a.signal === 'BUY' ? '#c0c8d4' : a.signal === 'SELL' ? '#7c8594' : '#a0a8b4'}"/>
                                <circle cx="200" cy="180" r="15" fill="${a.signal === 'BUY' ? '#c0c8d4' : a.signal === 'SELL' ? '#7c8594' : '#a0a8b4'}"/>
                                <circle cx="200" cy="180" r="8" fill="#0d0d1a"/>
                            </g>

                            <!-- Center display -->
                            <text x="200" y="155" text-anchor="middle" fill="${a.signal === 'BUY' ? '#c0c8d4' : a.signal === 'SELL' ? '#7c8594' : '#a0a8b4'}" font-size="28" font-weight="bold">${a.signal}</text>
                            <text x="200" y="175" text-anchor="middle" fill="#fff" font-size="16">${a.confidence.toFixed(0)}% Confidence</text>
                        </svg>
                    </div>
                    <div style="display: flex; justify-content: space-around; padding: 10px 30px; border-top: 1px solid var(--grey-dark);">
                        <div style="text-align: center;">
                            <div style="font-size: 11px; color: var(--text-secondary);">24h Target</div>
                            <div style="font-size: 18px; font-weight: bold; color: ${a.signal === 'BUY' ? 'var(--success)' : a.signal === 'SELL' ? 'var(--danger)' : 'var(--warning)'};">${a.prognosis.target.toFixed(2)}</div>
                        </div>
                        <div style="text-align: center;">
                            <div style="font-size: 11px; color: var(--text-secondary);">Probability</div>
                            <div style="font-size: 18px; font-weight: bold; color: var(--cyan);">${a.prognosis.probability.toFixed(0)}%</div>
                        </div>
                        <div style="text-align: center;">
                            <div style="font-size: 11px; color: var(--text-secondary);">Risk Level</div>
                            <div style="font-size: 18px; font-weight: bold; color: ${a.confidence >= 75 ? 'var(--success)' : a.confidence >= 60 ? 'var(--warning)' : 'var(--danger)'};">${a.confidence >= 75 ? 'LOW' : a.confidence >= 60 ? 'MEDIUM' : 'HIGH'}</div>
                        </div>
                        <div style="text-align: center;">
                            <div style="font-size: 11px; color: var(--text-secondary);">Risk:Reward</div>
                            <div style="font-size: 18px; font-weight: bold; color: var(--esa-light);">1:${(Math.abs(a.prognosis.target - current) / (a.indicators.atr * 1.5)).toFixed(1)}</div>
                        </div>
                    </div>
                </div>

                <div class="cards-grid">
                    <div class="card" style="grid-column: span 2;">
                        <div class="card-header">24-Hour Price Forecast</div>
                        <div class="prognosis-grid" style="grid-template-columns: repeat(5, 1fr);">
                            <div class="prognosis-item">
                                <div class="prognosis-label">Strong Support</div>
                                <div class="prognosis-value down">${(current - a.indicators.atr * 2).toFixed(2)}</div>
                            </div>
                            <div class="prognosis-item">
                                <div class="prognosis-label">24h Low</div>
                                <div class="prognosis-value">${a.prognosis.low.toFixed(2)}</div>
                            </div>
                            <div class="prognosis-item" style="background: var(--esa-dark);">
                                <div class="prognosis-label">Current</div>
                                <div class="prognosis-value" style="color: var(--white);">${current.toFixed(2)}</div>
                            </div>
                            <div class="prognosis-item">
                                <div class="prognosis-label">24h High</div>
                                <div class="prognosis-value">${a.prognosis.high.toFixed(2)}</div>
                            </div>
                            <div class="prognosis-item">
                                <div class="prognosis-label">Strong Resistance</div>
                                <div class="prognosis-value up">${(current + a.indicators.atr * 2).toFixed(2)}</div>
                            </div>
                        </div>
                    </div>
                </div>

                <div class="cards-grid">
                    <div class="card">
                        <div class="card-header">Scenario Analysis</div>
                        ${scenarios.map(s => `
                            <div class="data-row">
                                <span class="data-label">${s.name}</span>
                                <span class="data-value">${s.prob}%</span>
                            </div>
                        `).join('')}
                    </div>
                    <div class="card">
                        <div class="card-header">Key Levels to Watch</div>
                        <div class="data-row"><span class="data-label">Resistance 1</span><span class="data-value negative">${a.pivots.r1.toFixed(2)}</span></div>
                        <div class="data-row"><span class="data-label">Pivot Point</span><span class="data-value">${a.pivots.pivot.toFixed(2)}</span></div>
                        <div class="data-row"><span class="data-label">Support 1</span><span class="data-value positive">${a.pivots.s1.toFixed(2)}</span></div>
                        <div class="data-row"><span class="data-label">Box High</span><span class="data-value">${a.box?.boxHigh.toFixed(2)}</span></div>
                        <div class="data-row"><span class="data-label">Box Low</span><span class="data-value">${a.box?.boxLow.toFixed(2)}</span></div>
                    </div>
                    <div class="card">
                        <div class="card-header">Trade Setup</div>
                        <div class="data-row"><span class="data-label">Direction</span><span class="badge ${a.signal.toLowerCase()}">${a.signal}</span></div>
                        <div class="data-row"><span class="data-label">Entry</span><span class="data-value">${current.toFixed(2)}</span></div>
                        <div class="data-row"><span class="data-label">Stop Loss</span><span class="data-value negative">${(current - a.indicators.atr * 1.5).toFixed(2)}</span></div>
                        <div class="data-row"><span class="data-label">Take Profit</span><span class="data-value positive">${a.prognosis.target.toFixed(2)}</span></div>
                        <div class="data-row"><span class="data-label">Risk:Reward</span><span class="data-value cyan">1:${(Math.abs(a.prognosis.target - current) / (a.indicators.atr * 1.5)).toFixed(1)}</span></div>
                    </div>
                    <div class="card">
                        <div class="card-header">Probability Assessment</div>
                        <div class="data-row"><span class="data-label">Target Hit Prob</span><span class="data-value">${a.prognosis.probability.toFixed(0)}%</span></div>
                        <div class="data-row"><span class="data-label">Stop Hit Prob</span><span class="data-value">${(100 - a.prognosis.probability).toFixed(0)}%</span></div>
                        <div class="data-row"><span class="data-label">Expected Value</span><span class="data-value ${a.signal === 'BUY' ? 'positive' : a.signal === 'SELL' ? 'negative' : ''}">${((a.prognosis.probability/100 * (a.prognosis.target - current)) - ((100-a.prognosis.probability)/100 * a.indicators.atr * 1.5)).toFixed(2)}</span></div>
                    </div>
                </div>

                <div class="card">
                    <div class="card-header">24h Analysis Summary</div>
                    <p style="font-size: 12px; line-height: 1.8; color: var(--text-secondary);">
                        Based on current technical analysis, XAU/EUR at <strong>${current.toFixed(2)}</strong> shows a
                        <strong style="color: ${a.signal === 'BUY' ? 'var(--success)' : a.signal === 'SELL' ? 'var(--danger)' : 'var(--warning)'};">${a.signal}</strong>
                        signal with <strong>${a.confidence.toFixed(0)}%</strong> confidence.
                        <br><br>
                        The 24-hour price range is projected between <strong>${a.prognosis.low.toFixed(2)}</strong> and
                        <strong>${a.prognosis.high.toFixed(2)}</strong> based on ATR(14) of ${a.indicators.atr.toFixed(2)}.
                        ${a.signal !== 'HOLD' ? `Primary target is <strong>${a.prognosis.target.toFixed(2)}</strong> with ${a.prognosis.probability.toFixed(0)}% probability.` : ''}
                        <br><br>
                        <strong>Key factors:</strong> RSI at ${a.indicators.rsi.toFixed(1)}${a.indicators.rsi < 30 ? ' (oversold)' : a.indicators.rsi > 70 ? ' (overbought)' : ''},
                        ADX trend strength ${a.indicators.adx.toFixed(1)}${a.indicators.adx > 25 ? ' (strong)' : ' (weak)'},
                        Box Theory ${a.box?.status.replace('-', ' ')}.
                    </p>
                </div>
            `;

            updateContent('prognosisContent', html);
        }

        function renderFibonacci(data) {
            const a = analysis || analyze(data);
            const current = data.bid;
            const isBullish = a.signal === 'BUY';
            const isBearish = a.signal === 'SELL';

            // STANDARD FIBONACCI (like TradingView):
            // 0% = HIGH (top), 100% = LOW (bottom)
            // Same display for both - interpretation differs
            const levels = [
                { name: '0%', value: a.fib[0], color: '#c0c8d4', pct: 0 },
                { name: '23.6%', value: a.fib[0.236], color: '#4caf50', pct: 23.6 },
                { name: '38.2%', value: a.fib[0.382], color: '#ffeb3b', pct: 38.2 },
                { name: '50.0%', value: a.fib[0.5], color: '#9c27b0', pct: 50 },
                { name: '61.8% (Golden)', value: a.fib[0.618], color: '#00bcd4', pct: 61.8 },
                { name: '78.6%', value: a.fib[0.786], color: '#ff9800', pct: 78.6 },
                { name: '100%', value: a.fib[1], color: '#5a6270', pct: 100 }
            ];

            const range = a.fib[0] - a.fib[1];
            const currentRetracement = ((a.fib[0] - current) / range) * 100; // Standard: 0% at high, 100% at low

            let html = `
                <div class="card" style="margin-bottom: 15px; border-top: 3px solid ${isBullish ? 'var(--success)' : isBearish ? 'var(--danger)' : 'var(--warning)'};">
                    <div class="card-header" style="display: flex; justify-content: space-between; align-items: center;">
                        <span>Fibonacci Retracement Levels</span>
                        <span class="badge ${isBullish ? 'buy' : isBearish ? 'sell' : 'neutral'}">${isBullish ? '‚ñ≤ BULLISH' : isBearish ? '‚ñº BEARISH' : '‚óè NEUTRAL'}</span>
                    </div>
                    <div style="padding: 10px; margin-bottom: 10px; background: var(--grey-dark); border-radius: 4px; font-size: 11px;">
                        <strong>Standard Fibonacci:</strong> 0% = Swing High, 100% = Swing Low<br>
                        ${isBullish ?
                            '<span style="color: var(--success);">‚ñ≤ BULLISH:</span> Buy at 61.8%/78.6% retracement, target 0% (high)' :
                            isBearish ?
                            '<span style="color: var(--danger);">‚ñº BEARISH:</span> Sell at 38.2%/23.6% retracement, target 100% (low)' :
                            '<span style="color: var(--warning);">‚óè NEUTRAL:</span> Wait for clear direction'}
                    </div>
                    <div class="fib-levels">
                        ${levels.map(l => {
                            const pos = l.pct; // Use percentage directly for bar width
                            return `
                                <div class="fib-row">
                                    <span class="fib-label">${l.name}</span>
                                    <div class="fib-bar">
                                        <div class="fib-fill" style="width: ${pos}%; background: ${l.color};"></div>
                                        <div class="fib-current" style="left: ${currentRetracement}%;"></div>
                                        <span class="fib-price">${l.value.toFixed(2)}</span>
                                    </div>
                                </div>
                            `;
                        }).join('')}
                    </div>
                    <div style="display: grid; grid-template-columns: repeat(3, 1fr); gap: 10px; margin-top: 15px; padding-top: 15px; border-top: 1px solid var(--grey-border); text-align: center;">
                        <div>
                            <div style="font-size: 10px; color: var(--text-secondary);">Current Price</div>
                            <div style="font-size: 14px; font-weight: bold;">${current.toFixed(2)}</div>
                        </div>
                        <div>
                            <div style="font-size: 10px; color: var(--text-secondary);">Retracement</div>
                            <div style="font-size: 14px; font-weight: bold; color: ${currentRetracement < 38.2 ? 'var(--success)' : currentRetracement > 61.8 ? 'var(--danger)' : 'var(--warning)'};">
                                ${currentRetracement.toFixed(1)}%
                            </div>
                        </div>
                        <div>
                            <div style="font-size: 10px; color: var(--text-secondary);">Signal</div>
                            <div style="font-size: 14px; font-weight: bold; color: ${isBullish ? 'var(--success)' : isBearish ? 'var(--danger)' : 'var(--warning)'};">
                                ${isBullish ? '‚ñ≤ BUY' : isBearish ? '‚ñº SELL' : '‚óè HOLD'}
                            </div>
                        </div>
                    </div>
                </div>

                <div class="cards-grid">
                    <div class="card">
                        <div class="card-header">Key Fibonacci Levels</div>
                        <div class="data-row">
                            <span class="data-label" style="color: #ffeb3b;">38.2%</span>
                            <span class="data-value" style="color: #ffeb3b;">${a.fib[0.382].toFixed(2)}</span>
                        </div>
                        <div class="data-row">
                            <span class="data-label" style="color: #00bcd4;">61.8% (Golden)</span>
                            <span class="data-value" style="color: #00bcd4;">${a.fib[0.618].toFixed(2)}</span>
                        </div>
                        <div style="margin-top: 10px; padding-top: 10px; border-top: 1px solid var(--grey-border); font-size: 10px; color: var(--text-secondary);">
                            ${current < a.fib[0.382] ? '‚ñ≤ Price ABOVE 38.2% (near high)' :
                              current < a.fib[0.618] ? '‚óè Price between 38.2%-61.8%' :
                              '‚ñº Price BELOW 61.8% (deep retracement)'}
                        </div>
                    </div>
                    <div class="card">
                        <div class="card-header">Nearest Levels</div>
                        <div class="data-row"><span class="data-label">Resistance (above)</span><span class="data-value negative">${levels.filter(l => l.value > current).sort((a,b) => a.value - b.value)[0]?.value.toFixed(2) || 'N/A'}</span></div>
                        <div class="data-row"><span class="data-label">Support (below)</span><span class="data-value positive">${levels.filter(l => l.value < current).sort((a,b) => b.value - a.value)[0]?.value.toFixed(2) || 'N/A'}</span></div>
                        <div style="margin-top: 10px; padding-top: 10px; border-top: 1px solid var(--grey-border); font-size: 10px; color: var(--text-secondary);">
                            Distance to 38.2%: ${Math.abs(current - a.fib[0.382]).toFixed(2)} pts<br>
                            Distance to 61.8%: ${Math.abs(current - a.fib[0.618]).toFixed(2)} pts
                        </div>
                    </div>
                </div>
            `;

            updateContent('fibContent', html);
        }

        function renderRisk(data) {
            const a = analysis || analyze(data);

            let html = `
                <div class="risk-grid" style="grid-template-columns: repeat(4, 1fr);">
                    <div class="risk-item">
                        <div class="risk-label">Volatility (Ann.)</div>
                        <div class="risk-value" style="color: ${a.volatility > 25 ? 'var(--danger)' : a.volatility > 15 ? 'var(--warning)' : 'var(--success)'};">${a.volatility.toFixed(1)}%</div>
                        <div class="risk-desc">${a.volatility > 25 ? 'High' : a.volatility > 15 ? 'Medium' : 'Low'}</div>
                    </div>
                    <div class="risk-item">
                        <div class="risk-label">Sharpe Ratio</div>
                        <div class="risk-value" style="color: ${a.sharpe > 1.5 ? 'var(--success)' : a.sharpe > 0.5 ? 'var(--warning)' : 'var(--danger)'};">${a.sharpe.toFixed(2)}</div>
                        <div class="risk-desc">${a.sharpe > 1.5 ? 'Excellent' : a.sharpe > 0.5 ? 'Good' : 'Poor'}</div>
                    </div>
                    <div class="risk-item">
                        <div class="risk-label">Max Drawdown</div>
                        <div class="risk-value" style="color: ${a.maxDD < 5 ? 'var(--success)' : a.maxDD < 15 ? 'var(--warning)' : 'var(--danger)'};">${a.maxDD.toFixed(1)}%</div>
                        <div class="risk-desc">Worst peak-trough</div>
                    </div>
                    <div class="risk-item">
                        <div class="risk-label">VaR (95%)</div>
                        <div class="risk-value" style="color: ${a.var95 < 2 ? 'var(--success)' : a.var95 < 4 ? 'var(--warning)' : 'var(--danger)'};">${a.var95.toFixed(2)}%</div>
                        <div class="risk-desc">Daily 95% limit</div>
                    </div>
                </div>

                <div class="cards-grid">
                    <div class="card">
                        <div class="card-header">Risk-Adjusted Returns</div>
                        <div class="data-row"><span class="data-label">Sharpe Ratio</span><span class="data-value">${a.sharpe.toFixed(3)}</span></div>
                        <div class="data-row"><span class="data-label">Sortino Ratio</span><span class="data-value">${(a.sharpe * 1.2).toFixed(3)}</span></div>
                        <div class="data-row"><span class="data-label">Calmar Ratio</span><span class="data-value">${(a.sharpe / (a.maxDD / 10)).toFixed(3)}</span></div>
                    </div>
                    <div class="card">
                        <div class="card-header">Position Sizing (Kelly)</div>
                        <div class="data-row"><span class="data-label">Win Rate Est.</span><span class="data-value">${(50 + a.confidence / 4).toFixed(0)}%</span></div>
                        <div class="data-row"><span class="data-label">Kelly %</span><span class="data-value">${(a.sharpe * 10).toFixed(1)}%</span></div>
                        <div class="data-row"><span class="data-label">Half Kelly</span><span class="data-value cyan">${(a.sharpe * 5).toFixed(1)}%</span></div>
                    </div>
                    <div class="card">
                        <div class="card-header">Risk Limits</div>
                        <div class="data-row"><span class="data-label">Daily VaR 99%</span><span class="data-value negative">${(a.var95 * 1.5).toFixed(2)}%</span></div>
                        <div class="data-row"><span class="data-label">Weekly VaR 95%</span><span class="data-value">${(a.var95 * 2.2).toFixed(2)}%</span></div>
                        <div class="data-row"><span class="data-label">Max Loss Limit</span><span class="data-value negative">${(a.maxDD * 0.5).toFixed(1)}%</span></div>
                    </div>
                </div>
            `;

            updateContent('riskContent', html);
        }

        function renderCalendar(data) {
            // Use real calendar events from API (Forex Factory)
            // Sort by date descending (newest/soonest first)
            const defaultEvents = [
                { time: '08:30', event: 'ECB Interest Rate Decision', impact: 'high', forecast: '4.00%', currency: 'EUR' },
                { time: '10:00', event: 'Eurozone CPI YoY', impact: 'high', forecast: '2.4%', currency: 'EUR' },
                { time: '13:30', event: 'US Nonfarm Payrolls', impact: 'high', forecast: '180K', currency: 'USD' },
                { time: '14:00', event: 'Fed Chair Powell Speech', impact: 'high', forecast: '-', currency: 'USD' },
                { time: '15:00', event: 'US ISM Manufacturing PMI', impact: 'medium', forecast: '48.5', currency: 'USD' },
                { time: '16:30', event: 'EIA Crude Oil Inventories', impact: 'medium', forecast: '-2.1M', currency: 'USD' }
            ];
            const events = (data.calendar || defaultEvents).sort((a, b) => {
                const dateA = new Date(a.time || 0);
                const dateB = new Date(b.time || 0);
                return dateB - dateA; // Descending (newest first)
            });

            // Calculate gold sentiment for each event
            function getGoldSentiment(event) {
                const e = event.event.toLowerCase();
                const curr = event.currency;
                const impact = event.impact;

                // Base probability from impact
                let prob = impact === 'high' ? 75 : impact === 'medium' ? 55 : 40;

                // USD events: strong USD = bearish for gold (inverse)
                // EUR events: affect XAU/EUR rate
                let sentiment = 'neutral';

                // Rate decisions - higher rates = bearish for gold
                if (e.includes('rate') || e.includes('fomc') || e.includes('ecb')) {
                    sentiment = curr === 'USD' ? 'bearish' : 'bullish';
                    prob = impact === 'high' ? 85 : 70;
                }
                // Inflation - higher inflation = bullish for gold (hedge)
                else if (e.includes('cpi') || e.includes('inflation') || e.includes('ppi')) {
                    sentiment = 'bullish';
                    prob = impact === 'high' ? 80 : 65;
                }
                // Employment - strong jobs = bearish for gold (USD strength)
                else if (e.includes('nonfarm') || e.includes('employment') || e.includes('jobless')) {
                    sentiment = curr === 'USD' ? 'bearish' : 'neutral';
                    prob = impact === 'high' ? 75 : 60;
                }
                // GDP - strong economy = bearish for gold
                else if (e.includes('gdp')) {
                    sentiment = curr === 'USD' ? 'bearish' : 'neutral';
                    prob = 65;
                }
                // PMI - manufacturing strength
                else if (e.includes('pmi') || e.includes('manufacturing')) {
                    sentiment = curr === 'USD' ? 'bearish' : 'neutral';
                    prob = 55;
                }
                // Fed/ECB speeches - uncertainty
                else if (e.includes('speech') || e.includes('powell') || e.includes('lagarde')) {
                    sentiment = 'neutral';
                    prob = 60;
                }

                return { sentiment, prob };
            }

            // Store calendar globally for modal access (with sentiment)
            window.calendarData = events.map(e => ({...e, ...getGoldSentiment(e)}));

            let html = `
                <div class="card" style="margin-bottom: 15px;">
                    <div class="card-header">Upcoming Economic Events (Impact on XAU/EUR) <span style="font-size: 10px; color: var(--text-secondary);">- click to read</span></div>
                    ${window.calendarData.map((e, i) => `
                        <div class="calendar-item news-item-clickable" onclick="showCalendarModal(window.calendarData[${i}])" style="cursor: pointer;">
                            <span class="calendar-time">${e.time}</span>
                            <div class="calendar-impact ${e.impact}"></div>
                            <div style="flex: 1;">
                                <div style="font-size: 12px; color: var(--text-primary);">
                                    <span style="font-weight: 600; color: ${e.sentiment === 'bullish' ? 'var(--success)' : e.sentiment === 'bearish' ? 'var(--danger)' : 'var(--text-secondary)'};">${e.sentiment === 'bullish' ? '‚ñ≤' : e.sentiment === 'bearish' ? '‚ñº' : '‚óè'}</span>
                                    ${e.event} <span style="color: var(--esa-light);">(${e.currency})</span>
                                </div>
                                <div style="font-size: 10px; color: var(--text-secondary);">Forecast: ${e.forecast}</div>
                            </div>
                            <span class="badge ${e.sentiment === 'bullish' ? 'buy' : e.sentiment === 'bearish' ? 'sell' : ''}" style="min-width: 80px; text-align: center;">${e.sentiment === 'bullish' ? '‚ñ≤' : e.sentiment === 'bearish' ? '‚ñº' : '‚óè'} ${e.prob}%</span>
                        </div>
                    `).join('')}
                </div>

                <div class="card">
                    <div class="card-header">Calendar Impact Guide</div>
                    <div class="data-row"><span class="data-label"><span class="calendar-impact high" style="display:inline-block;margin-right:8px;"></span>High Impact</span><span class="data-value">Major market movers</span></div>
                    <div class="data-row"><span class="data-label"><span class="calendar-impact medium" style="display:inline-block;margin-right:8px;"></span>Medium Impact</span><span class="data-value">Moderate volatility</span></div>
                    <div class="data-row"><span class="data-label"><span class="calendar-impact low" style="display:inline-block;margin-right:8px;"></span>Low Impact</span><span class="data-value">Minor moves expected</span></div>
                </div>
            `;

            updateContent('calendarContent', html);
        }

        function renderPosition(data) {
            const a = analysis || analyze(data);
            const riskLevel = a.confidence >= 75 ? 'LOW' : a.confidence >= 60 ? 'MEDIUM' : 'HIGH';
            const riskColor = a.confidence >= 75 ? 'var(--success)' : a.confidence >= 60 ? 'var(--warning)' : 'var(--danger)';
            const oppScore = Math.round((a.confidence + a.prognosis.probability) / 2);
            const riskMultiplier = a.confidence >= 75 ? 1.0 : a.confidence >= 60 ? 0.75 : 0.5;

            let html = `
                <!-- Risk & Opportunity Summary -->
                <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 15px; margin-bottom: 15px;">
                    <div class="card" style="border-color: var(--success); background: rgba(0,200,83,0.05);">
                        <div class="card-header" style="color: var(--success);">Opportunity Score</div>
                        <div style="display: flex; align-items: center; gap: 15px;">
                            <svg width="70" height="70" viewBox="0 0 100 100">
                                <circle cx="50" cy="50" r="40" fill="none" stroke="var(--grey-dark)" stroke-width="6"/>
                                <circle cx="50" cy="50" r="40" fill="none" stroke="var(--success)" stroke-width="6" stroke-linecap="round"
                                    stroke-dasharray="${oppScore * 2.51} 251" transform="rotate(-90 50 50)"/>
                                <text x="50" y="55" text-anchor="middle" fill="var(--success)" font-size="20" font-weight="bold">${oppScore}%</text>
                            </svg>
                            <div style="flex: 1;">
                                <div class="data-row"><span class="data-label">Signal</span><span class="badge ${a.signal.toLowerCase()}">${a.signal}</span></div>
                                <div class="data-row"><span class="data-label">Confidence</span><span class="data-value">${a.confidence.toFixed(0)}%</span></div>
                                <div class="data-row"><span class="data-label">Probability</span><span class="data-value">${a.prognosis.probability.toFixed(0)}%</span></div>
                            </div>
                        </div>
                    </div>
                    <div class="card" style="border-color: ${riskColor}; background: rgba(${a.confidence >= 75 ? '0,200,83' : a.confidence >= 60 ? '255,171,0' : '255,61,0'},0.05);">
                        <div class="card-header" style="color: ${riskColor};">Risk Assessment</div>
                        <div style="display: flex; align-items: center; gap: 15px;">
                            <svg width="70" height="70" viewBox="0 0 100 100">
                                <circle cx="50" cy="50" r="40" fill="none" stroke="var(--grey-dark)" stroke-width="6"/>
                                <circle cx="50" cy="50" r="40" fill="none" stroke="${riskColor}" stroke-width="6" stroke-linecap="round"
                                    stroke-dasharray="${(100 - a.var95 * 10) * 2.51} 251" transform="rotate(-90 50 50)"/>
                                <text x="50" y="50" text-anchor="middle" fill="${riskColor}" font-size="12" font-weight="bold">${riskLevel}</text>
                                <text x="50" y="65" text-anchor="middle" fill="var(--text-secondary)" font-size="10">RISK</text>
                            </svg>
                            <div style="flex: 1;">
                                <div class="data-row"><span class="data-label">VaR (95%)</span><span class="data-value">${a.var95.toFixed(2)}%</span></div>
                                <div class="data-row"><span class="data-label">Max DD</span><span class="data-value">${a.maxDD.toFixed(1)}%</span></div>
                                <div class="data-row"><span class="data-label">Size Adj</span><span class="data-value" style="color: ${riskColor};">${(riskMultiplier * 100).toFixed(0)}%</span></div>
                            </div>
                        </div>
                    </div>
                </div>

                <div class="cards-grid">
                    <div class="card">
                        <div class="card-header">Smart Position Calculator</div>
                        <div class="calc-grid">
                            <div>
                                <label class="calc-label">Account Balance (EUR)</label>
                                <input type="number" class="calc-input" id="balance" value="10000" oninput="calculatePosition()">
                            </div>
                            <div>
                                <label class="calc-label">Base Risk % (adjusted by analysis)</label>
                                <input type="number" class="calc-input" id="riskPct" value="1" step="0.1" oninput="calculatePosition()">
                            </div>
                            <div>
                                <label class="calc-label">Entry Price</label>
                                <input type="number" class="calc-input" id="entry" value="${data.bid.toFixed(2)}" oninput="calculatePosition()">
                            </div>
                            <div>
                                <label class="calc-label">Stop Loss (ATR-based)</label>
                                <input type="number" class="calc-input" id="sl" value="${(data.bid - a.indicators.atr * 1.5).toFixed(2)}" oninput="calculatePosition()">
                            </div>
                        </div>
                        <!-- Hidden fields for analysis data -->
                        <input type="hidden" id="confidence" value="${a.confidence}">
                        <input type="hidden" id="signal" value="${a.signal}">
                        <input type="hidden" id="var95" value="${a.var95}">
                        <input type="hidden" id="target" value="${a.prognosis.target}">

                        <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 15px; margin-top: 15px;">
                            <div class="calc-result">
                                <div class="calc-result-value" id="baseLot">0.10</div>
                                <div class="calc-result-label">Base Lot Size</div>
                            </div>
                            <div class="calc-result" style="background: ${riskColor.replace('var(--', 'rgba(').replace(')', ', 0.2)')};">
                                <div class="calc-result-value" id="adjLot" style="color: ${riskColor};">0.10</div>
                                <div class="calc-result-label">Risk-Adjusted Lot</div>
                            </div>
                        </div>
                        <p style="font-size: 10px; color: var(--text-secondary); margin-top: 10px; text-align: center;">
                            Lot size adjusted by <strong>${(riskMultiplier * 100).toFixed(0)}%</strong> based on ${riskLevel} risk level
                        </p>
                    </div>
                    <div class="card">
                        <div class="card-header">Trade Parameters</div>
                        <div class="data-row"><span class="data-label">Direction</span><span class="badge ${a.signal.toLowerCase()}">${a.signal}</span></div>
                        <div class="data-row"><span class="data-label">Entry</span><span class="data-value">${data.bid.toFixed(2)}</span></div>
                        <div class="data-row"><span class="data-label">Stop Loss</span><span class="data-value negative" id="slDisplay">${(data.bid - a.indicators.atr * 1.5).toFixed(2)}</span></div>
                        <div class="data-row"><span class="data-label">Take Profit</span><span class="data-value positive">${a.prognosis.target.toFixed(2)}</span></div>
                        <div class="data-row"><span class="data-label">Stop Distance</span><span class="data-value" id="stopDist">${(a.indicators.atr * 1.5).toFixed(2)} pts</span></div>
                        <div class="data-row"><span class="data-label">Risk:Reward</span><span class="data-value cyan" id="rr">1:${(Math.abs(a.prognosis.target - data.bid) / (a.indicators.atr * 1.5)).toFixed(1)}</span></div>
                        <div class="data-row"><span class="data-label">Base Risk</span><span class="data-value" id="riskAmount">‚Ç¨100.00</span></div>
                        <div class="data-row"><span class="data-label">Adjusted Risk</span><span class="data-value" id="adjRisk" style="color: ${riskColor};">‚Ç¨100.00</span></div>
                        <div class="data-row"><span class="data-label">Margin Req.</span><span class="data-value" id="margin">‚Ç¨500.00</span></div>
                    </div>
                </div>

                <div class="card" style="margin-top: 15px;">
                    <div class="card-header">Position Sizing Logic</div>
                    <p style="font-size: 11px; line-height: 1.8; color: var(--text-secondary);">
                        <strong>Risk-Adjusted Position Sizing:</strong><br>
                        ‚Ä¢ <span style="color: var(--success);">HIGH Opportunity (75%+)</span>: 100% of calculated lot size<br>
                        ‚Ä¢ <span style="color: var(--warning);">MEDIUM Opportunity (60-75%)</span>: 75% of calculated lot size<br>
                        ‚Ä¢ <span style="color: var(--danger);">LOW Opportunity (&lt;60%)</span>: 50% of calculated lot size (or skip trade)<br><br>
                        <strong>Current Analysis:</strong> ${a.signal} signal with ${a.confidence.toFixed(0)}% confidence = <strong style="color: ${riskColor};">${(riskMultiplier * 100).toFixed(0)}%</strong> position size
                        ${a.signal === 'HOLD' ? '<br><span style="color: var(--danger);">‚ö†Ô∏è HOLD signal - consider waiting for better setup</span>' : ''}
                    </p>
                </div>
            `;

            updateContent('positionContent', html);
            calculatePosition();
        }

        function calculatePosition() {
            const balance = parseFloat(document.getElementById('balance')?.value || 10000);
            const riskPct = parseFloat(document.getElementById('riskPct')?.value || 1);
            const entry = parseFloat(document.getElementById('entry')?.value || 2600);
            const sl = parseFloat(document.getElementById('sl')?.value || 2580);
            const confidence = parseFloat(document.getElementById('confidence')?.value || 50);
            const target = parseFloat(document.getElementById('target')?.value || entry);

            // Risk multiplier based on confidence
            const riskMultiplier = confidence >= 75 ? 1.0 : confidence >= 60 ? 0.75 : 0.5;

            const baseRisk = balance * (riskPct / 100);
            const adjustedRisk = baseRisk * riskMultiplier;
            const stopDist = Math.abs(entry - sl);
            const baseLot = (baseRisk / (stopDist * 100)).toFixed(2);
            const adjLot = (adjustedRisk / (stopDist * 100)).toFixed(2);
            const rr = Math.abs(target - entry) / stopDist;

            if (document.getElementById('baseLot')) {
                document.getElementById('baseLot').textContent = baseLot;
                document.getElementById('adjLot').textContent = adjLot;
                document.getElementById('riskAmount').textContent = `‚Ç¨${baseRisk.toFixed(2)}`;
                document.getElementById('adjRisk').textContent = `‚Ç¨${adjustedRisk.toFixed(2)}`;
                document.getElementById('stopDist').textContent = `${stopDist.toFixed(2)} pts`;
                document.getElementById('rr').textContent = `1:${rr.toFixed(1)}`;
                document.getElementById('margin').textContent = `‚Ç¨${(entry * parseFloat(adjLot) * 0.02).toFixed(2)}`;
            }
        }

        function renderNews(data) {
            // Use REAL news from API (Forex Factory, Kitco, Investing.com)
            // Sort by timestamp descending (newest first)
            const news = (data.news || []).sort((a, b) => {
                return (b.timestamp || 0) - (a.timestamp || 0);
            });

            // Use REAL COT data from CFTC
            const cot = data.cot || {
                commercial: { long: 0, short: 0, net: 0 },
                nonCommercial: { long: 0, short: 0, net: 0 },
                source: 'unavailable'
            };

            // Store news globally for modal access
            window.newsData = news;

            // Calculate sentiment from news
            let bullish = 0, bearish = 0, neutral = 0;
            news.forEach(n => {
                if (n.sentiment === 'bullish') bullish++;
                else if (n.sentiment === 'bearish') bearish++;
                else neutral++;
            });
            const total = bullish + bearish + neutral;
            const sentimentPct = total > 0 ? Math.round((bullish - bearish) / total * 100) : 0;
            const sentimentLabel = sentimentPct > 20 ? 'BULLISH' : sentimentPct < -20 ? 'BEARISH' : 'NEUTRAL';
            const sentimentColor = sentimentPct > 0 ? 'var(--success)' : sentimentPct < 0 ? 'var(--danger)' : 'var(--warning)';

            // Impact/probability per sentiment column
            const impactWeight = { high: 3, medium: 2, low: 1 };
            function calcColumnScore(items) {
                if (items.length === 0) return { pct: 0, avgConf: 0, avgScore: 0, weight: 0 };
                let totalWeight = 0, weightedScore = 0, weightedConf = 0;
                items.forEach(n => {
                    const w = impactWeight[n.impact] || 1;
                    const score = Math.abs(n.sentiment_score || 50);
                    const conf = n.sentiment_confidence || 40;
                    totalWeight += w;
                    weightedScore += score * w;
                    weightedConf += conf * w;
                });
                const avgScore = totalWeight > 0 ? weightedScore / totalWeight : 0;
                const avgConf = totalWeight > 0 ? weightedConf / totalWeight : 0;
                // Probability = blend of score strength and confidence, scaled 0-100
                const pct = Math.round(Math.min(100, (avgScore * 0.6 + avgConf * 0.4)));
                return { pct, avgConf: Math.round(avgConf), avgScore: Math.round(avgScore), weight: totalWeight };
            }
            const bullNews = news.filter(n => n.sentiment === 'bullish');
            const bearNews = news.filter(n => n.sentiment === 'bearish');
            const neutNews = news.filter(n => n.sentiment !== 'bullish' && n.sentiment !== 'bearish');
            const bullScore = calcColumnScore(bullNews);
            const bearScore = calcColumnScore(bearNews);
            const neutScore = calcColumnScore(neutNews);

            // Overall mixed weighted score
            // Each column contributes its share: bull pushes +, bear pushes -, neutral pushes toward 50%
            // Neutral dilutes conviction ‚Äî high-impact neutral = more uncertainty
            const totalW = bullScore.weight + bearScore.weight + neutScore.weight || 1;
            const bullContrib = bullScore.pct * (bullScore.weight / totalW);   // bullish push (0-100 scaled by share)
            const bearContrib = bearScore.pct * (bearScore.weight / totalW);   // bearish push
            const neutContrib = neutScore.pct * (neutScore.weight / totalW);   // neutral dilution
            // Net direction: bull - bear, then reduce by neutral's share (neutral = uncertainty = less conviction)
            const neutralDilution = 1 - (neutContrib / 100);  // 0 to 1, lower = more neutral drag
            const rawScore = bullContrib - bearContrib;
            const overallScore = Math.round(rawScore * Math.max(0.2, neutralDilution));
            const overallPct = Math.round((bullContrib + bearContrib + neutContrib));  // total impact activity 0-100
            const overallLabel = overallScore > 10 ? 'BULLISH' : overallScore < -10 ? 'BEARISH' : 'MIXED';
            const overallColor = overallScore > 10 ? 'var(--success)' : overallScore < -10 ? 'var(--danger)' : 'var(--warning)';

            // COT net position styling
            const cotNet = cot.nonCommercial?.net || 0;
            const cotClass = cotNet > 0 ? 'positive' : cotNet < 0 ? 'negative' : '';

            // === Economic Calendar (gold-relevant only) ===
            const defaultEvents = [
                { time: '08:30', event: 'ECB Interest Rate Decision', impact: 'high', forecast: '4.00%', currency: 'EUR' },
                { time: '13:30', event: 'US Nonfarm Payrolls', impact: 'high', forecast: '180K', currency: 'USD' },
                { time: '14:00', event: 'Fed Chair Powell Speech', impact: 'high', forecast: '-', currency: 'USD' }
            ];
            const calEvents = (data.calendar || defaultEvents).sort((a, b) => {
                const dateA = new Date(a.time || 0);
                const dateB = new Date(b.time || 0);
                return dateB - dateA;
            });

            function getGoldSentiment(event) {
                const e = event.event.toLowerCase();
                const curr = event.currency;
                const impact = event.impact;
                let prob = impact === 'high' ? 75 : impact === 'medium' ? 55 : 40;
                let sentiment = 'neutral';
                if (e.includes('rate') || e.includes('fomc') || e.includes('ecb')) {
                    sentiment = curr === 'USD' ? 'bearish' : 'bullish';
                    prob = impact === 'high' ? 85 : 70;
                } else if (e.includes('cpi') || e.includes('inflation') || e.includes('ppi')) {
                    sentiment = 'bullish'; prob = impact === 'high' ? 80 : 65;
                } else if (e.includes('nonfarm') || e.includes('employment') || e.includes('jobless')) {
                    sentiment = curr === 'USD' ? 'bearish' : 'neutral'; prob = impact === 'high' ? 75 : 60;
                } else if (e.includes('gdp')) {
                    sentiment = curr === 'USD' ? 'bearish' : 'neutral'; prob = 65;
                } else if (e.includes('pmi') || e.includes('manufacturing')) {
                    sentiment = curr === 'USD' ? 'bearish' : 'neutral'; prob = 55;
                } else if (e.includes('speech') || e.includes('powell') || e.includes('lagarde')) {
                    sentiment = 'neutral'; prob = 60;
                }
                return { sentiment, prob };
            }

            window.calendarData = calEvents.map(e => ({...e, ...getGoldSentiment(e)}));

            let html = `
                <!-- OVERALL WEIGHTED SCORE BAR -->
                <div class="card" style="margin-bottom: 15px; padding: 12px 15px;">
                    <div style="display: flex; justify-content: space-between; align-items: center;">
                        <div>
                            <div style="font-size: 10px; color: var(--text-secondary); text-transform: uppercase; letter-spacing: 1px;">Overall News Impact</div>
                            <div style="display: flex; align-items: center; gap: 12px; margin-top: 6px;">
                                <span style="font-size: 32px; font-weight: 800; color: ${overallColor};">${overallScore > 0 ? '+' : ''}${overallScore}%</span>
                                <span style="font-size: 14px; font-weight: 600; color: ${overallColor};">${overallLabel}</span>
                            </div>
                            <div style="font-size: 9px; color: var(--grey-text); margin-top: 4px;">Activity: ${overallPct}% ‚Ä¢ Neutral drag: ${Math.round((1 - Math.max(0.2, neutralDilution)) * 100)}%</div>
                        </div>
                        <div style="display: flex; gap: 20px; align-items: center;">
                            <div style="text-align: center;">
                                <div style="font-size: 9px; color: var(--text-secondary);">BULLISH</div>
                                <div style="font-size: 20px; font-weight: 700; color: var(--success);">${bullScore.pct}%</div>
                                <div style="font-size: 9px; color: var(--grey-text);">${bullish} articles</div>
                            </div>
                            <div style="width: 1px; height: 40px; background: var(--grey-border);"></div>
                            <div style="text-align: center;">
                                <div style="font-size: 9px; color: var(--text-secondary);">BEARISH</div>
                                <div style="font-size: 20px; font-weight: 700; color: var(--danger);">${bearScore.pct}%</div>
                                <div style="font-size: 9px; color: var(--grey-text);">${bearish} articles</div>
                            </div>
                            <div style="width: 1px; height: 40px; background: var(--grey-border);"></div>
                            <div style="text-align: center;">
                                <div style="font-size: 9px; color: var(--text-secondary);">NEUTRAL</div>
                                <div style="font-size: 20px; font-weight: 700; color: var(--warning);">${neutScore.pct}%</div>
                                <div style="font-size: 9px; color: var(--grey-text);">${neutral} articles</div>
                            </div>
                        </div>
                        <div style="text-align: right;">
                            <div style="font-size: 9px; color: var(--text-secondary);">COT NET</div>
                            <div style="font-size: 18px; font-weight: 700; color: ${cotNet > 0 ? 'var(--success)' : cotNet < 0 ? 'var(--danger)' : 'var(--warning)'};">${cotNet > 0 ? '+' : ''}${cotNet}%</div>
                            <div style="font-size: 9px; color: var(--grey-text);">${cot.source || 'CFTC'} L:${cot.nonCommercial?.long || 0}% S:${cot.nonCommercial?.short || 0}%</div>
                        </div>
                    </div>
                </div>

                <!-- Gold News by Sentiment - 3 Columns with Impact % -->
                <div class="cards-grid" style="grid-template-columns: repeat(3, 1fr);">
                    <!-- BUY News -->
                    <div class="card" style="border-top: 3px solid var(--success);">
                        <div class="card-header" style="color: var(--success); display: flex; justify-content: space-between; align-items: center;">
                            <span>‚ñ≤ BULLISH <span style="font-size: 9px; opacity: 0.7;">(${bullish})</span></span>
                            <span style="font-size: 16px; font-weight: 800;">${bullScore.pct}%</span>
                        </div>
                        ${bullNews.length > 0 ?
                            bullNews.map((n, i) => {
                                const idx = news.findIndex(item => item === n);
                                const itemPct = Math.round(Math.abs(n.sentiment_score || 50) * 0.6 + (n.sentiment_confidence || 40) * 0.4);
                                return `
                                <div class="calendar-item news-item-clickable" onclick="showNewsModal(window.newsData[${idx}])" style="border-left: 2px solid var(--success);">
                                    <div class="calendar-impact ${n.impact || 'medium'}"></div>
                                    <div style="flex: 1;">
                                        <div style="font-size: 11px; color: var(--text-primary);">${n.title}</div>
                                        <div style="font-size: 9px; color: var(--text-secondary);">${n.source || 'News'} ‚Ä¢ ${n.time || ''}</div>
                                    </div>
                                    <span style="font-size: 11px; font-weight: 700; color: var(--success); min-width: 35px; text-align: right;">${itemPct}%</span>
                                </div>
                            `}).join('') : '<div style="padding: 15px; text-align: center; color: var(--text-secondary); font-size: 11px;">No bullish news</div>'}
                    </div>

                    <!-- SELL News -->
                    <div class="card" style="border-top: 3px solid var(--danger);">
                        <div class="card-header" style="color: var(--danger); display: flex; justify-content: space-between; align-items: center;">
                            <span>‚ñº BEARISH <span style="font-size: 9px; opacity: 0.7;">(${bearish})</span></span>
                            <span style="font-size: 16px; font-weight: 800;">${bearScore.pct}%</span>
                        </div>
                        ${bearNews.length > 0 ?
                            bearNews.map((n, i) => {
                                const idx = news.findIndex(item => item === n);
                                const itemPct = Math.round(Math.abs(n.sentiment_score || 50) * 0.6 + (n.sentiment_confidence || 40) * 0.4);
                                return `
                                <div class="calendar-item news-item-clickable" onclick="showNewsModal(window.newsData[${idx}])" style="border-left: 2px solid var(--danger);">
                                    <div class="calendar-impact ${n.impact || 'medium'}"></div>
                                    <div style="flex: 1;">
                                        <div style="font-size: 11px; color: var(--text-primary);">${n.title}</div>
                                        <div style="font-size: 9px; color: var(--text-secondary);">${n.source || 'News'} ‚Ä¢ ${n.time || ''}</div>
                                    </div>
                                    <span style="font-size: 11px; font-weight: 700; color: var(--danger); min-width: 35px; text-align: right;">${itemPct}%</span>
                                </div>
                            `}).join('') : '<div style="padding: 15px; text-align: center; color: var(--text-secondary); font-size: 11px;">No bearish news</div>'}
                    </div>

                    <!-- HOLD/Neutral News -->
                    <div class="card" style="border-top: 3px solid var(--warning);">
                        <div class="card-header" style="color: var(--warning); display: flex; justify-content: space-between; align-items: center;">
                            <span>‚óè HOLD <span style="font-size: 9px; opacity: 0.7;">(${neutral})</span></span>
                            <span style="font-size: 16px; font-weight: 800;">${neutScore.pct}%</span>
                        </div>
                        ${neutNews.length > 0 ?
                            neutNews.map((n, i) => {
                                const idx = news.findIndex(item => item === n);
                                const itemPct = Math.round(Math.abs(n.sentiment_score || 50) * 0.6 + (n.sentiment_confidence || 40) * 0.4);
                                return `
                                <div class="calendar-item news-item-clickable" onclick="showNewsModal(window.newsData[${idx}])" style="border-left: 2px solid var(--warning);">
                                    <div class="calendar-impact ${n.impact || 'medium'}"></div>
                                    <div style="flex: 1;">
                                        <div style="font-size: 11px; color: var(--text-primary);">${n.title}</div>
                                        <div style="font-size: 9px; color: var(--text-secondary);">${n.source || 'News'} ‚Ä¢ ${n.time || ''}</div>
                                    </div>
                                    <span style="font-size: 11px; font-weight: 700; color: var(--warning); min-width: 35px; text-align: right;">${itemPct}%</span>
                                </div>
                            `}).join('') : '<div style="padding: 15px; text-align: center; color: var(--text-secondary); font-size: 11px;">No neutral news</div>'}
                    </div>
                </div>

                <!-- Economic Calendar (Gold Impact) -->
                <div class="card" style="margin-top: 15px;">
                    <div class="card-header">Economic Calendar ‚Äî Gold Impact <span style="font-size: 10px; color: var(--text-secondary);">(${window.calendarData.length} events)</span></div>
                    ${window.calendarData.length > 0 ? window.calendarData.map((e, i) => `
                        <div class="calendar-item news-item-clickable" onclick="showCalendarModal(window.calendarData[${i}])" style="cursor: pointer;">
                            <span class="calendar-time">${e.time}</span>
                            <div class="calendar-impact ${e.impact}"></div>
                            <div style="flex: 1;">
                                <div style="font-size: 12px; color: var(--text-primary);">
                                    <span style="font-weight: 600; color: ${e.sentiment === 'bullish' ? 'var(--success)' : e.sentiment === 'bearish' ? 'var(--danger)' : 'var(--text-secondary)'};">${e.sentiment === 'bullish' ? '‚ñ≤' : e.sentiment === 'bearish' ? '‚ñº' : '‚óè'}</span>
                                    ${e.event} <span style="color: var(--esa-light);">(${e.currency})</span>
                                </div>
                                <div style="font-size: 10px; color: var(--text-secondary);">Forecast: ${e.forecast || 'N/A'} | Previous: ${e.previous || 'N/A'}</div>
                            </div>
                            <span class="badge ${e.sentiment === 'bullish' ? 'buy' : e.sentiment === 'bearish' ? 'sell' : ''}" style="min-width: 80px; text-align: center;">${e.sentiment === 'bullish' ? '‚ñ≤' : e.sentiment === 'bearish' ? '‚ñº' : '‚óè'} ${e.prob}%</span>
                        </div>
                    `).join('') : '<div style="padding: 15px; text-align: center; color: var(--text-secondary);">No upcoming events</div>'}
                </div>
            `;

            updateContent('newsContent', html);
        }

        function renderReport(data) {
            const a = analysis || analyze(data);
            const now = new Date();

            let html = `
                <div class="report-container">
                    <div class="report-header">
                        <div class="report-title">XAU/EUR Complete Analysis Report</div>
                        <button class="btn" onclick="window.print()">Print Report</button>
                    </div>

                    <div style="display: grid; grid-template-columns: repeat(5, 1fr); gap: 10px; margin-bottom: 20px;">
                        <div class="risk-item"><div class="risk-label">Signal</div><div class="risk-value" style="color: ${a.signal === 'BUY' ? 'var(--success)' : a.signal === 'SELL' ? 'var(--danger)' : 'var(--warning)'};">${a.signal}</div></div>
                        <div class="risk-item"><div class="risk-label">Confidence</div><div class="risk-value">${a.confidence.toFixed(0)}%</div></div>
                        <div class="risk-item"><div class="risk-label">Price</div><div class="risk-value">${data.bid.toFixed(2)}</div></div>
                        <div class="risk-item"><div class="risk-label">Target</div><div class="risk-value">${a.prognosis.target.toFixed(2)}</div></div>
                        <div class="risk-item"><div class="risk-label">Probability</div><div class="risk-value">${a.prognosis.probability.toFixed(0)}%</div></div>
                    </div>

                    <div class="report-section">
                        <h4>Executive Summary</h4>
                        <p class="report-text">
                            XAU/EUR is trading at <strong>${data.bid.toFixed(2)}</strong> with a <strong>${a.signal}</strong> signal
                            at ${a.confidence.toFixed(0)}% confidence. ${a.signals.length} technical indicators are aligned,
                            with ${a.buyVotes} buy votes vs ${a.sellVotes} sell votes. The 24-hour target is
                            ${a.prognosis.target.toFixed(2)} (${((a.prognosis.target - data.bid) / data.bid * 100).toFixed(2)}%)
                            with ${a.prognosis.probability.toFixed(0)}% probability.
                        </p>
                    </div>

                    <div class="report-section">
                        <h4>Technical Analysis</h4>
                        <p class="report-text">
                            <strong>Trend:</strong> ${a.indicators.sma20 > a.indicators.sma50 ? 'Bullish' : 'Bearish'} (SMA20 ${a.indicators.sma20 > a.indicators.sma50 ? '>' : '<'} SMA50)<br>
                            <strong>Momentum:</strong> RSI ${a.indicators.rsi.toFixed(1)} ${a.indicators.rsi < 30 ? '(Oversold)' : a.indicators.rsi > 70 ? '(Overbought)' : '(Neutral)'}, MACD ${a.indicators.macd.histogram > 0 ? 'Positive' : 'Negative'}<br>
                            <strong>Volatility:</strong> ATR ${a.indicators.atr.toFixed(2)}, Annualized ${a.volatility.toFixed(1)}%<br>
                            <strong>Trend Strength:</strong> ADX ${a.indicators.adx.toFixed(1)} ${a.indicators.adx > 25 ? '(Strong)' : '(Weak)'}
                        </p>
                    </div>

                    <div class="report-section">
                        <h4>Box Theory & Key Levels</h4>
                        <p class="report-text">
                            <strong>Box Status:</strong> ${a.box?.status.replace('-', ' ').toUpperCase()}<br>
                            <strong>Box Range:</strong> ${a.box?.boxLow.toFixed(2)} - ${a.box?.boxHigh.toFixed(2)} (${a.box?.range.toFixed(2)} pts)<br>
                            <strong>Pivot Point:</strong> ${a.pivots.pivot.toFixed(2)}<br>
                            <strong>Support:</strong> S1 ${a.pivots.s1.toFixed(2)}, S2 ${a.pivots.s2.toFixed(2)}<br>
                            <strong>Resistance:</strong> R1 ${a.pivots.r1.toFixed(2)}, R2 ${a.pivots.r2.toFixed(2)}
                        </p>
                    </div>

                    <div class="report-section">
                        <h4>Risk Metrics</h4>
                        <p class="report-text">
                            <strong>Sharpe Ratio:</strong> ${a.sharpe.toFixed(2)} ${a.sharpe > 1 ? '(Good)' : '(Below average)'}<br>
                            <strong>Max Drawdown:</strong> ${a.maxDD.toFixed(1)}%<br>
                            <strong>VaR (95%):</strong> ${a.var95.toFixed(2)}% daily<br>
                            <strong>Risk Assessment:</strong> ${a.confidence >= 75 ? 'LOW RISK - Proceed with standard size' : a.confidence >= 60 ? 'MEDIUM RISK - Reduce position size' : 'HIGH RISK - Wait for better setup'}
                        </p>
                    </div>

                    <div class="report-section">
                        <h4>Trade Recommendation</h4>
                        <p class="report-text">
                            <strong>Direction:</strong> ${a.signal}<br>
                            <strong>Entry:</strong> ${data.bid.toFixed(2)}<br>
                            <strong>Stop Loss:</strong> ${(data.bid - a.indicators.atr * 1.5).toFixed(2)} (${(a.indicators.atr * 1.5).toFixed(2)} pts)<br>
                            <strong>Take Profit:</strong> ${a.prognosis.target.toFixed(2)}<br>
                            <strong>Risk:Reward:</strong> 1:${(Math.abs(a.prognosis.target - data.bid) / (a.indicators.atr * 1.5)).toFixed(1)}
                        </p>
                    </div>

                    <div style="font-size: 10px; color: var(--grey-text); text-align: center; margin-top: 20px; padding-top: 15px; border-top: 1px solid var(--grey-border);">
                        Generated: ${now.toLocaleString('nl-NL')} | BerelzDashboard Pro v3.0 | For educational purposes only
                    </div>
                </div>
            `;

            updateContent('reportContent', html);
        }

        function renderBoxTheory(data) {
            const a = analysis || analyze(data);
            const bars = data.bars || [];
            const current = bars.length > 0 ? bars[bars.length - 1].c : 0;

            // EA Settings (matching FKE4.10 inputs)
            const EA_SETTINGS = {
                edgeZonePct: 20.0,        // Edge zone %
                cheaterBoxBars: 12,       // Cheater box bars
                rsiPeriod: 6,             // RSI period
                rsiOverbought: 62,        // RSI overbought
                rsiOversold: 38,          // RSI oversold
                slBufferPips: 15.0,       // SL buffer
                riskReward: 2.4           // R:R ratio
            };

            // Calculate boxes
            const mainBox = TA.boxTheory(bars, 20);
            const cheaterBox = TA.boxTheory(bars, EA_SETTINGS.cheaterBoxBars);
            const boxes = [
                { name: 'Main Box (20)', data: mainBox },
                { name: 'Cheater Box (12)', data: cheaterBox },
                { name: 'Session Box (50)', data: TA.boxTheory(bars, 50) }
            ];

            // Calculate RSI for momentum
            const closes = bars.map(b => b.c);
            const rsi = TA.rsi(closes, EA_SETTINGS.rsiPeriod);

            // Determine trade mode: BREAKOUT vs MEAN REVERSION
            function getTradeMode(box, rsi) {
                if (!box) return { mode: 'WAIT', signal: 'HOLD', reason: 'No box data' };

                const position = box.position; // 0-100, 0=at low, 100=at high
                const edgeLow = EA_SETTINGS.edgeZonePct;
                const edgeHigh = 100 - EA_SETTINGS.edgeZonePct;

                // Check for breakout
                if (box.status === 'breakout-up') {
                    return {
                        mode: 'BREAKOUT',
                        signal: 'BUY',
                        reason: 'Price broke above box high',
                        entry: box.boxHigh,
                        sl: box.boxHigh - (EA_SETTINGS.slBufferPips * 0.1),
                        tp: box.boxHigh + (box.range * EA_SETTINGS.riskReward)
                    };
                }
                if (box.status === 'breakout-down') {
                    return {
                        mode: 'BREAKOUT',
                        signal: 'SELL',
                        reason: 'Price broke below box low',
                        entry: box.boxLow,
                        sl: box.boxLow + (EA_SETTINGS.slBufferPips * 0.1),
                        tp: box.boxLow - (box.range * EA_SETTINGS.riskReward)
                    };
                }

                // Inside box - check for mean reversion at edges
                if (position <= edgeLow) {
                    // At lower edge - potential BUY (mean reversion)
                    if (rsi < EA_SETTINGS.rsiOversold) {
                        return {
                            mode: 'MEAN REVERT',
                            signal: 'BUY',
                            reason: `At lower edge (${position.toFixed(0)}%) + RSI oversold (${rsi.toFixed(0)})`,
                            entry: current,
                            sl: box.boxLow - (EA_SETTINGS.slBufferPips * 0.1),
                            tp: box.boxHigh - (box.range * 0.1) // Target near top
                        };
                    }
                    return { mode: 'MEAN REVERT', signal: 'WAIT', reason: `At lower edge but RSI not oversold (${rsi.toFixed(0)})` };
                }

                if (position >= edgeHigh) {
                    // At upper edge - potential SELL (mean reversion)
                    if (rsi > EA_SETTINGS.rsiOverbought) {
                        return {
                            mode: 'MEAN REVERT',
                            signal: 'SELL',
                            reason: `At upper edge (${position.toFixed(0)}%) + RSI overbought (${rsi.toFixed(0)})`,
                            entry: current,
                            sl: box.boxHigh + (EA_SETTINGS.slBufferPips * 0.1),
                            tp: box.boxLow + (box.range * 0.1) // Target near bottom
                        };
                    }
                    return { mode: 'MEAN REVERT', signal: 'WAIT', reason: `At upper edge but RSI not overbought (${rsi.toFixed(0)})` };
                }

                // In middle zone - no trade
                return { mode: 'INSIDE', signal: 'HOLD', reason: `Price in middle zone (${position.toFixed(0)}%), wait for edge or breakout` };
            }

            const mainTrade = getTradeMode(mainBox, rsi);
            const cheaterTrade = getTradeMode(cheaterBox, rsi);

            // Confluence check
            const confluence = mainTrade.signal === cheaterTrade.signal && mainTrade.signal !== 'HOLD' && mainTrade.signal !== 'WAIT';

            let html = `
                <!-- TRADE MODE SIGNAL -->
                <div class="card" style="margin-bottom: 15px; border: 2px solid ${mainTrade.signal === 'BUY' ? 'var(--success)' : mainTrade.signal === 'SELL' ? 'var(--danger)' : 'var(--grey-border)'};">
                    <div class="card-header" style="display: flex; justify-content: space-between; align-items: center;">
                        <span>Box Theory Signal</span>
                        <span class="badge ${mainTrade.mode === 'BREAKOUT' ? 'buy' : mainTrade.mode === 'MEAN REVERT' ? 'sell' : ''}">${mainTrade.mode}</span>
                    </div>
                    <div style="display: grid; grid-template-columns: repeat(4, 1fr); gap: 10px; padding: 15px; text-align: center;">
                        <div>
                            <div style="font-size: 10px; color: var(--text-secondary);">Signal</div>
                            <div style="font-size: 24px; font-weight: bold; color: ${mainTrade.signal === 'BUY' ? 'var(--success)' : mainTrade.signal === 'SELL' ? 'var(--danger)' : 'var(--warning)'};">
                                ${mainTrade.signal === 'BUY' ? '‚ñ≤' : mainTrade.signal === 'SELL' ? '‚ñº' : '‚óè'} ${mainTrade.signal}
                            </div>
                        </div>
                        <div>
                            <div style="font-size: 10px; color: var(--text-secondary);">Mode</div>
                            <div style="font-size: 16px; font-weight: bold; color: ${mainTrade.mode === 'BREAKOUT' ? 'var(--cyan)' : 'var(--warning)'};">${mainTrade.mode}</div>
                        </div>
                        <div>
                            <div style="font-size: 10px; color: var(--text-secondary);">RSI (${EA_SETTINGS.rsiPeriod})</div>
                            <div style="font-size: 16px; font-weight: bold; color: ${rsi < EA_SETTINGS.rsiOversold ? 'var(--success)' : rsi > EA_SETTINGS.rsiOverbought ? 'var(--danger)' : 'var(--text-primary)'};">${rsi.toFixed(1)}</div>
                        </div>
                        <div>
                            <div style="font-size: 10px; color: var(--text-secondary);">Confluence</div>
                            <div style="font-size: 16px; font-weight: bold; color: ${confluence ? 'var(--success)' : 'var(--text-secondary)'};">${confluence ? '‚úì YES' : '‚úó NO'}</div>
                        </div>
                    </div>
                    <div style="padding: 10px 15px; background: var(--grey-dark); border-radius: 0 0 4px 4px;">
                        <div style="font-size: 12px; color: var(--text-secondary);">${mainTrade.reason}</div>
                        ${mainTrade.entry ? `
                            <div style="display: grid; grid-template-columns: repeat(3, 1fr); gap: 10px; margin-top: 10px; font-size: 11px;">
                                <div><span style="color: var(--text-secondary);">Entry:</span> <strong>${mainTrade.entry.toFixed(2)}</strong></div>
                                <div><span style="color: var(--text-secondary);">SL:</span> <strong style="color: var(--danger);">${mainTrade.sl.toFixed(2)}</strong></div>
                                <div><span style="color: var(--text-secondary);">TP:</span> <strong style="color: var(--success);">${mainTrade.tp.toFixed(2)}</strong></div>
                            </div>
                        ` : ''}
                    </div>
                </div>

                <!-- BOX CARDS -->
                <div class="cards-grid">
                    ${boxes.map(b => {
                        const pos = b.data?.position || 0;
                        const inEdgeLow = pos <= EA_SETTINGS.edgeZonePct;
                        const inEdgeHigh = pos >= (100 - EA_SETTINGS.edgeZonePct);
                        const edgeStatus = inEdgeLow ? 'LOWER EDGE' : inEdgeHigh ? 'UPPER EDGE' : 'MIDDLE';
                        return `
                        <div class="card">
                            <div class="card-header">${b.name}</div>
                            <div class="data-row"><span class="data-label">High</span><span class="data-value">${b.data?.boxHigh.toFixed(2) || 'N/A'}</span></div>
                            <div class="data-row"><span class="data-label">Low</span><span class="data-value">${b.data?.boxLow.toFixed(2) || 'N/A'}</span></div>
                            <div class="data-row"><span class="data-label">Range</span><span class="data-value">${b.data?.range.toFixed(2) || 'N/A'}</span></div>
                            <div class="data-row"><span class="data-label">Position</span><span class="data-value ${inEdgeLow ? 'positive' : inEdgeHigh ? 'negative' : ''}">${pos.toFixed(1)}%</span></div>
                            <div class="data-row"><span class="data-label">Zone</span><span class="badge ${inEdgeLow ? 'buy' : inEdgeHigh ? 'sell' : 'neutral'}">${edgeStatus}</span></div>
                            <div class="data-row"><span class="data-label">Status</span><span class="badge ${b.data?.status === 'breakout-up' ? 'buy' : b.data?.status === 'breakout-down' ? 'sell' : 'neutral'}">${b.data?.status?.toUpperCase() || 'INSIDE'}</span></div>
                        </div>
                    `}).join('')}
                </div>

                <!-- EA SETTINGS REFERENCE -->
                <div class="card" style="margin-top: 15px;">
                    <div class="card-header">FKE Box Theory Settings (Active)</div>
                    <div style="display: grid; grid-template-columns: repeat(2, 1fr); gap: 5px; font-size: 11px;">
                        <div class="data-row"><span class="data-label">Edge Zone</span><span class="data-value">${EA_SETTINGS.edgeZonePct}%</span></div>
                        <div class="data-row"><span class="data-label">Cheater Box</span><span class="data-value">${EA_SETTINGS.cheaterBoxBars} bars</span></div>
                        <div class="data-row"><span class="data-label">RSI Period</span><span class="data-value">${EA_SETTINGS.rsiPeriod}</span></div>
                        <div class="data-row"><span class="data-label">RSI Overbought</span><span class="data-value">${EA_SETTINGS.rsiOverbought}</span></div>
                        <div class="data-row"><span class="data-label">RSI Oversold</span><span class="data-value">${EA_SETTINGS.rsiOversold}</span></div>
                        <div class="data-row"><span class="data-label">Risk:Reward</span><span class="data-value">1:${EA_SETTINGS.riskReward}</span></div>
                    </div>
                </div>

                <!-- TRADING RULES -->
                <div class="card" style="margin-top: 15px;">
                    <div class="card-header">Box Theory Trading Rules</div>
                    <div style="font-size: 11px; line-height: 1.8; color: var(--text-secondary);">
                        <strong style="color: var(--cyan);">BREAKOUT MODE:</strong><br>
                        ‚Ä¢ BUY when price breaks ABOVE box high<br>
                        ‚Ä¢ SELL when price breaks BELOW box low<br>
                        ‚Ä¢ SL = Inside box + buffer (${EA_SETTINGS.slBufferPips} pips)<br><br>
                        <strong style="color: var(--warning);">MEAN REVERSION MODE:</strong><br>
                        ‚Ä¢ BUY at lower edge (‚â§${EA_SETTINGS.edgeZonePct}%) + RSI ‚â§ ${EA_SETTINGS.rsiOversold}<br>
                        ‚Ä¢ SELL at upper edge (‚â•${100-EA_SETTINGS.edgeZonePct}%) + RSI ‚â• ${EA_SETTINGS.rsiOverbought}<br>
                        ‚Ä¢ Target = Opposite edge of box
                    </div>
                </div>
            `;

            updateContent('boxContent', html);
        }

        // Request notification permission for alerts
        if ('Notification' in window && Notification.permission === 'default') {
            Notification.requestPermission();
        }

        // Start fetching data immediately and refresh every 5 seconds
        loadData();
        setInterval(loadData, 5000);  // 5 seconds = real-time

        // News Modal Functions
        function showNewsModal(newsItem) {
            const modal = document.getElementById('newsModal');
            document.getElementById('newsModalTitle').textContent = newsItem.title;
            document.getElementById('newsModalSource').textContent = newsItem.source;
            document.getElementById('newsModalTime').textContent = newsItem.time + ' ago';
            document.getElementById('newsModalImpact').textContent = 'Impact: ' + newsItem.impact.toUpperCase();
            document.getElementById('newsModalImpact').className = 'badge ' + (newsItem.impact === 'high' ? 'sell' : newsItem.impact === 'medium' ? '' : 'buy');
            document.getElementById('newsModalSentiment').textContent = newsItem.sentiment.toUpperCase();
            document.getElementById('newsModalSentiment').className = 'badge ' + (newsItem.sentiment === 'bullish' ? 'buy' : 'sell');
            document.getElementById('newsModalBody').innerHTML = newsItem.fullText || newsItem.title;
            modal.classList.add('active');
        }

        function showCalendarModal(calEvent) {
            const modal = document.getElementById('newsModal');
            document.getElementById('newsModalTitle').textContent = calEvent.event;
            document.getElementById('newsModalSource').textContent = calEvent.currency + ' Economic Event';
            document.getElementById('newsModalTime').textContent = calEvent.time;
            document.getElementById('newsModalImpact').textContent = 'Impact: ' + calEvent.impact.toUpperCase();
            document.getElementById('newsModalImpact').className = 'badge ' + (calEvent.impact === 'high' ? 'sell' : calEvent.impact === 'medium' ? '' : 'buy');
            const sentLabel = calEvent.sentiment === 'bullish' ? '‚ñ≤ BULLISH' : calEvent.sentiment === 'bearish' ? '‚ñº BEARISH' : '‚óè NEUTRAL';
            document.getElementById('newsModalSentiment').textContent = sentLabel + ' ' + (calEvent.prob || 50) + '%';
            document.getElementById('newsModalSentiment').className = 'badge ' + (calEvent.sentiment === 'bullish' ? 'buy' : calEvent.sentiment === 'bearish' ? 'sell' : '');
            document.getElementById('newsModalBody').innerHTML = `
                <div style="text-align: center; padding: 15px; margin-bottom: 15px; background: ${calEvent.sentiment === 'bullish' ? 'rgba(0,200,83,0.1)' : calEvent.sentiment === 'bearish' ? 'rgba(255,61,0,0.1)' : 'rgba(128,128,128,0.1)'}; border-radius: 8px;">
                    <div style="font-size: 32px; font-weight: bold; color: ${calEvent.sentiment === 'bullish' ? 'var(--success)' : calEvent.sentiment === 'bearish' ? 'var(--danger)' : 'var(--text-secondary)'};">
                        ${calEvent.sentiment === 'bullish' ? '‚ñ≤' : calEvent.sentiment === 'bearish' ? '‚ñº' : '‚óè'} ${calEvent.prob || 50}%
                    </div>
                    <div style="font-size: 14px; color: ${calEvent.sentiment === 'bullish' ? 'var(--success)' : calEvent.sentiment === 'bearish' ? 'var(--danger)' : 'var(--text-secondary)'};">
                        ${calEvent.sentiment === 'bullish' ? 'BULLISH for Gold - Consider BUY' : calEvent.sentiment === 'bearish' ? 'BEARISH for Gold - Consider SELL' : 'NEUTRAL - Wait for data'}
                    </div>
                </div>
                <p><strong>Event:</strong> ${calEvent.event}</p>
                <p><strong>Currency:</strong> ${calEvent.currency}</p>
                <p><strong>Time:</strong> ${calEvent.time}</p>
                <p><strong>Forecast:</strong> ${calEvent.forecast}</p>
                <p><strong>Previous:</strong> ${calEvent.previous || 'N/A'}</p>
                <hr style="border-color: var(--grey-border); margin: 15px 0;">
                <p><strong>Why ${calEvent.sentiment === 'bullish' ? 'Bullish' : calEvent.sentiment === 'bearish' ? 'Bearish' : 'Neutral'}?</strong></p>
                <p style="color: var(--text-secondary);">
                    ${calEvent.currency === 'USD' && calEvent.sentiment === 'bearish' ? 'Strong USD data typically pushes gold prices DOWN (inverse correlation).' : ''}
                    ${calEvent.currency === 'USD' && calEvent.sentiment === 'bullish' ? 'Weak USD data typically pushes gold prices UP (inverse correlation).' : ''}
                    ${calEvent.currency === 'EUR' ? 'EUR events affect the XAU/EUR exchange rate directly.' : ''}
                    ${calEvent.event.toLowerCase().includes('cpi') || calEvent.event.toLowerCase().includes('inflation') ? 'Higher inflation = Gold is a hedge = BULLISH for gold.' : ''}
                    ${calEvent.event.toLowerCase().includes('rate') ? 'Interest rate decisions directly impact gold as a non-yielding asset.' : ''}
                </p>
                <p style="color: var(--text-secondary);">
                    ${calEvent.impact === 'high' ? 'HIGH IMPACT: Expect significant volatility. Consider reducing position size or closing trades before this release.' :
                      calEvent.impact === 'medium' ? 'MEDIUM IMPACT: Moderate price movement possible. Watch for unexpected results.' :
                      'LOW IMPACT: Minimal effect expected on gold prices.'}
                </p>
                ${calEvent.currency === 'USD' ? '<p style="color: var(--warning); margin-top: 10px;">‚ö†Ô∏è USD events directly impact gold prices (inverse correlation)</p>' : ''}
                ${calEvent.currency === 'EUR' ? '<p style="color: var(--esa-accent); margin-top: 10px;">üìä EUR events affect XAU/EUR exchange rate</p>' : ''}
            `;
            modal.classList.add('active');
        }

        function closeNewsModal() {
            document.getElementById('newsModal').classList.remove('active');
        }

        // Close modal on backdrop click
        document.addEventListener('click', function(e) {
            if (e.target.classList.contains('news-modal')) {
                closeNewsModal();
            }
        });

        // Close modal on Escape key
        document.addEventListener('keydown', function(e) {
            if (e.key === 'Escape') {
                closeNewsModal();
            }
        });
    </script>

    <!-- News Modal -->
    <div id="newsModal" class="news-modal" onclick="if(event.target===this)closeNewsModal()">
        <div class="news-modal-content">
            <div class="news-modal-header">
                <div class="news-modal-title" id="newsModalTitle"></div>
                <button class="news-modal-close" onclick="closeNewsModal()">‚úï</button>
            </div>
            <div class="news-modal-meta">
                <span id="newsModalSource"></span>
                <span id="newsModalTime"></span>
                <span id="newsModalImpact" class="badge"></span>
                <span id="newsModalSentiment" class="badge"></span>
            </div>
            <div class="news-modal-body" id="newsModalBody"></div>
        </div>
    </div>
</body>
</html>
